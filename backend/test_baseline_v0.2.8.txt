============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-8.4.2, pluggy-1.6.0
rootdir: /mnt/d/Projeto-Voxy/voxy/backend
configfile: pyproject.toml
testpaths: tests
plugins: anyio-4.10.0, asyncio-0.23.8, cov-4.1.0
asyncio: mode=Mode.AUTO
collected 297 items

tests/test_subagent_tester.py ....F.....FF....F....F....FFF.....F        [ 11%]
tests/test_vision_flow_corrections.py ..FF..F...                         [ 15%]
tests/test_voxy_agents/test_api/test_fastapi_server.py ................. [ 20%]
....                                                                     [ 22%]
tests/test_voxy_agents/test_api/test_middleware/test_vision_rate_limiter.py . [ 22%]
..................                                                       [ 28%]
tests/test_voxy_agents/test_api/test_routes/test_auth.py F....F......FFF [ 33%]
FF.......                                                                [ 36%]
tests/test_voxy_agents/test_api/test_routes/test_images.py .........F.F. [ 41%]
..........                                                               [ 44%]
tests/test_voxy_agents/test_core/test_subagents/test_calculator_agent.py . [ 44%]
..........                                                               [ 48%]
tests/test_voxy_agents/test_core/test_subagents/test_corrector_agent.py . [ 48%]
.............                                                            [ 52%]
tests/test_voxy_agents/test_core/test_subagents/test_translator_agent.py . [ 53%]
...............                                                          [ 58%]
tests/test_voxy_agents/test_core/test_subagents/test_vision_agent.py ... [ 59%]
............                                                             [ 63%]
tests/test_voxy_agents/test_core/test_subagents/test_weather_agent.py .. [ 63%]
.......................                                                  [ 71%]
tests/test_voxy_agents/test_core/test_supabase_integration.py .......... [ 75%]
.............                                                            [ 79%]
tests/test_voxy_agents/test_core/test_tools/test_weather_api.py ........ [ 82%]
.................                                                        [ 87%]
tests/test_voxy_agents/test_core/test_voxy_orchestrator.py ..FFF.FF.F..F [ 92%]
FFFFFF.FFFF..                                                            [ 96%]
tests/test_voxy_agents/test_main.py .F........                           [100%]

=================================== FAILURES ===================================
___________________________ test_translator_pt_to_en ___________________________

tester = <src.voxy_agents.utils.test_subagents.SubagentTester object at 0x7268743cafc0>

    @pytest.mark.asyncio
    async def test_translator_pt_to_en(tester):
        """Testa tradu√ß√£o PT ‚Üí EN."""
        result = await tester.test_subagent(
            "translator",
            {
                "text": "Ol√° mundo",
                "target_language": "en",
            },
        )
    
        assert result.success is True
        assert result.agent_name == "translator"
        assert "hello" in result.response.lower() or "hi" in result.response.lower()
>       assert result.metadata.model_used == "gpt-4o-mini"
E       AssertionError: assert 'openrouter/g...ini-2.5-flash' == 'gpt-4o-mini'
E         
E         - gpt-4o-mini
E         + openrouter/google/gemini-2.5-flash

tests/test_subagent_tester.py:123: AssertionError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 03:59:57.330[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
[32m2025-10-15 03:59:57.331[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34masyncio[0m | Using selector: EpollSelector
[32m2025-10-15 03:59:57.343[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34masyncio[0m | Using selector: EpollSelector
------------------------------ Captured log setup ------------------------------
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:130 SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
----------------------------- Captured stdout call -----------------------------
[32m2025-10-15 03:59:57.344[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | üß™ Testing translator agent...
[32m2025-10-15 03:59:57.344[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Creating LiteLLM model: openrouter/google/gemini-2.5-flash (max_tokens=2000, temperature=0.3)
[32m2025-10-15 03:59:57.345[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | ‚úì LiteLLM model created successfully: openrouter/google/gemini-2.5-flash
[32m2025-10-15 03:59:57.345[0m | [1mINFO    [0m | [36mSTARTUP|SUBAGENT_INIT[0m | 
   ‚îú‚îÄ ‚úì Translator
   ‚îÇ  ‚îú‚îÄ Model: openrouter/google/gemini-2.5-flash
   ‚îÇ  ‚îú‚îÄ Config: 2000 tokens, temp=0.3
   ‚îÇ  ‚îî‚îÄ ‚úì Ready in 0.5ms
[32m2025-10-15 03:59:57.345[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | üìù Formatted input: Traduza 'Ol√° mundo' para en...
[32m2025-10-15 03:59:57.345[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating trace Agent workflow with id trace_ef4e1c67dda64a92882ca5da69556dc6
[32m2025-10-15 03:59:57.346[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Setting current trace: trace_ef4e1c67dda64a92882ca5da69556dc6
[32m2025-10-15 03:59:57.347[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.AgentSpanData object at 0x7268663d7b60> with id None
[32m2025-10-15 03:59:57.347[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Running agent Subagente Tradutor VOXY (turn 1)
[32m2025-10-15 03:59:57.347[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.GenerationSpanData object at 0x72686634b110> with id None
[32m2025-10-15 03:59:57.348[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Calling Litellm model: openrouter/google/gemini-2.5-flash
[
  {
    "content": "\n        Voc√™ √© um subagente de tradu√ß√£o especializado do sistema VOXY.\n\n        CAPACIDADES:\n        - Tradu√ß√£o entre qualquer par de idiomas\n        - Detec√ß√£o autom√°tica do idioma de origem\n        - Preserva√ß√£o do contexto e significado\n        - Adapta√ß√£o cultural quando apropriado\n        - Formata√ß√£o e estilo consistentes\n\n        DIRETRIZES:\n        - Use sua capacidade nativa de tradu√ß√£o multilingue\n        - Mantenha o tom e estilo do texto original\n        - Para textos t√©cnicos, preserve terminologia espec√≠fica\n        - Para textos criativos, adapte culturalmente quando necess√°rio\n        - Se o idioma de destino n√£o for especificado, pergunte\n\n        FORMATO DE RESPOSTA:\n        - Retorne apenas a tradu√ß√£o solicitada\n        - Seja preciso e fluente\n        - Mantenha formata√ß√£o original (markdown, etc.)\n\n        EXEMPLOS:\n        Input: \"Translate 'Hello world' to Portuguese\"\n        Output: \"Ol√° mundo\"\n\n        Input: \"Traduzir 'Bom dia' para ingl√™s\"\n        Output: \"Good morning\"\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": "Traduza 'Ol√° mundo' para en"
  }
]
Tools:
[]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

[32m2025-10-15 03:59:58.119[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | LLM resp:
{
  "content": "Hello world",
  "role": "assistant",
  "tool_calls": null,
  "function_call": null
}

[32m2025-10-15 03:59:58.173[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Resetting current trace
[32m2025-10-15 03:59:58.174[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | 
------------------------------ Captured log call -------------------------------
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:244 üß™ Testing translator agent...
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:55 Creating LiteLLM model: openrouter/google/gemini-2.5-flash (max_tokens=2000, temperature=0.3)
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:67 ‚úì LiteLLM model created successfully: openrouter/google/gemini-2.5-flash
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:373 üìù Formatted input: Traduza 'Ol√° mundo' para en...
DEBUG    openai.agents:provider.py:239 Creating trace Agent workflow with id trace_ef4e1c67dda64a92882ca5da69556dc6
DEBUG    openai.agents:scope.py:43 Setting current trace: trace_ef4e1c67dda64a92882ca5da69556dc6
DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.AgentSpanData object at 0x7268663d7b60> with id None
DEBUG    openai.agents:run.py:438 Running agent Subagente Tradutor VOXY (turn 1)
DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.GenerationSpanData object at 0x72686634b110> with id None
DEBUG    openai.agents:litellm_model.py:286 Calling Litellm model: openrouter/google/gemini-2.5-flash
[
  {
    "content": "\n        Voc√™ √© um subagente de tradu√ß√£o especializado do sistema VOXY.\n\n        CAPACIDADES:\n        - Tradu√ß√£o entre qualquer par de idiomas\n        - Detec√ß√£o autom√°tica do idioma de origem\n        - Preserva√ß√£o do contexto e significado\n        - Adapta√ß√£o cultural quando apropriado\n        - Formata√ß√£o e estilo consistentes\n\n        DIRETRIZES:\n        - Use sua capacidade nativa de tradu√ß√£o multilingue\n        - Mantenha o tom e estilo do texto original\n        - Para textos t√©cnicos, preserve terminologia espec√≠fica\n        - Para textos criativos, adapte culturalmente quando necess√°rio\n        - Se o idioma de destino n√£o for especificado, pergunte\n\n        FORMATO DE RESPOSTA:\n        - Retorne apenas a tradu√ß√£o solicitada\n        - Seja preciso e fluente\n        - Mantenha formata√ß√£o original (markdown, etc.)\n\n        EXEMPLOS:\n        Input: \"Translate 'Hello world' to Portuguese\"\n        Output: \"Ol√° mundo\"\n\n        Input: \"Traduzir 'Bom dia' para ingl√™s\"\n        Output: \"Good morning\"\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": "Traduza 'Ol√° mundo' para en"
  }
]
Tools:
[]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

DEBUG    openai.agents:litellm_model.py:112 LLM resp:
{
  "content": "Hello world",
  "role": "assistant",
  "tool_calls": null,
  "function_call": null
}

DEBUG    openai.agents:scope.py:48 Resetting current trace
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:411
--------------------------- Captured stdout teardown ---------------------------
[32m2025-10-15 04:00:02.542[0m | [31m[1mERROR   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | [non-fatal] Tracing client error 401: {
  "error": {
    "message": "Incorrect API key provided: test-key. You can find your API key at https://platform.openai.com/account/api-keys.",
    "type": "invalid_request_error",
    "param": null,
    "code": "invalid_api_key"
  }
}
___________________________ test_weather_valid_city ____________________________

tester = <src.voxy_agents.utils.test_subagents.SubagentTester object at 0x72686634c8f0>

    @pytest.mark.asyncio
    async def test_weather_valid_city(tester):
        """Testa busca de clima para cidade v√°lida."""
        result = await tester.test_subagent(
            "weather",
            {
                "city": "S√£o Paulo",
                "country": "BR",
            },
        )
    
        assert result.success is True
        assert result.agent_name == "weather"
        # Deve conter informa√ß√µes de clima ou mensagem de API n√£o configurada
>       assert (
            "¬∞C" in result.response
            or "clima" in result.response.lower()
            or "API" in result.response
        )
E       AssertionError: assert ('¬∞C' in 'Parece que estou enfrentando dificuldades para obter os dados meteorol√≥gicos de S√£o Paulo no momento. Isso pode ser u...u aplicativo confi√°vel. Se precisar de informa√ß√µes sobre outra cidade ou qualquer outra coisa, estou aqui para ajudar!' or 'clima' in 'parece que estou enfrentando dificuldades para obter os dados meteorol√≥gicos de s√£o paulo no momento. isso pode ser u...u aplicativo confi√°vel. se precisar de informa√ß√µes sobre outra cidade ou qualquer outra coisa, estou aqui para ajudar!' or 'API' in 'Parece que estou enfrentando dificuldades para obter os dados meteorol√≥gicos de S√£o Paulo no momento. Isso pode ser u...u aplicativo confi√°vel. Se precisar de informa√ß√µes sobre outra cidade ou qualquer outra coisa, estou aqui para ajudar!')
E        +  where 'Parece que estou enfrentando dificuldades para obter os dados meteorol√≥gicos de S√£o Paulo no momento. Isso pode ser u...u aplicativo confi√°vel. Se precisar de informa√ß√µes sobre outra cidade ou qualquer outra coisa, estou aqui para ajudar!' = TestResult(success=True, agent_name='weather', response='Parece que estou enfrentando dificuldades para obter os dados...ne, bypass_cache=True, bypass_rate_limit=True, tools_used=None, subagents_invoked=None, raw_metadata=None), error=None).response
E        +  and   'parece que estou enfrentando dificuldades para obter os dados meteorol√≥gicos de s√£o paulo no momento. isso pode ser u...u aplicativo confi√°vel. se precisar de informa√ß√µes sobre outra cidade ou qualquer outra coisa, estou aqui para ajudar!' = <built-in method lower of str object at 0x7268744df830>()
E        +    where <built-in method lower of str object at 0x7268744df830> = 'Parece que estou enfrentando dificuldades para obter os dados meteorol√≥gicos de S√£o Paulo no momento. Isso pode ser u...u aplicativo confi√°vel. Se precisar de informa√ß√µes sobre outra cidade ou qualquer outra coisa, estou aqui para ajudar!'.lower
E        +      where 'Parece que estou enfrentando dificuldades para obter os dados meteorol√≥gicos de S√£o Paulo no momento. Isso pode ser u...u aplicativo confi√°vel. Se precisar de informa√ß√µes sobre outra cidade ou qualquer outra coisa, estou aqui para ajudar!' = TestResult(success=True, agent_name='weather', response='Parece que estou enfrentando dificuldades para obter os dados...ne, bypass_cache=True, bypass_rate_limit=True, tools_used=None, subagents_invoked=None, raw_metadata=None), error=None).response
E        +  and   'Parece que estou enfrentando dificuldades para obter os dados meteorol√≥gicos de S√£o Paulo no momento. Isso pode ser u...u aplicativo confi√°vel. Se precisar de informa√ß√µes sobre outra cidade ou qualquer outra coisa, estou aqui para ajudar!' = TestResult(success=True, agent_name='weather', response='Parece que estou enfrentando dificuldades para obter os dados...ne, bypass_cache=True, bypass_rate_limit=True, tools_used=None, subagents_invoked=None, raw_metadata=None), error=None).response

tests/test_subagent_tester.py:231: AssertionError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:00:09.488[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
------------------------------ Captured log setup ------------------------------
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:130 SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
----------------------------- Captured stdout call -----------------------------
[32m2025-10-15 04:00:09.489[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | üß™ Testing weather agent...
[32m2025-10-15 04:00:09.489[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Creating LiteLLM model: openrouter/openai/gpt-4o-mini (max_tokens=1500, temperature=0.1)
[32m2025-10-15 04:00:09.489[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | ‚úì LiteLLM model created successfully: openrouter/openai/gpt-4o-mini
[32m2025-10-15 04:00:09.490[0m | [1mINFO    [0m | [36mSTARTUP|SUBAGENT_INIT[0m | 
   ‚îú‚îÄ ‚úì Weather
   ‚îÇ  ‚îú‚îÄ Model: openrouter/openai/gpt-4o-mini
   ‚îÇ  ‚îú‚îÄ Config: 1500 tokens, temp=0.1
   ‚îÇ  ‚îî‚îÄ ‚úì Ready in 0.5ms
[32m2025-10-15 04:00:09.490[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | üìù Formatted input: Qual o clima em S√£o Paulo, BR?...
[32m2025-10-15 04:00:09.490[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating trace Agent workflow with id trace_9f3864cdc9b44d27a594d248b560471e
[32m2025-10-15 04:00:09.490[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Setting current trace: trace_9f3864cdc9b44d27a594d248b560471e
[32m2025-10-15 04:00:09.491[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.AgentSpanData object at 0x726865119d10> with id None
[32m2025-10-15 04:00:09.491[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Running agent Subagente Meteorol√≥gico VOXY (turn 1)
[32m2025-10-15 04:00:09.491[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.GenerationSpanData object at 0x72686511cd70> with id None
[32m2025-10-15 04:00:09.492[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Calling Litellm model: openrouter/openai/gpt-4o-mini
[
  {
    "content": "\n        Voc√™ √© um subagente meteorol√≥gico especializado do sistema VOXY.\n\n        CAPACIDADES:\n        - Obten√ß√£o de dados meteorol√≥gicos em tempo real\n        - Interpreta√ß√£o de condi√ß√µes clim√°ticas\n        - Previs√µes e tend√™ncias\n        - Recomenda√ß√µes baseadas no clima\n        - Suporte a cidades globais\n\n        DIRETRIZES:\n        - Use a ferramenta get_weather_api para dados atualizados\n        - Identifique automaticamente a cidade mencionada\n        - Se a cidade for amb√≠gua, especifique o pa√≠s/estado\n        - Formate as informa√ß√µes de forma clara e √∫til\n        - Inclua detalhes relevantes (temperatura, condi√ß√£o, umidade)\n\n        PROCESSAMENTO:\n        1. Extraia o nome da cidade da solicita√ß√£o\n        2. Use get_weather_api para obter dados\n        3. Formate a resposta de forma amig√°vel\n        4. Adicione contexto ou recomenda√ß√µes quando apropriado\n\n        FORMATO DE RESPOSTA:\n        - Seja claro e informativo\n        - Use unidades apropriadas (Celsius para Brasil)\n        - Inclua √≠cones ou emojis quando √∫til\n        - Forne√ßa contexto relevante\n\n        EXEMPLOS:\n        Input: \"Qual o clima em S√£o Paulo?\"\n        Process: get_weather_api(\"S√£o Paulo\", \"BR\")\n        Output: \"üå§Ô∏è S√£o Paulo est√° com 22¬∞C, ensolarado. Umidade de 65% e vento de 10km/h. Perfeito para atividades ao ar livre!\"\n\n        Input: \"Como est√° o tempo em Londres?\"\n        Process: get_weather_api(\"London\", \"UK\")\n        Output: \"üåßÔ∏è Londres est√° com 15¬∞C, chuva leve. Umidade alta de 85%. Recomendo levar guarda-chuva!\"\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": "Qual o clima em S√£o Paulo, BR?"
  }
]
Tools:
[
  {
    "type": "function",
    "function": {
      "name": "get_weather_api",
      "description": "Get weather information for a city using OpenWeatherMap API.",
      "parameters": {
        "properties": {
          "city": {
            "description": "Name of the city",
            "title": "City",
            "type": "string"
          },
          "country": {
            "default": "BR",
            "description": "Country code (default: BR for Brazil)",
            "title": "Country",
            "type": "string"
          }
        },
        "required": [
          "city",
          "country"
        ],
        "title": "get_weather_api_args",
        "type": "object",
        "additionalProperties": false
      }
    }
  }
]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

[32m2025-10-15 04:00:10.491[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | LLM resp:
{
  "content": "",
  "role": "assistant",
  "tool_calls": [
    {
      "index": 0,
      "function": {
        "arguments": "{\"city\":\"S√£o Paulo\",\"country\":\"BR\"}",
        "name": "get_weather_api"
      },
      "id": "call_fkFhw32P93xRb3fwknMm5mgc",
      "type": "function"
    }
  ],
  "function_call": null
}

[32m2025-10-15 04:00:10.535[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.FunctionSpanData object at 0x72687bab9400> with id None
[32m2025-10-15 04:00:10.536[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Invoking tool get_weather_api with input {"city":"S√£o Paulo","country":"BR"}
[32m2025-10-15 04:00:10.536[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Tool call args: ['S√£o Paulo', 'BR'], kwargs: {}
[32m2025-10-15 04:00:10.586[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Tool get_weather_api returned ‚ö†Ô∏è Erro ao obter clima de S√£o Paulo: 401
[32m2025-10-15 04:00:10.587[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Running agent Subagente Meteorol√≥gico VOXY (turn 2)
[32m2025-10-15 04:00:10.588[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.GenerationSpanData object at 0x72686511e030> with id None
[32m2025-10-15 04:00:10.588[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Calling Litellm model: openrouter/openai/gpt-4o-mini
[
  {
    "content": "\n        Voc√™ √© um subagente meteorol√≥gico especializado do sistema VOXY.\n\n        CAPACIDADES:\n        - Obten√ß√£o de dados meteorol√≥gicos em tempo real\n        - Interpreta√ß√£o de condi√ß√µes clim√°ticas\n        - Previs√µes e tend√™ncias\n        - Recomenda√ß√µes baseadas no clima\n        - Suporte a cidades globais\n\n        DIRETRIZES:\n        - Use a ferramenta get_weather_api para dados atualizados\n        - Identifique automaticamente a cidade mencionada\n        - Se a cidade for amb√≠gua, especifique o pa√≠s/estado\n        - Formate as informa√ß√µes de forma clara e √∫til\n        - Inclua detalhes relevantes (temperatura, condi√ß√£o, umidade)\n\n        PROCESSAMENTO:\n        1. Extraia o nome da cidade da solicita√ß√£o\n        2. Use get_weather_api para obter dados\n        3. Formate a resposta de forma amig√°vel\n        4. Adicione contexto ou recomenda√ß√µes quando apropriado\n\n        FORMATO DE RESPOSTA:\n        - Seja claro e informativo\n        - Use unidades apropriadas (Celsius para Brasil)\n        - Inclua √≠cones ou emojis quando √∫til\n        - Forne√ßa contexto relevante\n\n        EXEMPLOS:\n        Input: \"Qual o clima em S√£o Paulo?\"\n        Process: get_weather_api(\"S√£o Paulo\", \"BR\")\n        Output: \"üå§Ô∏è S√£o Paulo est√° com 22¬∞C, ensolarado. Umidade de 65% e vento de 10km/h. Perfeito para atividades ao ar livre!\"\n\n        Input: \"Como est√° o tempo em Londres?\"\n        Process: get_weather_api(\"London\", \"UK\")\n        Output: \"üåßÔ∏è Londres est√° com 15¬∞C, chuva leve. Umidade alta de 85%. Recomendo levar guarda-chuva!\"\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": "Qual o clima em S√£o Paulo, BR?"
  },
  {
    "role": "assistant",
    "tool_calls": [
      {
        "id": "call_fkFhw32P93xRb3fwknMm5mgc",
        "type": "function",
        "function": {
          "name": "get_weather_api",
          "arguments": "{\"city\":\"S√£o Paulo\",\"country\":\"BR\"}"
        }
      }
    ]
  },
  {
    "role": "tool",
    "tool_call_id": "call_fkFhw32P93xRb3fwknMm5mgc",
    "content": "‚ö†Ô∏è Erro ao obter clima de S√£o Paulo: 401"
  }
]
Tools:
[
  {
    "type": "function",
    "function": {
      "name": "get_weather_api",
      "description": "Get weather information for a city using OpenWeatherMap API.",
      "parameters": {
        "properties": {
          "city": {
            "description": "Name of the city",
            "title": "City",
            "type": "string"
          },
          "country": {
            "default": "BR",
            "description": "Country code (default: BR for Brazil)",
            "title": "Country",
            "type": "string"
          }
        },
        "required": [
          "city",
          "country"
        ],
        "title": "get_weather_api_args",
        "type": "object",
        "additionalProperties": false
      }
    }
  }
]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

[32m2025-10-15 04:00:11.674[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | LLM resp:
{
  "content": "",
  "role": "assistant",
  "tool_calls": [
    {
      "index": 0,
      "function": {
        "arguments": "{\"city\":\"S√£o Paulo\",\"country\":\"BR\"}",
        "name": "get_weather_api"
      },
      "id": "call_cHyDhTDJz844SIz2QkKY7HgC",
      "type": "function"
    }
  ],
  "function_call": null
}

[32m2025-10-15 04:00:11.776[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.FunctionSpanData object at 0x726865119c20> with id None
[32m2025-10-15 04:00:11.776[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Invoking tool get_weather_api with input {"city":"S√£o Paulo","country":"BR"}
[32m2025-10-15 04:00:11.777[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Tool call args: ['S√£o Paulo', 'BR'], kwargs: {}
[32m2025-10-15 04:00:11.877[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Tool get_weather_api returned ‚ö†Ô∏è Erro ao obter clima de S√£o Paulo: 401
[32m2025-10-15 04:00:11.878[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Running agent Subagente Meteorol√≥gico VOXY (turn 3)
[32m2025-10-15 04:00:11.878[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.GenerationSpanData object at 0x7268650421b0> with id None
[32m2025-10-15 04:00:11.879[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Calling Litellm model: openrouter/openai/gpt-4o-mini
[
  {
    "content": "\n        Voc√™ √© um subagente meteorol√≥gico especializado do sistema VOXY.\n\n        CAPACIDADES:\n        - Obten√ß√£o de dados meteorol√≥gicos em tempo real\n        - Interpreta√ß√£o de condi√ß√µes clim√°ticas\n        - Previs√µes e tend√™ncias\n        - Recomenda√ß√µes baseadas no clima\n        - Suporte a cidades globais\n\n        DIRETRIZES:\n        - Use a ferramenta get_weather_api para dados atualizados\n        - Identifique automaticamente a cidade mencionada\n        - Se a cidade for amb√≠gua, especifique o pa√≠s/estado\n        - Formate as informa√ß√µes de forma clara e √∫til\n        - Inclua detalhes relevantes (temperatura, condi√ß√£o, umidade)\n\n        PROCESSAMENTO:\n        1. Extraia o nome da cidade da solicita√ß√£o\n        2. Use get_weather_api para obter dados\n        3. Formate a resposta de forma amig√°vel\n        4. Adicione contexto ou recomenda√ß√µes quando apropriado\n\n        FORMATO DE RESPOSTA:\n        - Seja claro e informativo\n        - Use unidades apropriadas (Celsius para Brasil)\n        - Inclua √≠cones ou emojis quando √∫til\n        - Forne√ßa contexto relevante\n\n        EXEMPLOS:\n        Input: \"Qual o clima em S√£o Paulo?\"\n        Process: get_weather_api(\"S√£o Paulo\", \"BR\")\n        Output: \"üå§Ô∏è S√£o Paulo est√° com 22¬∞C, ensolarado. Umidade de 65% e vento de 10km/h. Perfeito para atividades ao ar livre!\"\n\n        Input: \"Como est√° o tempo em Londres?\"\n        Process: get_weather_api(\"London\", \"UK\")\n        Output: \"üåßÔ∏è Londres est√° com 15¬∞C, chuva leve. Umidade alta de 85%. Recomendo levar guarda-chuva!\"\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": "Qual o clima em S√£o Paulo, BR?"
  },
  {
    "role": "assistant",
    "tool_calls": [
      {
        "id": "call_fkFhw32P93xRb3fwknMm5mgc",
        "type": "function",
        "function": {
          "name": "get_weather_api",
          "arguments": "{\"city\":\"S√£o Paulo\",\"country\":\"BR\"}"
        }
      }
    ]
  },
  {
    "role": "tool",
    "tool_call_id": "call_fkFhw32P93xRb3fwknMm5mgc",
    "content": "‚ö†Ô∏è Erro ao obter clima de S√£o Paulo: 401"
  },
  {
    "role": "assistant",
    "tool_calls": [
      {
        "id": "call_cHyDhTDJz844SIz2QkKY7HgC",
        "type": "function",
        "function": {
          "name": "get_weather_api",
          "arguments": "{\"city\":\"S√£o Paulo\",\"country\":\"BR\"}"
        }
      }
    ]
  },
  {
    "role": "tool",
    "tool_call_id": "call_cHyDhTDJz844SIz2QkKY7HgC",
    "content": "‚ö†Ô∏è Erro ao obter clima de S√£o Paulo: 401"
  }
]
Tools:
[
  {
    "type": "function",
    "function": {
      "name": "get_weather_api",
      "description": "Get weather information for a city using OpenWeatherMap API.",
      "parameters": {
        "properties": {
          "city": {
            "description": "Name of the city",
            "title": "City",
            "type": "string"
          },
          "country": {
            "default": "BR",
            "description": "Country code (default: BR for Brazil)",
            "title": "Country",
            "type": "string"
          }
        },
        "required": [
          "city",
          "country"
        ],
        "title": "get_weather_api_args",
        "type": "object",
        "additionalProperties": false
      }
    }
  }
]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

[32m2025-10-15 04:00:13.128[0m | [31m[1mERROR   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | [non-fatal] Tracing client error 401: {
  "error": {
    "message": "Incorrect API key provided: test-key. You can find your API key at https://platform.openai.com/account/api-keys.",
    "type": "invalid_request_error",
    "param": null,
    "code": "invalid_api_key"
  }
}
[32m2025-10-15 04:00:13.804[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | LLM resp:
{
  "content": "Parece que estou enfrentando dificuldades para obter os dados meteorol√≥gicos de S√£o Paulo no momento. Isso pode ser um problema tempor√°rio com a fonte de dados.\n\nEnquanto isso, voc√™ pode verificar a previs√£o do tempo em um site de meteorologia ou aplicativo confi√°vel. Se precisar de informa√ß√µes sobre outra cidade ou qualquer outra coisa, estou aqui para ajudar!",
  "role": "assistant",
  "tool_calls": null,
  "function_call": null
}

[32m2025-10-15 04:00:13.840[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Resetting current trace
[32m2025-10-15 04:00:13.841[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | 
------------------------------ Captured log call -------------------------------
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:244 üß™ Testing weather agent...
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:55 Creating LiteLLM model: openrouter/openai/gpt-4o-mini (max_tokens=1500, temperature=0.1)
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:67 ‚úì LiteLLM model created successfully: openrouter/openai/gpt-4o-mini
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:373 üìù Formatted input: Qual o clima em S√£o Paulo, BR?...
DEBUG    openai.agents:provider.py:239 Creating trace Agent workflow with id trace_9f3864cdc9b44d27a594d248b560471e
DEBUG    openai.agents:scope.py:43 Setting current trace: trace_9f3864cdc9b44d27a594d248b560471e
DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.AgentSpanData object at 0x726865119d10> with id None
DEBUG    openai.agents:run.py:438 Running agent Subagente Meteorol√≥gico VOXY (turn 1)
DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.GenerationSpanData object at 0x72686511cd70> with id None
DEBUG    openai.agents:litellm_model.py:286 Calling Litellm model: openrouter/openai/gpt-4o-mini
[
  {
    "content": "\n        Voc√™ √© um subagente meteorol√≥gico especializado do sistema VOXY.\n\n        CAPACIDADES:\n        - Obten√ß√£o de dados meteorol√≥gicos em tempo real\n        - Interpreta√ß√£o de condi√ß√µes clim√°ticas\n        - Previs√µes e tend√™ncias\n        - Recomenda√ß√µes baseadas no clima\n        - Suporte a cidades globais\n\n        DIRETRIZES:\n        - Use a ferramenta get_weather_api para dados atualizados\n        - Identifique automaticamente a cidade mencionada\n        - Se a cidade for amb√≠gua, especifique o pa√≠s/estado\n        - Formate as informa√ß√µes de forma clara e √∫til\n        - Inclua detalhes relevantes (temperatura, condi√ß√£o, umidade)\n\n        PROCESSAMENTO:\n        1. Extraia o nome da cidade da solicita√ß√£o\n        2. Use get_weather_api para obter dados\n        3. Formate a resposta de forma amig√°vel\n        4. Adicione contexto ou recomenda√ß√µes quando apropriado\n\n        FORMATO DE RESPOSTA:\n        - Seja claro e informativo\n        - Use unidades apropriadas (Celsius para Brasil)\n        - Inclua √≠cones ou emojis quando √∫til\n        - Forne√ßa contexto relevante\n\n        EXEMPLOS:\n        Input: \"Qual o clima em S√£o Paulo?\"\n        Process: get_weather_api(\"S√£o Paulo\", \"BR\")\n        Output: \"üå§Ô∏è S√£o Paulo est√° com 22¬∞C, ensolarado. Umidade de 65% e vento de 10km/h. Perfeito para atividades ao ar livre!\"\n\n        Input: \"Como est√° o tempo em Londres?\"\n        Process: get_weather_api(\"London\", \"UK\")\n        Output: \"üåßÔ∏è Londres est√° com 15¬∞C, chuva leve. Umidade alta de 85%. Recomendo levar guarda-chuva!\"\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": "Qual o clima em S√£o Paulo, BR?"
  }
]
Tools:
[
  {
    "type": "function",
    "function": {
      "name": "get_weather_api",
      "description": "Get weather information for a city using OpenWeatherMap API.",
      "parameters": {
        "properties": {
          "city": {
            "description": "Name of the city",
            "title": "City",
            "type": "string"
          },
          "country": {
            "default": "BR",
            "description": "Country code (default: BR for Brazil)",
            "title": "Country",
            "type": "string"
          }
        },
        "required": [
          "city",
          "country"
        ],
        "title": "get_weather_api_args",
        "type": "object",
        "additionalProperties": false
      }
    }
  }
]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

DEBUG    openai.agents:litellm_model.py:112 LLM resp:
{
  "content": "",
  "role": "assistant",
  "tool_calls": [
    {
      "index": 0,
      "function": {
        "arguments": "{\"city\":\"S√£o Paulo\",\"country\":\"BR\"}",
        "name": "get_weather_api"
      },
      "id": "call_fkFhw32P93xRb3fwknMm5mgc",
      "type": "function"
    }
  ],
  "function_call": null
}

DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.FunctionSpanData object at 0x72687bab9400> with id None
DEBUG    openai.agents:tool.py:397 Invoking tool get_weather_api with input {"city":"S√£o Paulo","country":"BR"}
DEBUG    openai.agents:tool.py:411 Tool call args: ['S√£o Paulo', 'BR'], kwargs: {}
DEBUG    openai.agents:tool.py:427 Tool get_weather_api returned ‚ö†Ô∏è Erro ao obter clima de S√£o Paulo: 401
DEBUG    openai.agents:run.py:438 Running agent Subagente Meteorol√≥gico VOXY (turn 2)
DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.GenerationSpanData object at 0x72686511e030> with id None
DEBUG    openai.agents:litellm_model.py:286 Calling Litellm model: openrouter/openai/gpt-4o-mini
[
  {
    "content": "\n        Voc√™ √© um subagente meteorol√≥gico especializado do sistema VOXY.\n\n        CAPACIDADES:\n        - Obten√ß√£o de dados meteorol√≥gicos em tempo real\n        - Interpreta√ß√£o de condi√ß√µes clim√°ticas\n        - Previs√µes e tend√™ncias\n        - Recomenda√ß√µes baseadas no clima\n        - Suporte a cidades globais\n\n        DIRETRIZES:\n        - Use a ferramenta get_weather_api para dados atualizados\n        - Identifique automaticamente a cidade mencionada\n        - Se a cidade for amb√≠gua, especifique o pa√≠s/estado\n        - Formate as informa√ß√µes de forma clara e √∫til\n        - Inclua detalhes relevantes (temperatura, condi√ß√£o, umidade)\n\n        PROCESSAMENTO:\n        1. Extraia o nome da cidade da solicita√ß√£o\n        2. Use get_weather_api para obter dados\n        3. Formate a resposta de forma amig√°vel\n        4. Adicione contexto ou recomenda√ß√µes quando apropriado\n\n        FORMATO DE RESPOSTA:\n        - Seja claro e informativo\n        - Use unidades apropriadas (Celsius para Brasil)\n        - Inclua √≠cones ou emojis quando √∫til\n        - Forne√ßa contexto relevante\n\n        EXEMPLOS:\n        Input: \"Qual o clima em S√£o Paulo?\"\n        Process: get_weather_api(\"S√£o Paulo\", \"BR\")\n        Output: \"üå§Ô∏è S√£o Paulo est√° com 22¬∞C, ensolarado. Umidade de 65% e vento de 10km/h. Perfeito para atividades ao ar livre!\"\n\n        Input: \"Como est√° o tempo em Londres?\"\n        Process: get_weather_api(\"London\", \"UK\")\n        Output: \"üåßÔ∏è Londres est√° com 15¬∞C, chuva leve. Umidade alta de 85%. Recomendo levar guarda-chuva!\"\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": "Qual o clima em S√£o Paulo, BR?"
  },
  {
    "role": "assistant",
    "tool_calls": [
      {
        "id": "call_fkFhw32P93xRb3fwknMm5mgc",
        "type": "function",
        "function": {
          "name": "get_weather_api",
          "arguments": "{\"city\":\"S√£o Paulo\",\"country\":\"BR\"}"
        }
      }
    ]
  },
  {
    "role": "tool",
    "tool_call_id": "call_fkFhw32P93xRb3fwknMm5mgc",
    "content": "‚ö†Ô∏è Erro ao obter clima de S√£o Paulo: 401"
  }
]
Tools:
[
  {
    "type": "function",
    "function": {
      "name": "get_weather_api",
      "description": "Get weather information for a city using OpenWeatherMap API.",
      "parameters": {
        "properties": {
          "city": {
            "description": "Name of the city",
            "title": "City",
            "type": "string"
          },
          "country": {
            "default": "BR",
            "description": "Country code (default: BR for Brazil)",
            "title": "Country",
            "type": "string"
          }
        },
        "required": [
          "city",
          "country"
        ],
        "title": "get_weather_api_args",
        "type": "object",
        "additionalProperties": false
      }
    }
  }
]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

DEBUG    openai.agents:litellm_model.py:112 LLM resp:
{
  "content": "",
  "role": "assistant",
  "tool_calls": [
    {
      "index": 0,
      "function": {
        "arguments": "{\"city\":\"S√£o Paulo\",\"country\":\"BR\"}",
        "name": "get_weather_api"
      },
      "id": "call_cHyDhTDJz844SIz2QkKY7HgC",
      "type": "function"
    }
  ],
  "function_call": null
}

DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.FunctionSpanData object at 0x726865119c20> with id None
DEBUG    openai.agents:tool.py:397 Invoking tool get_weather_api with input {"city":"S√£o Paulo","country":"BR"}
DEBUG    openai.agents:tool.py:411 Tool call args: ['S√£o Paulo', 'BR'], kwargs: {}
DEBUG    openai.agents:tool.py:427 Tool get_weather_api returned ‚ö†Ô∏è Erro ao obter clima de S√£o Paulo: 401
DEBUG    openai.agents:run.py:438 Running agent Subagente Meteorol√≥gico VOXY (turn 3)
DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.GenerationSpanData object at 0x7268650421b0> with id None
DEBUG    openai.agents:litellm_model.py:286 Calling Litellm model: openrouter/openai/gpt-4o-mini
[
  {
    "content": "\n        Voc√™ √© um subagente meteorol√≥gico especializado do sistema VOXY.\n\n        CAPACIDADES:\n        - Obten√ß√£o de dados meteorol√≥gicos em tempo real\n        - Interpreta√ß√£o de condi√ß√µes clim√°ticas\n        - Previs√µes e tend√™ncias\n        - Recomenda√ß√µes baseadas no clima\n        - Suporte a cidades globais\n\n        DIRETRIZES:\n        - Use a ferramenta get_weather_api para dados atualizados\n        - Identifique automaticamente a cidade mencionada\n        - Se a cidade for amb√≠gua, especifique o pa√≠s/estado\n        - Formate as informa√ß√µes de forma clara e √∫til\n        - Inclua detalhes relevantes (temperatura, condi√ß√£o, umidade)\n\n        PROCESSAMENTO:\n        1. Extraia o nome da cidade da solicita√ß√£o\n        2. Use get_weather_api para obter dados\n        3. Formate a resposta de forma amig√°vel\n        4. Adicione contexto ou recomenda√ß√µes quando apropriado\n\n        FORMATO DE RESPOSTA:\n        - Seja claro e informativo\n        - Use unidades apropriadas (Celsius para Brasil)\n        - Inclua √≠cones ou emojis quando √∫til\n        - Forne√ßa contexto relevante\n\n        EXEMPLOS:\n        Input: \"Qual o clima em S√£o Paulo?\"\n        Process: get_weather_api(\"S√£o Paulo\", \"BR\")\n        Output: \"üå§Ô∏è S√£o Paulo est√° com 22¬∞C, ensolarado. Umidade de 65% e vento de 10km/h. Perfeito para atividades ao ar livre!\"\n\n        Input: \"Como est√° o tempo em Londres?\"\n        Process: get_weather_api(\"London\", \"UK\")\n        Output: \"üåßÔ∏è Londres est√° com 15¬∞C, chuva leve. Umidade alta de 85%. Recomendo levar guarda-chuva!\"\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": "Qual o clima em S√£o Paulo, BR?"
  },
  {
    "role": "assistant",
    "tool_calls": [
      {
        "id": "call_fkFhw32P93xRb3fwknMm5mgc",
        "type": "function",
        "function": {
          "name": "get_weather_api",
          "arguments": "{\"city\":\"S√£o Paulo\",\"country\":\"BR\"}"
        }
      }
    ]
  },
  {
    "role": "tool",
    "tool_call_id": "call_fkFhw32P93xRb3fwknMm5mgc",
    "content": "‚ö†Ô∏è Erro ao obter clima de S√£o Paulo: 401"
  },
  {
    "role": "assistant",
    "tool_calls": [
      {
        "id": "call_cHyDhTDJz844SIz2QkKY7HgC",
        "type": "function",
        "function": {
          "name": "get_weather_api",
          "arguments": "{\"city\":\"S√£o Paulo\",\"country\":\"BR\"}"
        }
      }
    ]
  },
  {
    "role": "tool",
    "tool_call_id": "call_cHyDhTDJz844SIz2QkKY7HgC",
    "content": "‚ö†Ô∏è Erro ao obter clima de S√£o Paulo: 401"
  }
]
Tools:
[
  {
    "type": "function",
    "function": {
      "name": "get_weather_api",
      "description": "Get weather information for a city using OpenWeatherMap API.",
      "parameters": {
        "properties": {
          "city": {
            "description": "Name of the city",
            "title": "City",
            "type": "string"
          },
          "country": {
            "default": "BR",
            "description": "Country code (default: BR for Brazil)",
            "title": "Country",
            "type": "string"
          }
        },
        "required": [
          "city",
          "country"
        ],
        "title": "get_weather_api_args",
        "type": "object",
        "additionalProperties": false
      }
    }
  }
]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

ERROR    openai.agents:processors.py:129 [non-fatal] Tracing client error 401: {
  "error": {
    "message": "Incorrect API key provided: test-key. You can find your API key at https://platform.openai.com/account/api-keys.",
    "type": "invalid_request_error",
    "param": null,
    "code": "invalid_api_key"
  }
}
DEBUG    openai.agents:litellm_model.py:112 LLM resp:
{
  "content": "Parece que estou enfrentando dificuldades para obter os dados meteorol√≥gicos de S√£o Paulo no momento. Isso pode ser um problema tempor√°rio com a fonte de dados.\n\nEnquanto isso, voc√™ pode verificar a previs√£o do tempo em um site de meteorologia ou aplicativo confi√°vel. Se precisar de informa√ß√µes sobre outra cidade ou qualquer outra coisa, estou aqui para ajudar!",
  "role": "assistant",
  "tool_calls": null,
  "function_call": null
}

DEBUG    openai.agents:scope.py:48 Resetting current trace
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:411
__________________________ test_weather_invalid_city ___________________________

tester = <src.voxy_agents.utils.test_subagents.SubagentTester object at 0x72686515ad20>

    @pytest.mark.asyncio
    async def test_weather_invalid_city(tester):
        """Testa busca de clima para cidade inv√°lida."""
        result = await tester.test_subagent(
            "weather",
            {
                "city": "CidadeInexistente123",
            },
        )
    
        # Pode ser sucesso com mensagem de erro ou falha
        assert result.success is True  # Agent processa mesmo que cidade n√£o exista
        # Deve conter mensagem de erro ou aviso
>       assert (
            "n√£o encontrada" in result.response.lower()
            or "erro" in result.response.lower()
            or "API" in result.response
        )
E       assert ('n√£o encontrada' in 'parece que a cidade "cidadeinexistente123" n√£o √© reconhecida ou n√£o existe. por favor, verifique o nome da cidade e tente novamente. se precisar de informa√ß√µes sobre outra cidade, estou aqui para ajudar! üåç' or 'erro' in 'parece que a cidade "cidadeinexistente123" n√£o √© reconhecida ou n√£o existe. por favor, verifique o nome da cidade e tente novamente. se precisar de informa√ß√µes sobre outra cidade, estou aqui para ajudar! üåç' or 'API' in 'Parece que a cidade "CidadeInexistente123" n√£o √© reconhecida ou n√£o existe. Por favor, verifique o nome da cidade e tente novamente. Se precisar de informa√ß√µes sobre outra cidade, estou aqui para ajudar! üåç')
E        +  where 'parece que a cidade "cidadeinexistente123" n√£o √© reconhecida ou n√£o existe. por favor, verifique o nome da cidade e tente novamente. se precisar de informa√ß√µes sobre outra cidade, estou aqui para ajudar! üåç' = <built-in method lower of str object at 0x2e650510>()
E        +    where <built-in method lower of str object at 0x2e650510> = 'Parece que a cidade "CidadeInexistente123" n√£o √© reconhecida ou n√£o existe. Por favor, verifique o nome da cidade e tente novamente. Se precisar de informa√ß√µes sobre outra cidade, estou aqui para ajudar! üåç'.lower
E        +      where 'Parece que a cidade "CidadeInexistente123" n√£o √© reconhecida ou n√£o existe. Por favor, verifique o nome da cidade e tente novamente. Se precisar de informa√ß√µes sobre outra cidade, estou aqui para ajudar! üåç' = TestResult(success=True, agent_name='weather', response='Parece que a cidade "CidadeInexistente123" n√£o √© reconhecida ...ne, bypass_cache=True, bypass_rate_limit=True, tools_used=None, subagents_invoked=None, raw_metadata=None), error=None).response
E        +  and   'parece que a cidade "cidadeinexistente123" n√£o √© reconhecida ou n√£o existe. por favor, verifique o nome da cidade e tente novamente. se precisar de informa√ß√µes sobre outra cidade, estou aqui para ajudar! üåç' = <built-in method lower of str object at 0x2e650510>()
E        +    where <built-in method lower of str object at 0x2e650510> = 'Parece que a cidade "CidadeInexistente123" n√£o √© reconhecida ou n√£o existe. Por favor, verifique o nome da cidade e tente novamente. Se precisar de informa√ß√µes sobre outra cidade, estou aqui para ajudar! üåç'.lower
E        +      where 'Parece que a cidade "CidadeInexistente123" n√£o √© reconhecida ou n√£o existe. Por favor, verifique o nome da cidade e tente novamente. Se precisar de informa√ß√µes sobre outra cidade, estou aqui para ajudar! üåç' = TestResult(success=True, agent_name='weather', response='Parece que a cidade "CidadeInexistente123" n√£o √© reconhecida ...ne, bypass_cache=True, bypass_rate_limit=True, tools_used=None, subagents_invoked=None, raw_metadata=None), error=None).response
E        +  and   'Parece que a cidade "CidadeInexistente123" n√£o √© reconhecida ou n√£o existe. Por favor, verifique o nome da cidade e tente novamente. Se precisar de informa√ß√µes sobre outra cidade, estou aqui para ajudar! üåç' = TestResult(success=True, agent_name='weather', response='Parece que a cidade "CidadeInexistente123" n√£o √© reconhecida ...ne, bypass_cache=True, bypass_rate_limit=True, tools_used=None, subagents_invoked=None, raw_metadata=None), error=None).response

tests/test_subagent_tester.py:251: AssertionError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:00:13.874[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
------------------------------ Captured log setup ------------------------------
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:130 SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
----------------------------- Captured stdout call -----------------------------
[32m2025-10-15 04:00:13.875[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | üß™ Testing weather agent...
[32m2025-10-15 04:00:13.875[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | üìù Formatted input: Qual o clima em CidadeInexistente123, BR?...
[32m2025-10-15 04:00:13.876[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating trace Agent workflow with id trace_6a0f18fd383446fa8a7f7dbeee077e71
[32m2025-10-15 04:00:13.876[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Setting current trace: trace_6a0f18fd383446fa8a7f7dbeee077e71
[32m2025-10-15 04:00:13.876[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.AgentSpanData object at 0x726866251360> with id None
[32m2025-10-15 04:00:13.876[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Running agent Subagente Meteorol√≥gico VOXY (turn 1)
[32m2025-10-15 04:00:13.877[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.GenerationSpanData object at 0x72686511dc10> with id None
[32m2025-10-15 04:00:13.877[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Calling Litellm model: openrouter/openai/gpt-4o-mini
[
  {
    "content": "\n        Voc√™ √© um subagente meteorol√≥gico especializado do sistema VOXY.\n\n        CAPACIDADES:\n        - Obten√ß√£o de dados meteorol√≥gicos em tempo real\n        - Interpreta√ß√£o de condi√ß√µes clim√°ticas\n        - Previs√µes e tend√™ncias\n        - Recomenda√ß√µes baseadas no clima\n        - Suporte a cidades globais\n\n        DIRETRIZES:\n        - Use a ferramenta get_weather_api para dados atualizados\n        - Identifique automaticamente a cidade mencionada\n        - Se a cidade for amb√≠gua, especifique o pa√≠s/estado\n        - Formate as informa√ß√µes de forma clara e √∫til\n        - Inclua detalhes relevantes (temperatura, condi√ß√£o, umidade)\n\n        PROCESSAMENTO:\n        1. Extraia o nome da cidade da solicita√ß√£o\n        2. Use get_weather_api para obter dados\n        3. Formate a resposta de forma amig√°vel\n        4. Adicione contexto ou recomenda√ß√µes quando apropriado\n\n        FORMATO DE RESPOSTA:\n        - Seja claro e informativo\n        - Use unidades apropriadas (Celsius para Brasil)\n        - Inclua √≠cones ou emojis quando √∫til\n        - Forne√ßa contexto relevante\n\n        EXEMPLOS:\n        Input: \"Qual o clima em S√£o Paulo?\"\n        Process: get_weather_api(\"S√£o Paulo\", \"BR\")\n        Output: \"üå§Ô∏è S√£o Paulo est√° com 22¬∞C, ensolarado. Umidade de 65% e vento de 10km/h. Perfeito para atividades ao ar livre!\"\n\n        Input: \"Como est√° o tempo em Londres?\"\n        Process: get_weather_api(\"London\", \"UK\")\n        Output: \"üåßÔ∏è Londres est√° com 15¬∞C, chuva leve. Umidade alta de 85%. Recomendo levar guarda-chuva!\"\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": "Qual o clima em CidadeInexistente123, BR?"
  }
]
Tools:
[
  {
    "type": "function",
    "function": {
      "name": "get_weather_api",
      "description": "Get weather information for a city using OpenWeatherMap API.",
      "parameters": {
        "properties": {
          "city": {
            "description": "Name of the city",
            "title": "City",
            "type": "string"
          },
          "country": {
            "default": "BR",
            "description": "Country code (default: BR for Brazil)",
            "title": "Country",
            "type": "string"
          }
        },
        "required": [
          "city",
          "country"
        ],
        "title": "get_weather_api_args",
        "type": "object",
        "additionalProperties": false
      }
    }
  }
]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

[32m2025-10-15 04:00:14.852[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | LLM resp:
{
  "content": "",
  "role": "assistant",
  "tool_calls": [
    {
      "index": 0,
      "function": {
        "arguments": "{\"city\":\"CidadeInexistente123\",\"country\":\"BR\"}",
        "name": "get_weather_api"
      },
      "id": "call_9T6QGt3DkswRrM3vSwa7ixnx",
      "type": "function"
    }
  ],
  "function_call": null
}

[32m2025-10-15 04:00:14.891[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.FunctionSpanData object at 0x7268663d4fa0> with id None
[32m2025-10-15 04:00:14.891[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Invoking tool get_weather_api with input {"city":"CidadeInexistente123","country":"BR"}
[32m2025-10-15 04:00:14.892[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Tool call args: ['CidadeInexistente123', 'BR'], kwargs: {}
[32m2025-10-15 04:00:14.936[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Tool get_weather_api returned ‚ö†Ô∏è Erro ao obter clima de CidadeInexistente123: 401
[32m2025-10-15 04:00:14.937[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Running agent Subagente Meteorol√≥gico VOXY (turn 2)
[32m2025-10-15 04:00:14.938[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.GenerationSpanData object at 0x72686511cd10> with id None
[32m2025-10-15 04:00:14.938[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Calling Litellm model: openrouter/openai/gpt-4o-mini
[
  {
    "content": "\n        Voc√™ √© um subagente meteorol√≥gico especializado do sistema VOXY.\n\n        CAPACIDADES:\n        - Obten√ß√£o de dados meteorol√≥gicos em tempo real\n        - Interpreta√ß√£o de condi√ß√µes clim√°ticas\n        - Previs√µes e tend√™ncias\n        - Recomenda√ß√µes baseadas no clima\n        - Suporte a cidades globais\n\n        DIRETRIZES:\n        - Use a ferramenta get_weather_api para dados atualizados\n        - Identifique automaticamente a cidade mencionada\n        - Se a cidade for amb√≠gua, especifique o pa√≠s/estado\n        - Formate as informa√ß√µes de forma clara e √∫til\n        - Inclua detalhes relevantes (temperatura, condi√ß√£o, umidade)\n\n        PROCESSAMENTO:\n        1. Extraia o nome da cidade da solicita√ß√£o\n        2. Use get_weather_api para obter dados\n        3. Formate a resposta de forma amig√°vel\n        4. Adicione contexto ou recomenda√ß√µes quando apropriado\n\n        FORMATO DE RESPOSTA:\n        - Seja claro e informativo\n        - Use unidades apropriadas (Celsius para Brasil)\n        - Inclua √≠cones ou emojis quando √∫til\n        - Forne√ßa contexto relevante\n\n        EXEMPLOS:\n        Input: \"Qual o clima em S√£o Paulo?\"\n        Process: get_weather_api(\"S√£o Paulo\", \"BR\")\n        Output: \"üå§Ô∏è S√£o Paulo est√° com 22¬∞C, ensolarado. Umidade de 65% e vento de 10km/h. Perfeito para atividades ao ar livre!\"\n\n        Input: \"Como est√° o tempo em Londres?\"\n        Process: get_weather_api(\"London\", \"UK\")\n        Output: \"üåßÔ∏è Londres est√° com 15¬∞C, chuva leve. Umidade alta de 85%. Recomendo levar guarda-chuva!\"\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": "Qual o clima em CidadeInexistente123, BR?"
  },
  {
    "role": "assistant",
    "tool_calls": [
      {
        "id": "call_9T6QGt3DkswRrM3vSwa7ixnx",
        "type": "function",
        "function": {
          "name": "get_weather_api",
          "arguments": "{\"city\":\"CidadeInexistente123\",\"country\":\"BR\"}"
        }
      }
    ]
  },
  {
    "role": "tool",
    "tool_call_id": "call_9T6QGt3DkswRrM3vSwa7ixnx",
    "content": "‚ö†Ô∏è Erro ao obter clima de CidadeInexistente123: 401"
  }
]
Tools:
[
  {
    "type": "function",
    "function": {
      "name": "get_weather_api",
      "description": "Get weather information for a city using OpenWeatherMap API.",
      "parameters": {
        "properties": {
          "city": {
            "description": "Name of the city",
            "title": "City",
            "type": "string"
          },
          "country": {
            "default": "BR",
            "description": "Country code (default: BR for Brazil)",
            "title": "Country",
            "type": "string"
          }
        },
        "required": [
          "city",
          "country"
        ],
        "title": "get_weather_api_args",
        "type": "object",
        "additionalProperties": false
      }
    }
  }
]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

[32m2025-10-15 04:00:18.298[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | LLM resp:
{
  "content": "Parece que a cidade \"CidadeInexistente123\" n√£o √© reconhecida ou n√£o existe. Por favor, verifique o nome da cidade e tente novamente. Se precisar de informa√ß√µes sobre outra cidade, estou aqui para ajudar! üåç",
  "role": "assistant",
  "tool_calls": null,
  "function_call": null
}

[32m2025-10-15 04:00:18.332[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Resetting current trace
[32m2025-10-15 04:00:18.332[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | 
------------------------------ Captured log call -------------------------------
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:244 üß™ Testing weather agent...
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:373 üìù Formatted input: Qual o clima em CidadeInexistente123, BR?...
DEBUG    openai.agents:provider.py:239 Creating trace Agent workflow with id trace_6a0f18fd383446fa8a7f7dbeee077e71
DEBUG    openai.agents:scope.py:43 Setting current trace: trace_6a0f18fd383446fa8a7f7dbeee077e71
DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.AgentSpanData object at 0x726866251360> with id None
DEBUG    openai.agents:run.py:438 Running agent Subagente Meteorol√≥gico VOXY (turn 1)
DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.GenerationSpanData object at 0x72686511dc10> with id None
DEBUG    openai.agents:litellm_model.py:286 Calling Litellm model: openrouter/openai/gpt-4o-mini
[
  {
    "content": "\n        Voc√™ √© um subagente meteorol√≥gico especializado do sistema VOXY.\n\n        CAPACIDADES:\n        - Obten√ß√£o de dados meteorol√≥gicos em tempo real\n        - Interpreta√ß√£o de condi√ß√µes clim√°ticas\n        - Previs√µes e tend√™ncias\n        - Recomenda√ß√µes baseadas no clima\n        - Suporte a cidades globais\n\n        DIRETRIZES:\n        - Use a ferramenta get_weather_api para dados atualizados\n        - Identifique automaticamente a cidade mencionada\n        - Se a cidade for amb√≠gua, especifique o pa√≠s/estado\n        - Formate as informa√ß√µes de forma clara e √∫til\n        - Inclua detalhes relevantes (temperatura, condi√ß√£o, umidade)\n\n        PROCESSAMENTO:\n        1. Extraia o nome da cidade da solicita√ß√£o\n        2. Use get_weather_api para obter dados\n        3. Formate a resposta de forma amig√°vel\n        4. Adicione contexto ou recomenda√ß√µes quando apropriado\n\n        FORMATO DE RESPOSTA:\n        - Seja claro e informativo\n        - Use unidades apropriadas (Celsius para Brasil)\n        - Inclua √≠cones ou emojis quando √∫til\n        - Forne√ßa contexto relevante\n\n        EXEMPLOS:\n        Input: \"Qual o clima em S√£o Paulo?\"\n        Process: get_weather_api(\"S√£o Paulo\", \"BR\")\n        Output: \"üå§Ô∏è S√£o Paulo est√° com 22¬∞C, ensolarado. Umidade de 65% e vento de 10km/h. Perfeito para atividades ao ar livre!\"\n\n        Input: \"Como est√° o tempo em Londres?\"\n        Process: get_weather_api(\"London\", \"UK\")\n        Output: \"üåßÔ∏è Londres est√° com 15¬∞C, chuva leve. Umidade alta de 85%. Recomendo levar guarda-chuva!\"\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": "Qual o clima em CidadeInexistente123, BR?"
  }
]
Tools:
[
  {
    "type": "function",
    "function": {
      "name": "get_weather_api",
      "description": "Get weather information for a city using OpenWeatherMap API.",
      "parameters": {
        "properties": {
          "city": {
            "description": "Name of the city",
            "title": "City",
            "type": "string"
          },
          "country": {
            "default": "BR",
            "description": "Country code (default: BR for Brazil)",
            "title": "Country",
            "type": "string"
          }
        },
        "required": [
          "city",
          "country"
        ],
        "title": "get_weather_api_args",
        "type": "object",
        "additionalProperties": false
      }
    }
  }
]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

DEBUG    openai.agents:litellm_model.py:112 LLM resp:
{
  "content": "",
  "role": "assistant",
  "tool_calls": [
    {
      "index": 0,
      "function": {
        "arguments": "{\"city\":\"CidadeInexistente123\",\"country\":\"BR\"}",
        "name": "get_weather_api"
      },
      "id": "call_9T6QGt3DkswRrM3vSwa7ixnx",
      "type": "function"
    }
  ],
  "function_call": null
}

DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.FunctionSpanData object at 0x7268663d4fa0> with id None
DEBUG    openai.agents:tool.py:397 Invoking tool get_weather_api with input {"city":"CidadeInexistente123","country":"BR"}
DEBUG    openai.agents:tool.py:411 Tool call args: ['CidadeInexistente123', 'BR'], kwargs: {}
DEBUG    openai.agents:tool.py:427 Tool get_weather_api returned ‚ö†Ô∏è Erro ao obter clima de CidadeInexistente123: 401
DEBUG    openai.agents:run.py:438 Running agent Subagente Meteorol√≥gico VOXY (turn 2)
DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.GenerationSpanData object at 0x72686511cd10> with id None
DEBUG    openai.agents:litellm_model.py:286 Calling Litellm model: openrouter/openai/gpt-4o-mini
[
  {
    "content": "\n        Voc√™ √© um subagente meteorol√≥gico especializado do sistema VOXY.\n\n        CAPACIDADES:\n        - Obten√ß√£o de dados meteorol√≥gicos em tempo real\n        - Interpreta√ß√£o de condi√ß√µes clim√°ticas\n        - Previs√µes e tend√™ncias\n        - Recomenda√ß√µes baseadas no clima\n        - Suporte a cidades globais\n\n        DIRETRIZES:\n        - Use a ferramenta get_weather_api para dados atualizados\n        - Identifique automaticamente a cidade mencionada\n        - Se a cidade for amb√≠gua, especifique o pa√≠s/estado\n        - Formate as informa√ß√µes de forma clara e √∫til\n        - Inclua detalhes relevantes (temperatura, condi√ß√£o, umidade)\n\n        PROCESSAMENTO:\n        1. Extraia o nome da cidade da solicita√ß√£o\n        2. Use get_weather_api para obter dados\n        3. Formate a resposta de forma amig√°vel\n        4. Adicione contexto ou recomenda√ß√µes quando apropriado\n\n        FORMATO DE RESPOSTA:\n        - Seja claro e informativo\n        - Use unidades apropriadas (Celsius para Brasil)\n        - Inclua √≠cones ou emojis quando √∫til\n        - Forne√ßa contexto relevante\n\n        EXEMPLOS:\n        Input: \"Qual o clima em S√£o Paulo?\"\n        Process: get_weather_api(\"S√£o Paulo\", \"BR\")\n        Output: \"üå§Ô∏è S√£o Paulo est√° com 22¬∞C, ensolarado. Umidade de 65% e vento de 10km/h. Perfeito para atividades ao ar livre!\"\n\n        Input: \"Como est√° o tempo em Londres?\"\n        Process: get_weather_api(\"London\", \"UK\")\n        Output: \"üåßÔ∏è Londres est√° com 15¬∞C, chuva leve. Umidade alta de 85%. Recomendo levar guarda-chuva!\"\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": "Qual o clima em CidadeInexistente123, BR?"
  },
  {
    "role": "assistant",
    "tool_calls": [
      {
        "id": "call_9T6QGt3DkswRrM3vSwa7ixnx",
        "type": "function",
        "function": {
          "name": "get_weather_api",
          "arguments": "{\"city\":\"CidadeInexistente123\",\"country\":\"BR\"}"
        }
      }
    ]
  },
  {
    "role": "tool",
    "tool_call_id": "call_9T6QGt3DkswRrM3vSwa7ixnx",
    "content": "‚ö†Ô∏è Erro ao obter clima de CidadeInexistente123: 401"
  }
]
Tools:
[
  {
    "type": "function",
    "function": {
      "name": "get_weather_api",
      "description": "Get weather information for a city using OpenWeatherMap API.",
      "parameters": {
        "properties": {
          "city": {
            "description": "Name of the city",
            "title": "City",
            "type": "string"
          },
          "country": {
            "default": "BR",
            "description": "Country code (default: BR for Brazil)",
            "title": "Country",
            "type": "string"
          }
        },
        "required": [
          "city",
          "country"
        ],
        "title": "get_weather_api_args",
        "type": "object",
        "additionalProperties": false
      }
    }
  }
]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

DEBUG    openai.agents:litellm_model.py:112 LLM resp:
{
  "content": "Parece que a cidade \"CidadeInexistente123\" n√£o √© reconhecida ou n√£o existe. Por favor, verifique o nome da cidade e tente novamente. Se precisar de informa√ß√µes sobre outra cidade, estou aqui para ajudar! üåç",
  "role": "assistant",
  "tool_calls": null,
  "function_call": null
}

DEBUG    openai.agents:scope.py:48 Resetting current trace
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:411
--------------------------- Captured stdout teardown ---------------------------
[32m2025-10-15 04:00:18.371[0m | [31m[1mERROR   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | [non-fatal] Tracing client error 401: {
  "error": {
    "message": "Incorrect API key provided: test-key. You can find your API key at https://platform.openai.com/account/api-keys.",
    "type": "invalid_request_error",
    "param": null,
    "code": "invalid_api_key"
  }
}
_________________________ test_vision_general_analysis _________________________

tester = <src.voxy_agents.utils.test_subagents.SubagentTester object at 0x72686512b5f0>

    @pytest.mark.asyncio
    async def test_vision_general_analysis(tester):
        """Testa an√°lise visual geral."""
        # Imagem m√≠nima 1x1 pixel PNG (base64)
        test_image = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=="
    
        result = await tester.test_subagent(
            "vision",
            {
                "image_url": test_image,
                "query": "O que voc√™ v√™ nesta imagem?",
                "analysis_type": "general",
                "detail_level": "basic",
            },
        )
    
        assert result.success is True
        assert result.agent_name == "vision"
        assert len(result.response) > 0  # Deve ter alguma an√°lise
>       assert result.metadata.model_used in ["gpt-5", "gpt-4o"]
E       AssertionError: assert 'openrouter/anthropic/claude-sonnet-4.5' in ['gpt-5', 'gpt-4o']
E        +  where 'openrouter/anthropic/claude-sonnet-4.5' = TestMetadata(processing_time=4.594176, model_used='openrouter/anthropic/claude-sonnet-4.5', tokens_used=None, cost=0.0...pi_time=4.42368, bypass_cache=True, bypass_rate_limit=True, tools_used=None, subagents_invoked=None, raw_metadata=None).model_used
E        +    where TestMetadata(processing_time=4.594176, model_used='openrouter/anthropic/claude-sonnet-4.5', tokens_used=None, cost=0.0...pi_time=4.42368, bypass_cache=True, bypass_rate_limit=True, tools_used=None, subagents_invoked=None, raw_metadata=None) = TestResult(success=True, agent_name='vision', response='Vejo uma imagem completamente preta ou que n√£o foi carregada c...68, bypass_cache=True, bypass_rate_limit=True, tools_used=None, subagents_invoked=None, raw_metadata=None), error=None).metadata

tests/test_subagent_tester.py:347: AssertionError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:00:35.520[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
------------------------------ Captured log setup ------------------------------
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:130 SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
----------------------------- Captured stdout call -----------------------------
[32m2025-10-15 04:00:35.521[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | üß™ Testing vision agent...
[32m2025-10-15 04:00:35.521[0m | [1mINFO    [0m | [36mVISION_AGENT|INIT[0m | Vision Agent initialized
[32m2025-10-15 04:00:35.522[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | üóëÔ∏è Vision Agent cache cleared
[32m2025-10-15 04:00:35.522[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | ‚ö° Rate limiting bypassed
[32m2025-10-15 04:00:35.522[0m | [1mINFO    [0m | [36mVISION_AGENT|ANALYSIS_START[0m | Vision analysis starting
[32m2025-10-15 04:00:35.681[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mPIL.PngImagePlugin[0m | STREAM b'IHDR' 16 13
[32m2025-10-15 04:00:35.682[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mPIL.PngImagePlugin[0m | STREAM b'IDAT' 41 13
[32m2025-10-15 04:00:35.683[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.core.cache.vision_cache[0m | ‚ùå Cache MISS: 36ef4549841ab8ea4894...
[32m2025-10-15 04:00:35.689[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.core.optimization.adaptive_reasoning[0m | üß† Adaptive Reasoning: minimal (score: 23.0, est. time: 5.0s)
[32m2025-10-15 04:00:35.689[0m | [1mINFO    [0m | [36mVISION_AGENT|API_CALL[0m | Vision API call starting
[32m2025-10-15 04:00:35.690[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating trace Agent workflow with id trace_343630bee4674afcadf8eeba1da9ae20
[32m2025-10-15 04:00:35.690[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Setting current trace: trace_343630bee4674afcadf8eeba1da9ae20
[32m2025-10-15 04:00:35.690[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.AgentSpanData object at 0x72686508e2b0> with id None
[32m2025-10-15 04:00:35.690[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Running agent Vision Agent (turn 1)
[32m2025-10-15 04:00:35.691[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.GenerationSpanData object at 0x726866df1370> with id None
[32m2025-10-15 04:00:35.691[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Calling Litellm model: openrouter/anthropic/claude-sonnet-4.5
[
  {
    "content": "\n        Voc√™ √© um especialista em an√°lise visual avan√ßada usando GPT-5 multimodal.\n\n        CAPACIDADES:\n        - An√°lise detalhada de imagens com alta precis√£o\n        - Identifica√ß√£o de objetos, pessoas, texto, cenas\n        - OCR integrado para texto em imagens\n        - An√°lise de documentos, gr√°ficos e diagramas\n        - Detec√ß√£o de problemas t√©cnicos\n        - An√°lise art√≠stica e de composi√ß√£o\n\n        FORMATO DE RESPOSTA:\n        - Seja preciso e espec√≠fico nas descri√ß√µes\n        - Use formata√ß√£o markdown quando apropriado\n        - Para an√°lises simples: resposta clara e concisa\n        - Para an√°lises complexas: estruture com se√ß√µes l√≥gicas\n        - Sempre destaque informa√ß√µes importantes\n\n        GUIDELINES:\n        - Mantenha an√°lises confi√°veis e precisas\n        - Adapte n√≠vel de detalhe ao contexto\n        - Seja honesto sobre limita√ß√µes quando aplic√°vel\n        - Use linguagem natural e acess√≠vel\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": [
      {
        "type": "text",
        "text": "Responda de forma direta e concisa: O que voc√™ v√™ nesta imagem?"
      },
      {
        "type": "image_url",
        "image_url": {
          "url": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==",
          "detail": "auto"
        }
      }
    ]
  }
]
Tools:
[]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

[32m2025-10-15 04:00:39.586[0m | [31m[1mERROR   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | [non-fatal] Tracing client error 401: {
  "error": {
    "message": "Incorrect API key provided: test-key. You can find your API key at https://platform.openai.com/account/api-keys.",
    "type": "invalid_request_error",
    "param": null,
    "code": "invalid_api_key"
  }
}
[32m2025-10-15 04:00:40.068[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | LLM resp:
{
  "content": "Vejo uma imagem completamente preta ou que n√£o foi carregada corretamente. N√£o consigo identificar nenhum conte√∫do visual, objetos, texto ou elementos para analisar.\n\nPoss√≠veis causas:\n- Imagem n√£o carregou completamente\n- Arquivo corrompido\n- Imagem totalmente preta/vazia\n- Erro no upload\n\nPor favor, tente enviar a imagem novamente.",
  "role": "assistant",
  "tool_calls": null,
  "function_call": null
}

[32m2025-10-15 04:00:40.113[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Resetting current trace
[32m2025-10-15 04:00:40.113[0m | [1mINFO    [0m | [36mVISION_AGENT|API_SUCCESS[0m | Vision API call completed
[32m2025-10-15 04:00:40.113[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.core.optimization.adaptive_reasoning[0m | üìä Updated stats for minimal: avg_time=4.9s, success_rate=0.955
[32m2025-10-15 04:00:40.113[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mPIL.PngImagePlugin[0m | STREAM b'IHDR' 16 13
[32m2025-10-15 04:00:40.114[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mPIL.PngImagePlugin[0m | STREAM b'IDAT' 41 13
[32m2025-10-15 04:00:40.115[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.core.cache.vision_cache[0m | üíæ Cached analysis: 36ef4549841ab8ea4894... (complexity: minimal)
[32m2025-10-15 04:00:40.115[0m | [1mINFO    [0m | [36mVISION_AGENT|ANALYSIS_COMPLETE[0m | Vision analysis completed successfully
------------------------------ Captured log call -------------------------------
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:244 üß™ Testing vision agent...
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:296 üóëÔ∏è Vision Agent cache cleared
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:302 ‚ö° Rate limiting bypassed
DEBUG    PIL.PngImagePlugin:PngImagePlugin.py:201 STREAM b'IHDR' 16 13
DEBUG    PIL.PngImagePlugin:PngImagePlugin.py:201 STREAM b'IDAT' 41 13
INFO     src.voxy_agents.core.cache.vision_cache:vision_cache.py:156 ‚ùå Cache MISS: 36ef4549841ab8ea4894...
INFO     src.voxy_agents.core.optimization.adaptive_reasoning:adaptive_reasoning.py:177 üß† Adaptive Reasoning: minimal (score: 23.0, est. time: 5.0s)
DEBUG    openai.agents:provider.py:239 Creating trace Agent workflow with id trace_343630bee4674afcadf8eeba1da9ae20
DEBUG    openai.agents:scope.py:43 Setting current trace: trace_343630bee4674afcadf8eeba1da9ae20
DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.AgentSpanData object at 0x72686508e2b0> with id None
DEBUG    openai.agents:run.py:438 Running agent Vision Agent (turn 1)
DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.GenerationSpanData object at 0x726866df1370> with id None
DEBUG    openai.agents:litellm_model.py:286 Calling Litellm model: openrouter/anthropic/claude-sonnet-4.5
[
  {
    "content": "\n        Voc√™ √© um especialista em an√°lise visual avan√ßada usando GPT-5 multimodal.\n\n        CAPACIDADES:\n        - An√°lise detalhada de imagens com alta precis√£o\n        - Identifica√ß√£o de objetos, pessoas, texto, cenas\n        - OCR integrado para texto em imagens\n        - An√°lise de documentos, gr√°ficos e diagramas\n        - Detec√ß√£o de problemas t√©cnicos\n        - An√°lise art√≠stica e de composi√ß√£o\n\n        FORMATO DE RESPOSTA:\n        - Seja preciso e espec√≠fico nas descri√ß√µes\n        - Use formata√ß√£o markdown quando apropriado\n        - Para an√°lises simples: resposta clara e concisa\n        - Para an√°lises complexas: estruture com se√ß√µes l√≥gicas\n        - Sempre destaque informa√ß√µes importantes\n\n        GUIDELINES:\n        - Mantenha an√°lises confi√°veis e precisas\n        - Adapte n√≠vel de detalhe ao contexto\n        - Seja honesto sobre limita√ß√µes quando aplic√°vel\n        - Use linguagem natural e acess√≠vel\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": [
      {
        "type": "text",
        "text": "Responda de forma direta e concisa: O que voc√™ v√™ nesta imagem?"
      },
      {
        "type": "image_url",
        "image_url": {
          "url": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==",
          "detail": "auto"
        }
      }
    ]
  }
]
Tools:
[]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

ERROR    openai.agents:processors.py:129 [non-fatal] Tracing client error 401: {
  "error": {
    "message": "Incorrect API key provided: test-key. You can find your API key at https://platform.openai.com/account/api-keys.",
    "type": "invalid_request_error",
    "param": null,
    "code": "invalid_api_key"
  }
}
DEBUG    openai.agents:litellm_model.py:112 LLM resp:
{
  "content": "Vejo uma imagem completamente preta ou que n√£o foi carregada corretamente. N√£o consigo identificar nenhum conte√∫do visual, objetos, texto ou elementos para analisar.\n\nPoss√≠veis causas:\n- Imagem n√£o carregou completamente\n- Arquivo corrompido\n- Imagem totalmente preta/vazia\n- Erro no upload\n\nPor favor, tente enviar a imagem novamente.",
  "role": "assistant",
  "tool_calls": null,
  "function_call": null
}

DEBUG    openai.agents:scope.py:48 Resetting current trace
DEBUG    src.voxy_agents.core.optimization.adaptive_reasoning:adaptive_reasoning.py:336 üìä Updated stats for minimal: avg_time=4.9s, success_rate=0.955
DEBUG    PIL.PngImagePlugin:PngImagePlugin.py:201 STREAM b'IHDR' 16 13
DEBUG    PIL.PngImagePlugin:PngImagePlugin.py:201 STREAM b'IDAT' 41 13
INFO     src.voxy_agents.core.cache.vision_cache:vision_cache.py:212 üíæ Cached analysis: 36ef4549841ab8ea4894... (complexity: minimal)
________________________ test_vision_missing_image_url _________________________

tester = <src.voxy_agents.utils.test_subagents.SubagentTester object at 0x72686512bda0>

    @pytest.mark.asyncio
    async def test_vision_missing_image_url(tester):
        """Testa erro quando image_url n√£o √© fornecida para Vision Agent."""
>       with pytest.raises(ValueError, match="image_url is required"):
E       Failed: DID NOT RAISE <class 'ValueError'>

tests/test_subagent_tester.py:447: Failed
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:07.192[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
------------------------------ Captured log setup ------------------------------
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:130 SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
----------------------------- Captured stdout call -----------------------------
[32m2025-10-15 04:01:07.193[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | üß™ Testing vision agent...
[32m2025-10-15 04:01:07.193[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | üóëÔ∏è Vision Agent cache cleared
[32m2025-10-15 04:01:07.193[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | ‚ö° Rate limiting bypassed
[32m2025-10-15 04:01:07.193[0m | [31m[1mERROR   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | ‚ùå Test failed for vision: image_url is required for vision agent
------------------------------ Captured log call -------------------------------
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:244 üß™ Testing vision agent...
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:296 üóëÔ∏è Vision Agent cache cleared
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:302 ‚ö° Rate limiting bypassed
ERROR    src.voxy_agents.utils.test_subagents:test_subagents.py:258 ‚ùå Test failed for vision: image_url is required for vision agent
__________________________ test_get_available_agents ___________________________

tester = <src.voxy_agents.utils.test_subagents.SubagentTester object at 0x726865128cb0>

    def test_get_available_agents(tester):
        """Testa listagem de agentes dispon√≠veis."""
        agents = tester.get_available_agents()
    
        assert isinstance(agents, list)
>       assert len(agents) == 5
E       AssertionError: assert 6 == 5
E        +  where 6 = len(['translator', 'corrector', 'weather', 'calculator', 'vision', 'voxy'])

tests/test_subagent_tester.py:509: AssertionError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:07.228[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
------------------------------ Captured log setup ------------------------------
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:130 SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
________________________ test_get_agent_info_translator ________________________

tester = <src.voxy_agents.utils.test_subagents.SubagentTester object at 0x72686509d3d0>

    def test_get_agent_info_translator(tester):
        """Testa obten√ß√£o de informa√ß√µes do translator."""
        info = tester.get_agent_info("translator")
    
        assert info["name"] == "translator"
>       assert info["model"] == "gpt-4o-mini"
E       AssertionError: assert 'openrouter/g...ini-2.5-flash' == 'gpt-4o-mini'
E         
E         - gpt-4o-mini
E         + openrouter/google/gemini-2.5-flash

tests/test_subagent_tester.py:519: AssertionError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:07.255[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
------------------------------ Captured log setup ------------------------------
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:130 SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
__________________________ test_get_agent_info_vision __________________________

tester = <src.voxy_agents.utils.test_subagents.SubagentTester object at 0x72686509ede0>

    def test_get_agent_info_vision(tester):
        """Testa obten√ß√£o de informa√ß√µes do Vision Agent."""
        info = tester.get_agent_info("vision")
    
        assert info["name"] == "vision"
>       assert "gpt-5" in info["model"]
E       AssertionError: assert 'gpt-5' in 'openrouter/anthropic/claude-sonnet-4.5'

tests/test_subagent_tester.py:530: AssertionError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:07.292[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
------------------------------ Captured log setup ------------------------------
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:130 SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
______________________________ test_cost_tracking ______________________________

tester = <src.voxy_agents.utils.test_subagents.SubagentTester object at 0x72686509eb40>

    @pytest.mark.asyncio
    async def test_cost_tracking(tester):
        """Testa se custo √© rastreado corretamente."""
        result = await tester.test_subagent(
            "translator",
            {"text": "Hello", "target_language": "pt-BR"},
        )
    
        assert result.success is True
        # Custo deve ser calculado para agentes padr√£o
>       assert result.metadata.cost is not None
E       AssertionError: assert None is not None
E        +  where None = TestMetadata(processing_time=0.628508, model_used='openrouter/google/gemini-2.5-flash', tokens_used=None, cost=None, c..., api_time=None, bypass_cache=True, bypass_rate_limit=True, tools_used=None, subagents_invoked=None, raw_metadata=None).cost
E        +    where TestMetadata(processing_time=0.628508, model_used='openrouter/google/gemini-2.5-flash', tokens_used=None, cost=None, c..., api_time=None, bypass_cache=True, bypass_rate_limit=True, tools_used=None, subagents_invoked=None, raw_metadata=None) = TestResult(success=True, agent_name='translator', response='Ol√°', metadata=TestMetadata(processing_time=0.628508, mode...ne, bypass_cache=True, bypass_rate_limit=True, tools_used=None, subagents_invoked=None, raw_metadata=None), error=None).metadata

tests/test_subagent_tester.py:643: AssertionError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:21.269[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
------------------------------ Captured log setup ------------------------------
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:130 SubagentTester initialized (bypass_cache=True, bypass_rate_limit=True)
----------------------------- Captured stdout call -----------------------------
[32m2025-10-15 04:01:21.269[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | üß™ Testing translator agent...
[32m2025-10-15 04:01:21.269[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | üìù Formatted input: Traduza 'Hello' para pt-BR...
[32m2025-10-15 04:01:21.270[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating trace Agent workflow with id trace_d48eaf9e59194539a191c9627623fbe4
[32m2025-10-15 04:01:21.270[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Setting current trace: trace_d48eaf9e59194539a191c9627623fbe4
[32m2025-10-15 04:01:21.270[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.AgentSpanData object at 0x72686508dc20> with id None
[32m2025-10-15 04:01:21.270[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Running agent Subagente Tradutor VOXY (turn 1)
[32m2025-10-15 04:01:21.271[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.GenerationSpanData object at 0x726865042ff0> with id None
[32m2025-10-15 04:01:21.271[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Calling Litellm model: openrouter/google/gemini-2.5-flash
[
  {
    "content": "\n        Voc√™ √© um subagente de tradu√ß√£o especializado do sistema VOXY.\n\n        CAPACIDADES:\n        - Tradu√ß√£o entre qualquer par de idiomas\n        - Detec√ß√£o autom√°tica do idioma de origem\n        - Preserva√ß√£o do contexto e significado\n        - Adapta√ß√£o cultural quando apropriado\n        - Formata√ß√£o e estilo consistentes\n\n        DIRETRIZES:\n        - Use sua capacidade nativa de tradu√ß√£o multilingue\n        - Mantenha o tom e estilo do texto original\n        - Para textos t√©cnicos, preserve terminologia espec√≠fica\n        - Para textos criativos, adapte culturalmente quando necess√°rio\n        - Se o idioma de destino n√£o for especificado, pergunte\n\n        FORMATO DE RESPOSTA:\n        - Retorne apenas a tradu√ß√£o solicitada\n        - Seja preciso e fluente\n        - Mantenha formata√ß√£o original (markdown, etc.)\n\n        EXEMPLOS:\n        Input: \"Translate 'Hello world' to Portuguese\"\n        Output: \"Ol√° mundo\"\n\n        Input: \"Traduzir 'Bom dia' para ingl√™s\"\n        Output: \"Good morning\"\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": "Traduza 'Hello' para pt-BR"
  }
]
Tools:
[]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

[32m2025-10-15 04:01:21.856[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | LLM resp:
{
  "content": "Ol√°",
  "role": "assistant",
  "tool_calls": null,
  "function_call": null
}

[32m2025-10-15 04:01:21.897[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Resetting current trace
[32m2025-10-15 04:01:21.898[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.test_subagents[0m | 
------------------------------ Captured log call -------------------------------
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:244 üß™ Testing translator agent...
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:373 üìù Formatted input: Traduza 'Hello' para pt-BR...
DEBUG    openai.agents:provider.py:239 Creating trace Agent workflow with id trace_d48eaf9e59194539a191c9627623fbe4
DEBUG    openai.agents:scope.py:43 Setting current trace: trace_d48eaf9e59194539a191c9627623fbe4
DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.AgentSpanData object at 0x72686508dc20> with id None
DEBUG    openai.agents:run.py:438 Running agent Subagente Tradutor VOXY (turn 1)
DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.GenerationSpanData object at 0x726865042ff0> with id None
DEBUG    openai.agents:litellm_model.py:286 Calling Litellm model: openrouter/google/gemini-2.5-flash
[
  {
    "content": "\n        Voc√™ √© um subagente de tradu√ß√£o especializado do sistema VOXY.\n\n        CAPACIDADES:\n        - Tradu√ß√£o entre qualquer par de idiomas\n        - Detec√ß√£o autom√°tica do idioma de origem\n        - Preserva√ß√£o do contexto e significado\n        - Adapta√ß√£o cultural quando apropriado\n        - Formata√ß√£o e estilo consistentes\n\n        DIRETRIZES:\n        - Use sua capacidade nativa de tradu√ß√£o multilingue\n        - Mantenha o tom e estilo do texto original\n        - Para textos t√©cnicos, preserve terminologia espec√≠fica\n        - Para textos criativos, adapte culturalmente quando necess√°rio\n        - Se o idioma de destino n√£o for especificado, pergunte\n\n        FORMATO DE RESPOSTA:\n        - Retorne apenas a tradu√ß√£o solicitada\n        - Seja preciso e fluente\n        - Mantenha formata√ß√£o original (markdown, etc.)\n\n        EXEMPLOS:\n        Input: \"Translate 'Hello world' to Portuguese\"\n        Output: \"Ol√° mundo\"\n\n        Input: \"Traduzir 'Bom dia' para ingl√™s\"\n        Output: \"Good morning\"\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": "Traduza 'Hello' para pt-BR"
  }
]
Tools:
[]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

DEBUG    openai.agents:litellm_model.py:112 LLM resp:
{
  "content": "Ol√°",
  "role": "assistant",
  "tool_calls": null,
  "function_call": null
}

DEBUG    openai.agents:scope.py:48 Resetting current trace
INFO     src.voxy_agents.utils.test_subagents:test_subagents.py:411
_______ TestVisionAgentFlow.test_analyze_image_returns_structured_result _______

self = <tests.test_vision_flow_corrections.TestVisionAgentFlow object at 0x7268743cae10>

    @pytest.mark.asyncio
    async def test_analyze_image_returns_structured_result(self):
        """Verify analyze_image returns VisionAnalysisResult."""
        from src.voxy_agents.core.subagents.vision_agent import VisionAgent
    
        vision_agent = VisionAgent()
    
        # Mock GPT-5 API call
        with patch.object(
>           vision_agent.client.chat.completions,
            ^^^^^^^^^^^^^^^^^^^
            "create",
            new_callable=AsyncMock,
        ) as mock_create:
E       AttributeError: 'VisionAgent' object has no attribute 'client'

tests/test_vision_flow_corrections.py:67: AttributeError
----------------------------- Captured stdout call -----------------------------
[32m2025-10-15 04:01:21.964[0m | [1mINFO    [0m | [36mVISION_AGENT|INIT[0m | Vision Agent initialized
____________ TestVisionAgentFlow.test_analyze_image_error_handling _____________

self = <tests.test_vision_flow_corrections.TestVisionAgentFlow object at 0x7268743cb0e0>

    @pytest.mark.asyncio
    async def test_analyze_image_error_handling(self):
        """Verify analyze_image returns error structure on failure."""
        from src.voxy_agents.core.subagents.vision_agent import VisionAgent
    
        vision_agent = VisionAgent()
    
        # Mock API failure
        with patch.object(
>           vision_agent.client.chat.completions,
            ^^^^^^^^^^^^^^^^^^^
            "create",
            new_callable=AsyncMock,
            side_effect=Exception("API Error"),
        ):
E       AttributeError: 'VisionAgent' object has no attribute 'client'

tests/test_vision_flow_corrections.py:103: AttributeError
----------------------------- Captured stdout call -----------------------------
[32m2025-10-15 04:01:21.999[0m | [1mINFO    [0m | [36mVISION_AGENT|INIT[0m | Vision Agent initialized
_________________ TestToolsUsedMetadata.test_path_1_tools_used _________________

self = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x7268663ed220>
message = 'analyze this image', user_id = 'test_user', session_id = None
image_url = 'https://example.com/test.jpg'

    async def chat(
        self,
        message: str,
        user_id: str,
        session_id: Optional[str] = None,
        image_url: Optional[str] = None,
    ) -> tuple[str, dict[str, Any]]:
        """
        Main chat interface with Agents SDK Bypass for Vision Agent to eliminate 37s overhead.
    
        Args:
            message: User's message
            user_id: User identifier for session management
            session_id: Optional session ID (will be generated if not provided)
            image_url: Optional image URL for vision analysis with GPT-5
    
        Returns:
            Tuple of (response_text, metadata) where metadata includes agent_type, tools_used, and vision metadata
        """
        # Generate trace ID for end-to-end request tracking
        import uuid
        trace_id = str(uuid.uuid4())[:8]
    
        # Ensure VOXY agent is initialized
        self._initialize_voxy_agent()
    
        start_time = datetime.now()
    
        try:
            # Log request with trace ID
            if image_url:
                logger.info(
                    f"üì® [REQUEST:{trace_id}] Vision query received\n"
                    f"   ‚îú‚îÄ üë§ User: {user_id[:8]}...\n"
                    f"   ‚îú‚îÄ üñºÔ∏è  Image: {image_url[:80] if image_url else 'None'}{'...' if image_url and len(image_url) > 80 else ''}\n"
                    f"   ‚îî‚îÄ üí¨ Query: \"{message[:80]}{'...' if len(message) > 80 else ''}\""
                )
            else:
                logger.info(
                    f"üì® [REQUEST:{trace_id}] Chat message received\n"
                    f"   ‚îú‚îÄ üë§ User: {user_id[:8]}...\n"
                    f"   ‚îî‚îÄ üí¨ Message: \"{message[:80]}{'...' if len(message) > 80 else ''}\""
                )
    
            # Create or get session ID (use UUID format for Supabase compatibility)
            if session_id:
                actual_session_id = session_id
            else:
                import uuid
    
                # Generate a deterministic UUID for this user
                actual_session_id = str(
                    uuid.uuid5(uuid.NAMESPACE_DNS, f"voxy.session.{user_id}")
                )
    
            # Create SupabaseSession for automatic context management
            session = SupabaseSession(session_id=actual_session_id, user_id=user_id)
    
            # üñºÔ∏è VISION AGENT - GPT-5 multimodal analysis with lightweight post-processing
            if image_url and self._is_vision_request(message):
                logger.bind(event="VOXY_ORCHESTRATOR|VISION_PATH1").info("PATH 1: Vision bypass with lightweight post-processing")
    
                try:
                    # Determine analysis type and detail level from message
                    analysis_type = self._determine_analysis_type(message)
                    detail_level = self._determine_detail_level(message)
    
                    # Use Vision Agent directly for technical analysis
                    vision_agent = get_vision_agent()
                    vision_result = await vision_agent.analyze_image(
                        image_url=image_url,
                        query=message,
                        analysis_type=analysis_type,
                        detail_level=detail_level,
                    )
    
                    if not vision_result.success:
                        raise Exception(vision_result.error)
    
                    # Log Vision Agent technical response
                    logger.info(
                        f"‚úÖ [TRACE:{trace_id}] Vision Agent analysis completed:\n"
                        f"   ‚îú‚îÄ üìù Response ({len(vision_result.analysis)} chars): {vision_result.analysis[:200]}{'...' if len(vision_result.analysis) > 200 else ''}\n"
                        f"   ‚îú‚îÄ üéØ Confidence: {vision_result.confidence:.1%}\n"
                        f"   ‚îú‚îÄ ü§ñ Model: {vision_result.metadata.get('model_used')}\n"
                        f"   ‚îú‚îÄ ‚è±Ô∏è  Time: {vision_result.metadata.get('processing_time', 0):.2f}s\n"
                        f"   ‚îî‚îÄ üí∞ Cost: ${vision_result.metadata.get('cost', 0):.4f}"
                    )
    
                    # Lightweight post-processing with GPT-4o-mini (adds ~1-2s)
                    # Feature flag: Can be disabled via ENABLE_VISION_POSTPROCESSING=false
                    if settings.enable_vision_postprocessing:
                        conversational_response = (
                            await self._conversationalize_vision_result(
                                vision_result, message
                            )
                        )
                        logger.info(
                            "‚ú® Post-processing enabled: Technical ‚Üí Conversational"
                        )
                    else:
                        # Legacy mode: Return raw analysis
                        conversational_response = vision_result.analysis
                        logger.info(
                            "‚ö†Ô∏è  Post-processing DISABLED: Returning raw analysis"
                        )
    
                    total_processing_time = (datetime.now() - start_time).total_seconds()
                    self.request_count += 1
    
                    metadata = {
                        "agent_type": "vision",
                        "tools_used": ["vision_agent"],
                        "processing_time": total_processing_time,
                        "vision_analysis_time": vision_result.metadata.get(
                            "processing_time", 0
                        ),
                        "conversationalization_time": total_processing_time
                        - vision_result.metadata.get("processing_time", 0),
                        "request_count": self.request_count,
                        "session_id": actual_session_id,
                        "user_id": user_id,
                        "multimodal": True,
                        "confidence": vision_result.confidence,
                        "model_used": vision_result.metadata.get("model_used"),
                        "cost": vision_result.metadata.get("cost", 0),
                        "cache_hit": vision_result.metadata.get("cache_hit", False),
                    }
    
                    logger.info(
                        f"‚ö° [TRACE:{trace_id}] PATH 1 completed in {total_processing_time:.2f}s "
                        f"(vision: {vision_result.metadata.get('processing_time', 0):.1f}s + "
                        f"conversationalization: {metadata['conversationalization_time']:.1f}s)"
                    )
    
                    return conversational_response, metadata
    
                except Exception as vision_error:
                    logger.bind(event="VOXY_ORCHESTRATOR|VISION_PATH1_ERROR").error(
                        "PATH 1 failed, falling back to PATH 2",
                        error=str(vision_error)
                    )
                    # Fallback to PATH 2 (VOXY decision) by clearing image_url
                    image_url = None
    
            # Prepare message with image support for Vision Agent
            processed_message = message
            if image_url:
                # Detect if this is a simple analysis for optimization
                simple_keywords = [
                    "emoji",
                    "que",
                    "o que",
                    "identifique",
                    "qual",
                    "simples",
                ]
                is_simple_analysis = any(
                    keyword in message.lower() for keyword in simple_keywords
                )
    
                if is_simple_analysis:
                    processed_message = f"[AN√ÅLISE R√ÅPIDA] {message}\n\n[IMAGEM PARA AN√ÅLISE]: {image_url}"
                    logger.info("‚ö° Simple analysis detected for optimization")
                else:
                    processed_message = (
                        f"{message}\n\n[IMAGEM PARA AN√ÅLISE]: {image_url}"
                    )
    
                logger.bind(event="VOXY_ORCHESTRATOR|IMAGE_ANALYSIS").info(
                    "Image analysis requested",
                    image_url=image_url[:100],
                    message=processed_message[:100]
                )
            else:
                logger.bind(event="VOXY_ORCHESTRATOR|TEXT_ONLY").debug("No image URL provided", message=message[:100])
    
            # üß† Enable reasoning capture from SDK logs (backward compatibility)
            from voxy_agents.utils.reasoning_capture import enable_reasoning_capture, clear_reasoning
            clear_reasoning()  # Clear any previous reasoning
            enable_reasoning_capture()
    
            # üåü Clear universal reasoning capture buffer
            from voxy_agents.utils.universal_reasoning_capture import clear_reasoning as clear_universal_reasoning
            clear_universal_reasoning()
    
            # Use OpenAI Agents SDK v0.2.8 with automatic session management
            # TODO: Pass reasoning_params to Runner once SDK supports it
            # For now, reasoning params are configured at model level via LiteLLM
>           result = await Runner.run(
                self.voxy_agent,
                processed_message,
                session=session,  # ‚úÖ Session support restored in v0.2.8!
            )

src/voxy_agents/core/voxy_orchestrator.py:843: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/agents/run.py:237: in run
    return await runner.run(
.venv/lib/python3.12/site-packages/agents/run.py:443: in run
    input_guardrail_results, turn_result = await asyncio.gather(
/usr/lib/python3.12/asyncio/tasks.py:385: in __wakeup
    future.result()
/usr/lib/python3.12/asyncio/tasks.py:316: in __step_run_and_handle_result
    result = coro.throw(exc)
             ^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/agents/run.py:1036: in _run_single_turn
    new_response = await cls._get_new_response(
.venv/lib/python3.12/site-packages/agents/run.py:1256: in _get_new_response
    new_response = await model.get_response(
.venv/lib/python3.12/site-packages/agents/extensions/models/litellm_model.py:94: in get_response
    response = await self._fetch_response(
.venv/lib/python3.12/site-packages/agents/extensions/models/litellm_model.py:313: in _fetch_response
    ret = await litellm.acompletion(
.venv/lib/python3.12/site-packages/litellm/utils.py:1586: in wrapper_async
    raise e
.venv/lib/python3.12/site-packages/litellm/utils.py:1437: in wrapper_async
    result = await original_function(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/litellm/main.py:563: in acompletion
    raise exception_type(
.venv/lib/python3.12/site-packages/litellm/main.py:536: in acompletion
    init_response = await loop.run_in_executor(None, func_with_context)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/asyncio/futures.py:287: in __await__
    yield self  # This tells Task to wait for completion.
    ^^^^^^^^^^
/usr/lib/python3.12/asyncio/tasks.py:385: in __wakeup
    future.result()
/usr/lib/python3.12/asyncio/futures.py:203: in result
    raise self._exception.with_traceback(self._exception_tb)
/usr/lib/python3.12/concurrent/futures/thread.py:58: in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/litellm/utils.py:1060: in wrapper
    result = original_function(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/litellm/main.py:3525: in completion
    raise exception_type(
.venv/lib/python3.12/site-packages/litellm/main.py:1246: in completion
    optional_params = get_optional_params(
.venv/lib/python3.12/site-packages/litellm/utils.py:3357: in get_optional_params
    _check_valid_arg(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

supported_params = ['frequency_penalty', 'logit_bias', 'logprobs', 'top_logprobs', 'max_tokens', 'max_completion_tokens', ...]

    def _check_valid_arg(supported_params: List[str]):
        """
        Check if the params passed to completion() are supported by the provider
    
        Args:
            supported_params: List[str] - supported params from the litellm config
        """
        verbose_logger.info(
            f"\nLiteLLM completion() model= {model}; provider = {custom_llm_provider}"
        )
        verbose_logger.debug(
            f"\nLiteLLM: Params passed to completion() {passed_params}"
        )
        verbose_logger.debug(
            f"\nLiteLLM: Non-Default params passed to completion() {non_default_params}"
        )
        unsupported_params = {}
        for k in non_default_params.keys():
            if k not in supported_params:
                if k == "user" or k == "stream_options" or k == "stream":
                    continue
                if k == "n" and n == 1:  # langchain sends n=1 as a default value
                    continue  # skip this param
                if (
                    k == "max_retries"
                ):  # TODO: This is a patch. We support max retries for OpenAI, Azure. For non OpenAI LLMs we need to add support for max retries
                    continue  # skip this param
                # Always keeps this in elif code blocks
                else:
                    unsupported_params[k] = non_default_params[k]
    
        if unsupported_params:
            if litellm.drop_params is True or (
                drop_params is not None and drop_params is True
            ):
                for k in unsupported_params.keys():
                    non_default_params.pop(k, None)
            else:
>               raise UnsupportedParamsError(
                    status_code=500,
                    message=f"{custom_llm_provider} does not support parameters: {list(unsupported_params.keys())}, for model={model}. To drop these, set `litellm.drop_params=True` or for proxy:\n\n`litellm_settings:\n drop_params: true`\n. \n If you want to use these params dynamically send allowed_openai_params={list(unsupported_params.keys())} in your request.",
                )
E               litellm.exceptions.UnsupportedParamsError: litellm.UnsupportedParamsError: openrouter does not support parameters: ['thinking'], for model=anthropic/claude-sonnet-4.5. To drop these, set `litellm.drop_params=True` or for proxy:
E               
E               `litellm_settings:
E                drop_params: true`
E               . 
E                If you want to use these params dynamically send allowed_openai_params=['thinking'] in your request.

.venv/lib/python3.12/site-packages/litellm/utils.py:3340: UnsupportedParamsError

During handling of the above exception, another exception occurred:

self = <tests.test_vision_flow_corrections.TestToolsUsedMetadata object at 0x7268743ca360>

    @pytest.mark.asyncio
    async def test_path_1_tools_used(self):
        """Verify PATH 1 includes tools_used=['vision_agent']."""
        orchestrator = VoxyOrchestrator()
    
        vision_result = VisionAnalysisResult(
            success=True,
            analysis="Analysis result",
            confidence=0.95,
            metadata={"model_used": "gpt-5", "processing_time": 7.0},
        )
    
        with patch(
            "src.voxy_agents.core.voxy_orchestrator.get_vision_agent"
        ) as mock_get_vision:
            mock_vision_agent = AsyncMock()
            mock_vision_agent.analyze_image.return_value = vision_result
            mock_get_vision.return_value = mock_vision_agent
    
            with patch.object(
                orchestrator,
                "_conversationalize_vision_result",
                new_callable=AsyncMock,
                return_value="Conversational response",
            ):
                _, metadata = await orchestrator.chat(
                    message="analyze this image",
                    user_id="test_user",
                    image_url="https://example.com/test.jpg",
                )
    
                # Validate tools_used
                assert "tools_used" in metadata
>               assert metadata["tools_used"] == ["vision_agent"]
E               AssertionError: assert [] == ['vision_agent']
E                 
E                 Right contains one more item: 'vision_agent'
E                 Use -v to get more diff

tests/test_vision_flow_corrections.py:252: AssertionError
----------------------------- Captured stdout call -----------------------------
[32m2025-10-15 04:01:26.691[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Creating LiteLLM model: openrouter/anthropic/claude-sonnet-4.5 (max_tokens=4000, temperature=0.3)
[32m2025-10-15 04:01:26.692[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | ‚úì LiteLLM model created successfully: openrouter/anthropic/claude-sonnet-4.5
[32m2025-10-15 04:01:26.692[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: ['thinking']
[32m2025-10-15 04:01:26.692[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:26.692[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.core.guardrails.safety_check[0m | Safety checker initialized
[32m2025-10-15 04:01:26.715[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 24.2ms
[32m2025-10-15 04:01:26.719[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|MODEL_SETTINGS[0m | ModelSettings configured with reasoning params
[32m2025-10-15 04:01:26.719[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|AGENT_INIT[0m | VOXY agent initialized:
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Provider: openrouter
   ‚îú‚îÄ Max tokens: 4000
   ‚îú‚îÄ Temperature: 0.3
   ‚îú‚îÄ Reasoning: enabled
   ‚îî‚îÄ Tools: 2 registered
[32m2025-10-15 04:01:26.719[0m | [1mINFO    [0m | [36mGENERAL[0m | üì® [REQUEST:ab35606e] Vision query received
   ‚îú‚îÄ üë§ User: test_use...
   ‚îú‚îÄ üñºÔ∏è  Image: https://example.com/test.jpg
   ‚îî‚îÄ üí¨ Query: "analyze this image"
[32m2025-10-15 04:01:26.720[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|IMAGE_ANALYSIS[0m | Image analysis requested
[32m2025-10-15 04:01:26.765[0m | [34m[1mDEBUG   [0m | [36mREASONING_CAPTURE|ENABLED[0m | Reasoning capture sink enabled
[32m2025-10-15 04:01:26.784[0m | [1mINFO    [0m | [36mUNIVERSAL_REASONING|INIT[0m | Universal reasoning capture initialized with 4 extractors
[32m2025-10-15 04:01:26.784[0m | [34m[1mDEBUG   [0m | [36mUNIVERSAL_REASONING|CLEAR[0m | Cleared 0 reasoning entries from buffer
[32m2025-10-15 04:01:26.784[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.core.database.supabase_integration[0m | üîç Checking session exists: session_id=2c6c81e4-b4ca-5c4b-89fd-0a1a639d79be, type=<class 'str'>
[32m2025-10-15 04:01:26.919[0m | [31m[1mERROR   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.core.database.supabase_integration[0m | Error ensuring session exists: {'message': 'invalid input syntax for type uuid: "test_user"', 'code': '22P02', 'hint': None, 'details': None}
[32m2025-10-15 04:01:26.920[0m | [31m[1mERROR   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.core.database.supabase_integration[0m | üö® Debug info - session_id: '2c6c81e4-b4ca-5c4b-89fd-0a1a639d79be', user_id: 'test_user'
[32m2025-10-15 04:01:26.934[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating trace Agent workflow with id trace_775456afab1a479abe933e6074010ba0
[32m2025-10-15 04:01:26.934[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Setting current trace: trace_775456afab1a479abe933e6074010ba0
[32m2025-10-15 04:01:26.935[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.AgentSpanData object at 0x726864ceba20> with id None
[32m2025-10-15 04:01:26.935[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Running agent VOXY (turn 1)
[32m2025-10-15 04:01:26.935[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Creating span <agents.tracing.span_data.GenerationSpanData object at 0x7268650c3d70> with id None
[32m2025-10-15 04:01:26.936[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Calling Litellm model: openrouter/anthropic/claude-sonnet-4.5
[
  {
    "content": "\n        Voc√™ √© o VOXY, agente principal que orquestra subagentes especializados.\n\n        ARQUITETURA (Implementando Hybrid Context-Aware Weighted System):\n        - Analise cada solicita√ß√£o cuidadosamente para identificar tarefas espec√≠ficas\n        - Use subagentes especializados quando necess√°rio via tool calls\n        - Voc√™ pode usar m√∫ltiplos subagentes na mesma resposta\n        - Sempre compile os resultados em uma resposta coerente e √∫til\n        - O usu√°rio s√≥ fala com voc√™ - voc√™ √© o √∫nico ponto de contato\n\n        SUBAGENTES DISPON√çVEIS:\n        - translate_text: Para tradu√ß√£o entre idiomas (capacidade nativa)\n        - correct_text: Para corre√ß√£o ortogr√°fica e gramatical (capacidade nativa)\n        - get_weather: Para informa√ß√µes meteorol√≥gicas (via APIs)\n        - calculate: Para c√°lculos matem√°ticos (capacidade nativa)\n        - analyze_image: Para an√°lise avan√ßada de imagens usando GPT-5 multimodal\n        - web_search: Para busca na web (quando necess√°rio)\n\n        INSTRU√á√ïES ESPECIAIS PARA AN√ÅLISE DE IMAGEM:\n        - Quando a mensagem cont√©m \"[IMAGEM PARA AN√ÅLISE]: {URL}\", extraia a URL\n        - Use analyze_image(image_url=\"URL_EXTRAIDA\", query=\"QUERY_DO_USUARIO\") APENAS UMA VEZ\n        - NUNCA chame analyze_image m√∫ltiplas vezes para a mesma imagem\n        - A URL sempre aparece ap√≥s \"[IMAGEM PARA AN√ÅLISE]: \" na mensagem\n        - Exemplo: Se a mensagem for \"que emoji √© este?\n\n[IMAGEM PARA AN√ÅLISE]: https://...\",\n          use analyze_image(image_url=\"https://...\", query=\"que emoji √© este?\") UMA √öNICA VEZ\n        - IMPORTANTE: Ap√≥s receber o resultado da an√°lise, responda diretamente sem chamar a fun√ß√£o novamente\n        - O Vision Agent usa GPT-5 multimodal para an√°lise avan√ßada\n\n        OTIMIZA√á√ÉO (Dynamic Complexity Scoring):\n        - Use subagentes especializados para tarefas espec√≠ficas (mais eficiente)\n        - Para consultas gerais, responda diretamente quando apropriado\n        - Combine m√∫ltiplas ferramentas quando a tarefa √© complexa\n        - Mantenha o contexto da conversa para respostas inteligentes\n\n        RECOVERY STRATEGY (Multi-Level Context-Aware):\n        - Se um subagente falhar, continue com outros ou responda diretamente\n        - Sempre forne√ßa uma resposta √∫til mesmo com falhas parciais\n        - Informe sobre limita√ß√µes quando relevante\n\n        EXPERI√äNCIA DO USU√ÅRIO:\n        - Seja natural, conversacional e prestativo\n        - Integre resultados de forma transparente\n        - Mantenha consist√™ncia na personalidade VOXY\n        - Responda em portugu√™s brasileiro por padr√£o\n\n        IMPORTANTE: Para an√°lise de imagens, SEMPRE extraia a URL ap√≥s \"[IMAGEM PARA AN√ÅLISE]: \"\n        e passe como par√¢metro image_url para a fun√ß√£o analyze_image_independent.\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": "analyze this image\n\n[IMAGEM PARA AN√ÅLISE]: https://example.com/test.jpg"
  }
]
Tools:
[
  {
    "type": "function",
    "function": {
      "name": "analyze_image",
      "description": "An√°lise avan√ßada de imagens usando GPT-5 multimodal.",
      "parameters": {
        "properties": {
          "image_url": {
            "description": "URL da imagem para an√°lise",
            "title": "Image Url",
            "type": "string"
          },
          "analysis_type": {
            "default": "general",
            "description": "Tipo de an√°lise (general, ocr, technical, artistic, document)",
            "title": "Analysis Type",
            "type": "string"
          },
          "detail_level": {
            "default": "standard",
            "description": "N√≠vel de detalhe (basic, standard, detailed, comprehensive)",
            "title": "Detail Level",
            "type": "string"
          },
          "specific_questions": {
            "anyOf": [
              {
                "items": {
                  "type": "string"
                },
                "type": "array"
              },
              {
                "type": "null"
              }
            ],
            "description": "Lista de perguntas espec√≠ficas sobre a imagem",
            "title": "Specific Questions"
          },
          "query": {
            "default": "Analise esta imagem",
            "description": "Query do usu√°rio sobre a imagem",
            "title": "Query",
            "type": "string"
          }
        },
        "required": [
          "image_url",
          "analysis_type",
          "detail_level",
          "specific_questions",
          "query"
        ],
        "title": "analyze_image_args",
        "type": "object",
        "additionalProperties": false
      }
    }
  },
  {
    "type": "function",
    "function": {
      "name": "web_search",
      "description": "Search the web for current information.",
      "parameters": {
        "properties": {
          "query": {
            "title": "Query",
            "type": "string"
          }
        },
        "required": [
          "query"
        ],
        "title": "web_search_args",
        "type": "object",
        "additionalProperties": false
      }
    }
  }
]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

[32m2025-10-15 04:01:27.018[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | Resetting current trace
[32m2025-10-15 04:01:27.018[0m | [31m[1mERROR   [0m | [36mVOXY_ORCHESTRATOR|ERROR[0m | Error processing request
------------------------------ Captured log call -------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:55 Creating LiteLLM model: openrouter/anthropic/claude-sonnet-4.5 (max_tokens=4000, temperature=0.3)
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:67 ‚úì LiteLLM model created successfully: openrouter/anthropic/claude-sonnet-4.5
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: ['thinking']
INFO     src.voxy_agents.core.guardrails.safety_check:safety_check.py:25 Safety checker initialized
DEBUG    src.voxy_agents.core.database.supabase_integration:supabase_integration.py:430 üîç Checking session exists: session_id=2c6c81e4-b4ca-5c4b-89fd-0a1a639d79be, type=<class 'str'>
ERROR    src.voxy_agents.core.database.supabase_integration:supabase_integration.py:470 Error ensuring session exists: {'message': 'invalid input syntax for type uuid: "test_user"', 'code': '22P02', 'hint': None, 'details': None}
ERROR    src.voxy_agents.core.database.supabase_integration:supabase_integration.py:471 üö® Debug info - session_id: '2c6c81e4-b4ca-5c4b-89fd-0a1a639d79be', user_id: 'test_user'
DEBUG    openai.agents:provider.py:239 Creating trace Agent workflow with id trace_775456afab1a479abe933e6074010ba0
DEBUG    openai.agents:scope.py:43 Setting current trace: trace_775456afab1a479abe933e6074010ba0
DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.AgentSpanData object at 0x726864ceba20> with id None
DEBUG    openai.agents:run.py:438 Running agent VOXY (turn 1)
DEBUG    openai.agents:provider.py:294 Creating span <agents.tracing.span_data.GenerationSpanData object at 0x7268650c3d70> with id None
DEBUG    openai.agents:litellm_model.py:286 Calling Litellm model: openrouter/anthropic/claude-sonnet-4.5
[
  {
    "content": "\n        Voc√™ √© o VOXY, agente principal que orquestra subagentes especializados.\n\n        ARQUITETURA (Implementando Hybrid Context-Aware Weighted System):\n        - Analise cada solicita√ß√£o cuidadosamente para identificar tarefas espec√≠ficas\n        - Use subagentes especializados quando necess√°rio via tool calls\n        - Voc√™ pode usar m√∫ltiplos subagentes na mesma resposta\n        - Sempre compile os resultados em uma resposta coerente e √∫til\n        - O usu√°rio s√≥ fala com voc√™ - voc√™ √© o √∫nico ponto de contato\n\n        SUBAGENTES DISPON√çVEIS:\n        - translate_text: Para tradu√ß√£o entre idiomas (capacidade nativa)\n        - correct_text: Para corre√ß√£o ortogr√°fica e gramatical (capacidade nativa)\n        - get_weather: Para informa√ß√µes meteorol√≥gicas (via APIs)\n        - calculate: Para c√°lculos matem√°ticos (capacidade nativa)\n        - analyze_image: Para an√°lise avan√ßada de imagens usando GPT-5 multimodal\n        - web_search: Para busca na web (quando necess√°rio)\n\n        INSTRU√á√ïES ESPECIAIS PARA AN√ÅLISE DE IMAGEM:\n        - Quando a mensagem cont√©m \"[IMAGEM PARA AN√ÅLISE]: {URL}\", extraia a URL\n        - Use analyze_image(image_url=\"URL_EXTRAIDA\", query=\"QUERY_DO_USUARIO\") APENAS UMA VEZ\n        - NUNCA chame analyze_image m√∫ltiplas vezes para a mesma imagem\n        - A URL sempre aparece ap√≥s \"[IMAGEM PARA AN√ÅLISE]: \" na mensagem\n        - Exemplo: Se a mensagem for \"que emoji √© este?\n\n[IMAGEM PARA AN√ÅLISE]: https://...\",\n          use analyze_image(image_url=\"https://...\", query=\"que emoji √© este?\") UMA √öNICA VEZ\n        - IMPORTANTE: Ap√≥s receber o resultado da an√°lise, responda diretamente sem chamar a fun√ß√£o novamente\n        - O Vision Agent usa GPT-5 multimodal para an√°lise avan√ßada\n\n        OTIMIZA√á√ÉO (Dynamic Complexity Scoring):\n        - Use subagentes especializados para tarefas espec√≠ficas (mais eficiente)\n        - Para consultas gerais, responda diretamente quando apropriado\n        - Combine m√∫ltiplas ferramentas quando a tarefa √© complexa\n        - Mantenha o contexto da conversa para respostas inteligentes\n\n        RECOVERY STRATEGY (Multi-Level Context-Aware):\n        - Se um subagente falhar, continue com outros ou responda diretamente\n        - Sempre forne√ßa uma resposta √∫til mesmo com falhas parciais\n        - Informe sobre limita√ß√µes quando relevante\n\n        EXPERI√äNCIA DO USU√ÅRIO:\n        - Seja natural, conversacional e prestativo\n        - Integre resultados de forma transparente\n        - Mantenha consist√™ncia na personalidade VOXY\n        - Responda em portugu√™s brasileiro por padr√£o\n\n        IMPORTANTE: Para an√°lise de imagens, SEMPRE extraia a URL ap√≥s \"[IMAGEM PARA AN√ÅLISE]: \"\n        e passe como par√¢metro image_url para a fun√ß√£o analyze_image_independent.\n        ",
    "role": "system"
  },
  {
    "role": "user",
    "content": "analyze this image\n\n[IMAGEM PARA AN√ÅLISE]: https://example.com/test.jpg"
  }
]
Tools:
[
  {
    "type": "function",
    "function": {
      "name": "analyze_image",
      "description": "An√°lise avan√ßada de imagens usando GPT-5 multimodal.",
      "parameters": {
        "properties": {
          "image_url": {
            "description": "URL da imagem para an√°lise",
            "title": "Image Url",
            "type": "string"
          },
          "analysis_type": {
            "default": "general",
            "description": "Tipo de an√°lise (general, ocr, technical, artistic, document)",
            "title": "Analysis Type",
            "type": "string"
          },
          "detail_level": {
            "default": "standard",
            "description": "N√≠vel de detalhe (basic, standard, detailed, comprehensive)",
            "title": "Detail Level",
            "type": "string"
          },
          "specific_questions": {
            "anyOf": [
              {
                "items": {
                  "type": "string"
                },
                "type": "array"
              },
              {
                "type": "null"
              }
            ],
            "description": "Lista de perguntas espec√≠ficas sobre a imagem",
            "title": "Specific Questions"
          },
          "query": {
            "default": "Analise esta imagem",
            "description": "Query do usu√°rio sobre a imagem",
            "title": "Query",
            "type": "string"
          }
        },
        "required": [
          "image_url",
          "analysis_type",
          "detail_level",
          "specific_questions",
          "query"
        ],
        "title": "analyze_image_args",
        "type": "object",
        "additionalProperties": false
      }
    }
  },
  {
    "type": "function",
    "function": {
      "name": "web_search",
      "description": "Search the web for current information.",
      "parameters": {
        "properties": {
          "query": {
            "title": "Query",
            "type": "string"
          }
        },
        "required": [
          "query"
        ],
        "title": "web_search_args",
        "type": "object",
        "additionalProperties": false
      }
    }
  }
]
Stream: False
Tool choice: NOT_GIVEN
Response format: NOT_GIVEN

DEBUG    openai.agents:scope.py:48 Resetting current trace
______________________ TestAuthRoutes.test_login_success _______________________

self = <test_auth.TestAuthRoutes object at 0x7268741f34d0>
mock_get_client = <MagicMock name='get_supabase_client' id='125792467067312'>
client = <starlette.testclient.TestClient object at 0x726864633a10>
mock_supabase_auth_success = <MagicMock name='get_supabase_client().auth.sign_in_with_password()' id='125792686390736'>

    @patch("src.voxy_agents.api.routes.auth.get_supabase_client")
    def test_login_success(self, mock_get_client, client, mock_supabase_auth_success):
        """Test successful login."""
        # Setup mock
        mock_supabase = MagicMock()
        mock_supabase.auth.sign_in_with_password.return_value = (
            mock_supabase_auth_success
        )
        mock_get_client.return_value = mock_supabase
    
        # Test login
        response = client.post(
            "/auth/login",
            data={"username": "test@example.com", "password": "password123"},
        )
    
        assert response.status_code == 200
        data = response.json()
    
        # Verify response structure
>       assert data["access_token"] == "jwt-token-123"
E       AssertionError: assert 'eyJhbGciOiJI...IPvx7f6MGkMVc' == 'jwt-token-123'
E         
E         - jwt-token-123
E         + eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyLTEyMyIsImVtYWlsIjoidGVzdEBleGFtcGxlLmNvbSIsInJvbGUiOiJhdXRoZW50aWNhdGVkIiwiYXVkIjoiYXV0aGVudGljYXRlZCIsImlzcyI6InZveHktYWdlbnRzIiwiaWF0IjoxNzYwNDkzNjg4LCJleHAiOjE3NjA1ODAwODgsImp0aSI6IjMyNzIyNmYwLWNmYWItNDYxYS1hYzUzLWYxZDNkNWZlMDA1NSIsInVzZXJfbWV0YWRhdGEiOnsibmFtZSI6IlRlc3QgVXNlciJ9fQ.pOno5t_MRFpsrMwl06PhU3PFSOubXiIPvx7f6MGkMVc

tests/test_voxy_agents/test_api/test_routes/test_auth.py:82: AssertionError
----------------------------- Captured stdout call -----------------------------
[32m2025-10-15 04:01:28.273[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34masyncio[0m | Using selector: EpollSelector
[32m2025-10-15 04:01:28.275[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mpython_multipart.multipart[0m | Calling on_field_start with no data
[32m2025-10-15 04:01:28.275[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mpython_multipart.multipart[0m | Calling on_field_name with data[0:8]
[32m2025-10-15 04:01:28.275[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mpython_multipart.multipart[0m | Calling on_field_data with data[9:27]
[32m2025-10-15 04:01:28.275[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mpython_multipart.multipart[0m | Calling on_field_end with no data
[32m2025-10-15 04:01:28.275[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mpython_multipart.multipart[0m | Calling on_field_start with no data
[32m2025-10-15 04:01:28.276[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mpython_multipart.multipart[0m | Calling on_field_name with data[28:36]
[32m2025-10-15 04:01:28.276[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mpython_multipart.multipart[0m | Calling on_field_data with data[37:48]
[32m2025-10-15 04:01:28.276[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mpython_multipart.multipart[0m | Calling on_field_end with no data
[32m2025-10-15 04:01:28.276[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34mpython_multipart.multipart[0m | Calling on_end with no data
üîê Created token with JTI: 327226f0-cfab-461a-ac53-f1d3d5fe0055 for user: test@example.com
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
DEBUG    python_multipart.multipart:multipart.py:628 Calling on_field_start with no data
DEBUG    python_multipart.multipart:multipart.py:625 Calling on_field_name with data[0:8]
DEBUG    python_multipart.multipart:multipart.py:625 Calling on_field_data with data[9:27]
DEBUG    python_multipart.multipart:multipart.py:628 Calling on_field_end with no data
DEBUG    python_multipart.multipart:multipart.py:628 Calling on_field_start with no data
DEBUG    python_multipart.multipart:multipart.py:625 Calling on_field_name with data[28:36]
DEBUG    python_multipart.multipart:multipart.py:625 Calling on_field_data with data[37:48]
DEBUG    python_multipart.multipart:multipart.py:628 Calling on_field_end with no data
DEBUG    python_multipart.multipart:multipart.py:628 Calling on_end with no data
______________________ TestAuthRoutes.test_signup_success ______________________

self = <test_auth.TestAuthRoutes object at 0x7268741f2c30>
mock_get_client = <MagicMock name='get_supabase_client' id='125792467655840'>
client = <starlette.testclient.TestClient object at 0x726857515370>
mock_supabase_auth_success = <MagicMock name='get_supabase_client().auth.sign_up()' id='125792467121504'>

    @patch("src.voxy_agents.api.routes.auth.get_supabase_client")
    def test_signup_success(self, mock_get_client, client, mock_supabase_auth_success):
        """Test successful signup."""
        # Setup mock
        mock_supabase = MagicMock()
        mock_supabase.auth.sign_up.return_value = mock_supabase_auth_success
        mock_get_client.return_value = mock_supabase
    
        # Test signup
        signup_data = {
            "email": "newuser@example.com",
            "password": "newpassword123",
            "full_name": "New User",
        }
    
        response = client.post("/auth/signup", json=signup_data)
    
        assert response.status_code == 200
        data = response.json()
    
        # Verify response structure
>       assert data["access_token"] == "jwt-token-123"
E       AssertionError: assert 'eyJhbGciOiJI...L-Kcq4-bxwLjc' == 'jwt-token-123'
E         
E         - jwt-token-123
E         + eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyLTEyMyIsImVtYWlsIjoidGVzdEBleGFtcGxlLmNvbSIsInJvbGUiOiJhdXRoZW50aWNhdGVkIiwiYXVkIjoiYXV0aGVudGljYXRlZCIsImlzcyI6InZveHktYWdlbnRzIiwiaWF0IjoxNzYwNDkzNjg4LCJleHAiOjE3NjA1ODAwODgsImp0aSI6IjBiNzBjZGRmLTI4Y2UtNGE5ZS1hYjUzLTFlNzM1N2I4YTNhOSIsInVzZXJfbWV0YWRhdGEiOnsibmFtZSI6IlRlc3QgVXNlciJ9fQ.UIA0O-CNYoFdhGApS9zdjwDtE1zwbfL-Kcq4-bxwLjc

tests/test_voxy_agents/test_api/test_routes/test_auth.py:166: AssertionError
----------------------------- Captured stdout call -----------------------------
[32m2025-10-15 04:01:28.371[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34masyncio[0m | Using selector: EpollSelector
üîê Signup token with JTI: 0b70cddf-28ce-4a9e-ab53-1e7357b8a3a9 for user: test@example.com
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
_______________ TestJWTValidation.test_valid_token_verification ________________

self = <test_auth.TestJWTValidation object at 0x7268741f5df0>
mock_verify = <AsyncMock name='verify_token' id='125792467117904'>
valid_jwt_token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1c2VyLTEyMyIsImV4cCI6OTk5OTk5OTk5OX0.test'
mock_jwt_payload = {'email': 'test@example.com', 'exp': 9999999999, 'iat': 1642680000, 'role': 'authenticated', ...}

    @patch("src.voxy_agents.api.middleware.auth.verify_token")
    def test_valid_token_verification(
        self, mock_verify, valid_jwt_token, mock_jwt_payload
    ):
        """Test verification of valid JWT token."""
        # Return TokenData object instead of dict
        from src.voxy_agents.api.middleware.auth import TokenData
    
        mock_verify.return_value = TokenData(
            user_id="user-123", email="test@example.com"
        )
    
        # Import and test the auth middleware function
        from src.voxy_agents.api.middleware.auth import verify_token
    
        result = verify_token(valid_jwt_token)
    
>       assert result.user_id == "user-123"
               ^^^^^^^^^^^^^^
E       AttributeError: 'coroutine' object has no attribute 'user_id'

tests/test_voxy_agents/test_api/test_routes/test_auth.py:293: AttributeError
______________ TestJWTValidation.test_expired_token_verification _______________

self = <test_auth.TestJWTValidation object at 0x7268741f23f0>
mock_verify = <AsyncMock name='verify_token' id='125792467117856'>
expired_jwt_token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1c2VyLTEyMyIsImV4cCI6MTY0MjY4MDAwMH0.expired'

    @patch("src.voxy_agents.api.middleware.auth.verify_token")
    def test_expired_token_verification(self, mock_verify, expired_jwt_token):
        """Test verification of expired JWT token."""
        mock_verify.side_effect = HTTPException(
            status_code=401, detail="Token has expired"
        )
    
        from src.voxy_agents.api.middleware.auth import verify_token
    
>       with pytest.raises(HTTPException) as exc_info:
E       Failed: DID NOT RAISE <class 'fastapi.exceptions.HTTPException'>

tests/test_voxy_agents/test_api/test_routes/test_auth.py:305: Failed
______________ TestJWTValidation.test_invalid_token_verification _______________

self = <test_auth.TestJWTValidation object at 0x7268741f2f00>
mock_verify = <AsyncMock name='verify_token' id='125792467063040'>
invalid_jwt_token = 'invalid.jwt.token'

    @patch("src.voxy_agents.api.middleware.auth.verify_token")
    def test_invalid_token_verification(self, mock_verify, invalid_jwt_token):
        """Test verification of invalid JWT token."""
        mock_verify.side_effect = HTTPException(status_code=401, detail="Invalid token")
    
        from src.voxy_agents.api.middleware.auth import verify_token
    
>       with pytest.raises(HTTPException) as exc_info:
E       Failed: DID NOT RAISE <class 'fastapi.exceptions.HTTPException'>

tests/test_voxy_agents/test_api/test_routes/test_auth.py:318: Failed
_________________ TestJWTValidation.test_missing_token_header __________________

self = <test_auth.TestJWTValidation object at 0x7268741f5a60>
mock_verify = <AsyncMock name='verify_token' id='125792467061792'>

    @patch("src.voxy_agents.api.middleware.auth.verify_token")
    def test_missing_token_header(self, mock_verify):
        """Test verification with missing token."""
        mock_verify.side_effect = HTTPException(
            status_code=401, detail="Authorization header missing"
        )
    
        from src.voxy_agents.api.middleware.auth import verify_token
    
>       with pytest.raises(HTTPException) as exc_info:
E       Failed: DID NOT RAISE <class 'fastapi.exceptions.HTTPException'>

tests/test_voxy_agents/test_api/test_routes/test_auth.py:333: Failed
_________________ TestJWTValidation.test_malformed_auth_header _________________

self = <test_auth.TestJWTValidation object at 0x7268741f5c40>
mock_verify = <AsyncMock name='verify_token' id='125792467039680'>

    @patch("src.voxy_agents.api.middleware.auth.verify_token")
    def test_malformed_auth_header(self, mock_verify):
        """Test verification with malformed token."""
        mock_verify.side_effect = HTTPException(
            status_code=401, detail="Invalid token format"
        )
    
        from src.voxy_agents.api.middleware.auth import verify_token
    
>       with pytest.raises(HTTPException) as exc_info:
E       Failed: DID NOT RAISE <class 'fastapi.exceptions.HTTPException'>

tests/test_voxy_agents/test_api/test_routes/test_auth.py:347: Failed
______________ TestImageUploadEndpoint.test_upload_image_success _______________

self = <test_images.TestImageUploadEndpoint object at 0x7268677c8a70>
sample_image_data = b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\xc8\x00\x00\x00\xc8\x08\x02\x00\x00\x00":9\xc9\x00\x00\x02\x11IDATx\...00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
mock_current_user = <Mock id='125792467160480'>

    @pytest.mark.asyncio
    async def test_upload_image_success(self, sample_image_data, mock_current_user):
        """Test successful image upload."""
        # Mock Supabase client and operations
        mock_supabase = Mock()
        mock_storage = Mock()
        mock_table = Mock()
    
        # Mock storage upload
        mock_upload_result = Mock()
        mock_upload_result.status_code = 200
        mock_storage.from_().upload.return_value = mock_upload_result
        mock_storage.from_().get_public_url.return_value = (
            "https://example.com/image.png"
        )
    
        # Mock database insert
        mock_insert_result = Mock()
        mock_insert_result.data = [
            {
                "id": "img-123",
                "user_id": "test-user-123",
                "storage_path": "users/test-user-123/uploads/2024/01/test.png",
                "original_name": "test.png",
                "content_type": "image/png",
                "file_size": len(sample_image_data),
                "description": None,
                "tags": None,
                "is_public": False,
                "created_at": "2024-01-01T12:00:00Z",
                "updated_at": "2024-01-01T12:00:00Z",
            }
        ]
        mock_table.insert().execute.return_value = mock_insert_result
    
        mock_supabase.storage = mock_storage
        mock_supabase.table.return_value = mock_table
    
        # Mock file validation
        mock_validation_result = {
            "content": sample_image_data,
            "size": len(sample_image_data),
            "mime_type": "image/png",
            "filename": "test.png",
        }
    
        with patch(
            "src.voxy_agents.api.routes.images.get_supabase_client",
            return_value=mock_supabase,
        ):
            with patch(
                "src.voxy_agents.api.routes.images.validate_image_file",
                return_value=mock_validation_result,
            ):
                with patch(
                    "src.voxy_agents.api.routes.images.generate_storage_path",
                    return_value="users/test-user-123/uploads/2024/01/test.png",
                ):
                    from src.voxy_agents.api.routes.images import upload_image
    
                    # Create mock UploadFile
                    mock_file = Mock()
                    mock_file.content_type = "image/png"
                    mock_file.filename = "test.png"
    
                    result = await upload_image(
                        file=mock_file,
                        description=None,
                        tags=None,
                        public=False,
                        current_user=mock_current_user,
                    )
    
                    # Verify response
>                   assert result.id == "img-123"
E                   AssertionError: assert '21af4951-724...-214f285961d7' == 'img-123'
E                     
E                     - img-123
E                     + 21af4951-724e-4be6-93a5-214f285961d7

tests/test_voxy_agents/test_api/test_routes/test_images.py:266: AssertionError
----------------------------- Captured stdout call -----------------------------
[32m2025-10-15 04:01:28.747[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | üöÄ Starting upload for user test-user-123, path: users/test-user-123/uploads/2024/01/test.png
[32m2025-10-15 04:01:28.748[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | üì§ Upload result: <Mock name='mock.storage.from_().upload()' id='125792467160288'>
[32m2025-10-15 04:01:28.748[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | ‚úÖ Upload successful
[32m2025-10-15 04:01:28.748[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | üîó Generated file URL: https://example.com/image.png
[32m2025-10-15 04:01:28.748[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | üíæ Saving metadata to database: {'user_id': 'test-user-123', 'storage_path': 'users/test-user-123/uploads/2024/01/test.png', 'original_name': 'test.png', 'content_type': 'image/png', 'file_size': 1124, 'description': None, 'tags': None, 'is_public': False}
[32m2025-10-15 04:01:28.748[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | üìù Formatted data: {'user_id': 'test-user-123', 'storage_path': 'users/test-user-123/uploads/2024/01/test.png', 'original_name': 'test.png', 'content_type': 'image/png', 'file_size': 1124, 'description': None, 'tags': None, 'is_public': False}
[32m2025-10-15 04:01:28.799[0m | [31m[1mERROR   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | ‚ùå Database insert failed: {'message': 'invalid input syntax for type uuid: "test-user-123"', 'code': '22P02', 'hint': None, 'details': None}
[32m2025-10-15 04:01:28.800[0m | [33m[1mWARNING [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | ‚ö†Ô∏è Continuing without metadata save for testing
[32m2025-10-15 04:01:28.800[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | üìä Image record created: {'id': '21af4951-724e-4be6-93a5-214f285961d7', 'user_id': 'test-user-123', 'storage_path': 'users/test-user-123/uploads/2024/01/test.png', 'original_name': 'test.png', 'content_type': 'image/png', 'file_size': 1124, 'description': None, 'tags': None, 'is_public': False, 'created_at': '2025-10-15T02:01:28.800508+00:00'}
[32m2025-10-15 04:01:28.800[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | üéâ Upload completed successfully for user test-user-123
------------------------------ Captured log call -------------------------------
INFO     src.voxy_agents.api.routes.images:images.py:368 üöÄ Starting upload for user test-user-123, path: users/test-user-123/uploads/2024/01/test.png
INFO     src.voxy_agents.api.routes.images:images.py:381 üì§ Upload result: <Mock name='mock.storage.from_().upload()' id='125792467160288'>
INFO     src.voxy_agents.api.routes.images:images.py:385 ‚úÖ Upload successful
INFO     src.voxy_agents.api.routes.images:images.py:409 üîó Generated file URL: https://example.com/image.png
INFO     src.voxy_agents.api.routes.images:images.py:430 üíæ Saving metadata to database: {'user_id': 'test-user-123', 'storage_path': 'users/test-user-123/uploads/2024/01/test.png', 'original_name': 'test.png', 'content_type': 'image/png', 'file_size': 1124, 'description': None, 'tags': None, 'is_public': False}
INFO     src.voxy_agents.api.routes.images:images.py:446 üìù Formatted data: {'user_id': 'test-user-123', 'storage_path': 'users/test-user-123/uploads/2024/01/test.png', 'original_name': 'test.png', 'content_type': 'image/png', 'file_size': 1124, 'description': None, 'tags': None, 'is_public': False}
ERROR    src.voxy_agents.api.routes.images:images.py:454 ‚ùå Database insert failed: {'message': 'invalid input syntax for type uuid: "test-user-123"', 'code': '22P02', 'hint': None, 'details': None}
WARNING  src.voxy_agents.api.routes.images:images.py:456 ‚ö†Ô∏è Continuing without metadata save for testing
INFO     src.voxy_agents.api.routes.images:images.py:488 üìä Image record created: {'id': '21af4951-724e-4be6-93a5-214f285961d7', 'user_id': 'test-user-123', 'storage_path': 'users/test-user-123/uploads/2024/01/test.png', 'original_name': 'test.png', 'content_type': 'image/png', 'file_size': 1124, 'description': None, 'tags': None, 'is_public': False, 'created_at': '2025-10-15T02:01:28.800508+00:00'}
INFO     src.voxy_agents.api.routes.images:images.py:515 üéâ Upload completed successfully for user test-user-123
__________ TestImageUploadEndpoint.test_upload_image_storage_failure ___________

self = <test_images.TestImageUploadEndpoint object at 0x7268741f2270>
sample_image_data = b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\xc8\x00\x00\x00\xc8\x08\x02\x00\x00\x00":9\xc9\x00\x00\x02\x11IDATx\...00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
mock_current_user = <Mock id='125792467776384'>

    @pytest.mark.asyncio
    async def test_upload_image_storage_failure(
        self, sample_image_data, mock_current_user
    ):
        """Test handling of storage upload failure."""
        mock_supabase = Mock()
        mock_storage = Mock()
    
        # Mock storage failure
        mock_upload_result = Mock()
        mock_upload_result.status_code = 500
        mock_upload_result.json.return_value = {"message": "Storage error"}
        mock_storage.from_().upload.return_value = mock_upload_result
    
        mock_supabase.storage = mock_storage
    
        mock_validation_result = {
            "content": sample_image_data,
            "size": len(sample_image_data),
            "mime_type": "image/png",
            "filename": "test.png",
        }
    
        with patch(
            "src.voxy_agents.api.routes.images.get_supabase_client",
            return_value=mock_supabase,
        ):
            with patch(
                "src.voxy_agents.api.routes.images.validate_image_file",
                return_value=mock_validation_result,
            ):
                from src.voxy_agents.api.routes.images import upload_image
    
                mock_file = Mock()
                mock_file.content_type = "image/png"
                mock_file.filename = "test.png"
    
                with pytest.raises(Exception) as exc_info:
                    await upload_image(
                        file=mock_file,
                        description=None,
                        tags=None,
                        public=False,
                        current_user=mock_current_user,
                    )
    
>               assert "Failed to upload file" in str(exc_info.value)
E               assert 'Failed to upload file' in "500: Upload failed: 1 validation error for ImageUploadResponse\nurl\n  Input should be a valid string [type=string_ty...'125792693250688'>, input_type=Mock]\n    For further information visit https://errors.pydantic.dev/2.11/v/string_type"
E                +  where "500: Upload failed: 1 validation error for ImageUploadResponse\nurl\n  Input should be a valid string [type=string_ty...'125792693250688'>, input_type=Mock]\n    For further information visit https://errors.pydantic.dev/2.11/v/string_type" = str(HTTPException(status_code=500, detail="Upload failed: 1 validation error for ImageUploadResponse\nurl\n  Input should ...125792693250688'>, input_type=Mock]\n    For further information visit https://errors.pydantic.dev/2.11/v/string_type"))
E                +    where HTTPException(status_code=500, detail="Upload failed: 1 validation error for ImageUploadResponse\nurl\n  Input should ...125792693250688'>, input_type=Mock]\n    For further information visit https://errors.pydantic.dev/2.11/v/string_type") = <ExceptionInfo HTTPException(status_code=500, detail="Upload failed: 1 validation error for ImageUploadResponse\nurl\n...250688'>, input_type=Mock]\n    For further information visit https://errors.pydantic.dev/2.11/v/string_type") tblen=2>.value

tests/test_voxy_agents/test_api/test_routes/test_images.py:397: AssertionError
----------------------------- Captured stdout call -----------------------------
[32m2025-10-15 04:01:28.883[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | üöÄ Starting upload for user test-user-123, path: users/test-user-123/uploads/2025/10/20251015020128_f70afe53_test.png
[32m2025-10-15 04:01:28.883[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | üì§ Upload result: <Mock name='mock.storage.from_().upload()' id='125792467770384'>
[32m2025-10-15 04:01:28.883[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | ‚úÖ Upload successful
[32m2025-10-15 04:01:28.884[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | üîó Generated file URL: <Mock name='mock.storage.from_().get_public_url()' id='125792693250688'>
[32m2025-10-15 04:01:28.884[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | üíæ Saving metadata to database: {'user_id': 'test-user-123', 'storage_path': 'users/test-user-123/uploads/2025/10/20251015020128_f70afe53_test.png', 'original_name': 'test.png', 'content_type': 'image/png', 'file_size': 1124, 'description': None, 'tags': None, 'is_public': False}
[32m2025-10-15 04:01:28.884[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | üìù Formatted data: {'user_id': 'test-user-123', 'storage_path': 'users/test-user-123/uploads/2025/10/20251015020128_f70afe53_test.png', 'original_name': 'test.png', 'content_type': 'image/png', 'file_size': 1124, 'description': None, 'tags': None, 'is_public': False}
[32m2025-10-15 04:01:28.896[0m | [31m[1mERROR   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | ‚ùå Database insert failed: {'message': 'invalid input syntax for type uuid: "test-user-123"', 'code': '22P02', 'hint': None, 'details': None}
[32m2025-10-15 04:01:28.897[0m | [33m[1mWARNING [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | ‚ö†Ô∏è Continuing without metadata save for testing
[32m2025-10-15 04:01:28.897[0m | [1mINFO    [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | üìä Image record created: {'id': '4a3040f7-2d35-4738-9658-4133c107e33f', 'user_id': 'test-user-123', 'storage_path': 'users/test-user-123/uploads/2025/10/20251015020128_f70afe53_test.png', 'original_name': 'test.png', 'content_type': 'image/png', 'file_size': 1124, 'description': None, 'tags': None, 'is_public': False, 'created_at': '2025-10-15T02:01:28.897411+00:00'}
[32m2025-10-15 04:01:28.897[0m | [31m[1mERROR   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.api.routes.images[0m | ‚ùå Unexpected error during upload: 1 validation error for ImageUploadResponse
url
  Input should be a valid string [type=string_type, input_value=<Mock name='mock.storage....)' id='125792693250688'>, input_type=Mock]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
------------------------------ Captured log call -------------------------------
INFO     src.voxy_agents.api.routes.images:images.py:368 üöÄ Starting upload for user test-user-123, path: users/test-user-123/uploads/2025/10/20251015020128_f70afe53_test.png
INFO     src.voxy_agents.api.routes.images:images.py:381 üì§ Upload result: <Mock name='mock.storage.from_().upload()' id='125792467770384'>
INFO     src.voxy_agents.api.routes.images:images.py:385 ‚úÖ Upload successful
INFO     src.voxy_agents.api.routes.images:images.py:409 üîó Generated file URL: <Mock name='mock.storage.from_().get_public_url()' id='125792693250688'>
INFO     src.voxy_agents.api.routes.images:images.py:430 üíæ Saving metadata to database: {'user_id': 'test-user-123', 'storage_path': 'users/test-user-123/uploads/2025/10/20251015020128_f70afe53_test.png', 'original_name': 'test.png', 'content_type': 'image/png', 'file_size': 1124, 'description': None, 'tags': None, 'is_public': False}
INFO     src.voxy_agents.api.routes.images:images.py:446 üìù Formatted data: {'user_id': 'test-user-123', 'storage_path': 'users/test-user-123/uploads/2025/10/20251015020128_f70afe53_test.png', 'original_name': 'test.png', 'content_type': 'image/png', 'file_size': 1124, 'description': None, 'tags': None, 'is_public': False}
ERROR    src.voxy_agents.api.routes.images:images.py:454 ‚ùå Database insert failed: {'message': 'invalid input syntax for type uuid: "test-user-123"', 'code': '22P02', 'hint': None, 'details': None}
WARNING  src.voxy_agents.api.routes.images:images.py:456 ‚ö†Ô∏è Continuing without metadata save for testing
INFO     src.voxy_agents.api.routes.images:images.py:488 üìä Image record created: {'id': '4a3040f7-2d35-4738-9658-4133c107e33f', 'user_id': 'test-user-123', 'storage_path': 'users/test-user-123/uploads/2025/10/20251015020128_f70afe53_test.png', 'original_name': 'test.png', 'content_type': 'image/png', 'file_size': 1124, 'description': None, 'tags': None, 'is_public': False, 'created_at': '2025-10-15T02:01:28.897411+00:00'}
ERROR    src.voxy_agents.api.routes.images:images.py:522 ‚ùå Unexpected error during upload: 1 validation error for ImageUploadResponse
url
  Input should be a valid string [type=string_type, input_value=<Mock name='mock.storage....)' id='125792693250688'>, input_type=Mock]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/mnt/d/Projeto-Voxy/voxy/backend/src/voxy_agents/api/routes/images.py", line 502, in upload_image
    response_data = ImageUploadResponse(
                    ^^^^^^^^^^^^^^^^^^^^
  File "/mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for ImageUploadResponse
url
  Input should be a valid string [type=string_type, input_value=<Mock name='mock.storage....)' id='125792693250688'>, input_type=Mock]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
__________________ TestVoxyOrchestrator.test_chat_basic_flow ___________________

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x72686773f050>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x7268643d3800>

    @pytest.mark.asyncio
    async def test_chat_basic_flow(self, orchestrator):
        """Test basic chat flow."""
        with (
            patch("src.voxy_agents.core.voxy_orchestrator.Runner") as mock_runner_class,
            patch(
                "src.voxy_agents.core.voxy_orchestrator.SupabaseSession"
            ) as mock_session_class,
        ):
            # Setup mock response
            mock_result = MagicMock()
            mock_result.final_output = "Test response from VOXY"
            mock_runner_class.run = AsyncMock(return_value=mock_result)
    
            mock_session_instance = MagicMock()
            mock_session_class.return_value = mock_session_instance
    
            # Test
>           response, metadata = await orchestrator.chat("Hello", "user123")
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:116: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/voxy_agents/core/voxy_orchestrator.py:678: in chat
    self._initialize_voxy_agent()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x7268643d3800>

    def _initialize_voxy_agent(self) -> None:
        """Initialize the main VOXY agent with registered subagents as tools."""
        if self.voxy_agent is not None:
            return
    
        # Build tools list from registered subagents
        tools = []
        for subagent_info in self.subagents.values():
            agent = subagent_info["agent"]
            tool_name = subagent_info["tool_name"]
            description = subagent_info["description"]
    
            # Use .as_tool() to register subagent as tool
            tools.append(
                agent.as_tool(tool_name=tool_name, tool_description=description)
            )
    
        # Add vision agent tool
        vision_agent = get_vision_agent()
    
        @function_tool
        def analyze_image(
            image_url: str,
            analysis_type: str = "general",
            detail_level: str = "standard",
            specific_questions: Optional[list[str]] = None,
            query: str = "Analise esta imagem",
        ) -> str:  # pragma: no cover
            """
            An√°lise avan√ßada de imagens usando GPT-5 multimodal.
    
            Args:
                image_url: URL da imagem para an√°lise
                analysis_type: Tipo de an√°lise (general, ocr, technical, artistic, document)
                detail_level: N√≠vel de detalhe (basic, standard, detailed, comprehensive)
                specific_questions: Lista de perguntas espec√≠ficas sobre a imagem
                query: Query do usu√°rio sobre a imagem
    
            Returns:
                Resultado da an√°lise visual detalhada
            """
            # process_tool_call() is now synchronous (uses nest_asyncio internally)
            return vision_agent.process_tool_call(
                image_url=image_url,
                analysis_type=analysis_type,
                detail_level=detail_level,
                specific_questions=specific_questions,
                query=query,
            )
    
        tools.append(analyze_image)
    
        # Add web search tool for VOXY
        @function_tool
        def web_search(query: str) -> str:
            """Search the web for current information."""
            # Placeholder - implement web search API
            return f"Web search results for: {query}"
    
        tools.append(web_search)
    
        # Prepare ModelSettings with reasoning parameters
        model_settings = None
        if self.reasoning_params:
            # Pass reasoning params via ModelSettings.extra_args
>           model_settings = ModelSettings(
                extra_args=self.reasoning_params
            )
E           pydantic_core._pydantic_core.ValidationError: 1 validation error for ModelSettings
E           extra_args
E             Input should be a valid dictionary [type=dict_type, input_value=<MagicMock name='load_orc...)' id='125792950254528'>, input_type=MagicMock]
E               For further information visit https://errors.pydantic.dev/2.11/v/dict_type

src/voxy_agents/core/voxy_orchestrator.py:207: ValidationError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:29.771[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:29.772[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:29.796[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 25.8ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
----------------------------- Captured stdout call -----------------------------
[32m2025-10-15 04:01:29.798[0m | [1mINFO    [0m | [36mVISION_AGENT|INIT[0m | Vision Agent initialized
________________ TestVoxyOrchestrator.test_chat_with_session_id ________________

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x72686773ecc0>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x7268647a7fb0>

    @pytest.mark.asyncio
    async def test_chat_with_session_id(self, orchestrator):
        """Test chat with existing session ID."""
        with (
            patch("src.voxy_agents.core.voxy_orchestrator.Runner") as mock_runner_class,
            patch(
                "src.voxy_agents.core.voxy_orchestrator.SupabaseSession"
            ) as mock_session_class,
        ):
            # Setup mock response
            mock_result = MagicMock()
            mock_result.final_output = "Test response with session"
            mock_runner_class.run = AsyncMock(return_value=mock_result)
    
            mock_session_instance = MagicMock()
            mock_session_class.return_value = mock_session_instance
    
            # Test with existing session
>           response, metadata = await orchestrator.chat(
                "Hello", "user123", "existing_session"
            )

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:143: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/voxy_agents/core/voxy_orchestrator.py:678: in chat
    self._initialize_voxy_agent()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x7268647a7fb0>

    def _initialize_voxy_agent(self) -> None:
        """Initialize the main VOXY agent with registered subagents as tools."""
        if self.voxy_agent is not None:
            return
    
        # Build tools list from registered subagents
        tools = []
        for subagent_info in self.subagents.values():
            agent = subagent_info["agent"]
            tool_name = subagent_info["tool_name"]
            description = subagent_info["description"]
    
            # Use .as_tool() to register subagent as tool
            tools.append(
                agent.as_tool(tool_name=tool_name, tool_description=description)
            )
    
        # Add vision agent tool
        vision_agent = get_vision_agent()
    
        @function_tool
        def analyze_image(
            image_url: str,
            analysis_type: str = "general",
            detail_level: str = "standard",
            specific_questions: Optional[list[str]] = None,
            query: str = "Analise esta imagem",
        ) -> str:  # pragma: no cover
            """
            An√°lise avan√ßada de imagens usando GPT-5 multimodal.
    
            Args:
                image_url: URL da imagem para an√°lise
                analysis_type: Tipo de an√°lise (general, ocr, technical, artistic, document)
                detail_level: N√≠vel de detalhe (basic, standard, detailed, comprehensive)
                specific_questions: Lista de perguntas espec√≠ficas sobre a imagem
                query: Query do usu√°rio sobre a imagem
    
            Returns:
                Resultado da an√°lise visual detalhada
            """
            # process_tool_call() is now synchronous (uses nest_asyncio internally)
            return vision_agent.process_tool_call(
                image_url=image_url,
                analysis_type=analysis_type,
                detail_level=detail_level,
                specific_questions=specific_questions,
                query=query,
            )
    
        tools.append(analyze_image)
    
        # Add web search tool for VOXY
        @function_tool
        def web_search(query: str) -> str:
            """Search the web for current information."""
            # Placeholder - implement web search API
            return f"Web search results for: {query}"
    
        tools.append(web_search)
    
        # Prepare ModelSettings with reasoning parameters
        model_settings = None
        if self.reasoning_params:
            # Pass reasoning params via ModelSettings.extra_args
>           model_settings = ModelSettings(
                extra_args=self.reasoning_params
            )
E           pydantic_core._pydantic_core.ValidationError: 1 validation error for ModelSettings
E           extra_args
E             Input should be a valid dictionary [type=dict_type, input_value=<MagicMock name='load_orc...)' id='125792688146048'>, input_type=MagicMock]
E               For further information visit https://errors.pydantic.dev/2.11/v/dict_type

src/voxy_agents/core/voxy_orchestrator.py:207: ValidationError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:29.893[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:29.894[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:29.986[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 93.3ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
________________ TestVoxyOrchestrator.test_chat_error_handling _________________

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x72686773e990>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726864acb9e0>

    @pytest.mark.asyncio
    async def test_chat_error_handling(self, orchestrator):
        """Test chat error handling."""
        with patch(
            "src.voxy_agents.core.voxy_orchestrator.Runner"
        ) as mock_runner_class:
            # Setup mock to raise exception
            mock_runner_class.run = AsyncMock(side_effect=Exception("Runner failed"))
    
            # Test
>           response, metadata = await orchestrator.chat("Hello", "user123")
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:162: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/voxy_agents/core/voxy_orchestrator.py:678: in chat
    self._initialize_voxy_agent()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726864acb9e0>

    def _initialize_voxy_agent(self) -> None:
        """Initialize the main VOXY agent with registered subagents as tools."""
        if self.voxy_agent is not None:
            return
    
        # Build tools list from registered subagents
        tools = []
        for subagent_info in self.subagents.values():
            agent = subagent_info["agent"]
            tool_name = subagent_info["tool_name"]
            description = subagent_info["description"]
    
            # Use .as_tool() to register subagent as tool
            tools.append(
                agent.as_tool(tool_name=tool_name, tool_description=description)
            )
    
        # Add vision agent tool
        vision_agent = get_vision_agent()
    
        @function_tool
        def analyze_image(
            image_url: str,
            analysis_type: str = "general",
            detail_level: str = "standard",
            specific_questions: Optional[list[str]] = None,
            query: str = "Analise esta imagem",
        ) -> str:  # pragma: no cover
            """
            An√°lise avan√ßada de imagens usando GPT-5 multimodal.
    
            Args:
                image_url: URL da imagem para an√°lise
                analysis_type: Tipo de an√°lise (general, ocr, technical, artistic, document)
                detail_level: N√≠vel de detalhe (basic, standard, detailed, comprehensive)
                specific_questions: Lista de perguntas espec√≠ficas sobre a imagem
                query: Query do usu√°rio sobre a imagem
    
            Returns:
                Resultado da an√°lise visual detalhada
            """
            # process_tool_call() is now synchronous (uses nest_asyncio internally)
            return vision_agent.process_tool_call(
                image_url=image_url,
                analysis_type=analysis_type,
                detail_level=detail_level,
                specific_questions=specific_questions,
                query=query,
            )
    
        tools.append(analyze_image)
    
        # Add web search tool for VOXY
        @function_tool
        def web_search(query: str) -> str:
            """Search the web for current information."""
            # Placeholder - implement web search API
            return f"Web search results for: {query}"
    
        tools.append(web_search)
    
        # Prepare ModelSettings with reasoning parameters
        model_settings = None
        if self.reasoning_params:
            # Pass reasoning params via ModelSettings.extra_args
>           model_settings = ModelSettings(
                extra_args=self.reasoning_params
            )
E           pydantic_core._pydantic_core.ValidationError: 1 validation error for ModelSettings
E           extra_args
E             Input should be a valid dictionary [type=dict_type, input_value=<MagicMock name='load_orc...)' id='125792697530560'>, input_type=MagicMock]
E               For further information visit https://errors.pydantic.dev/2.11/v/dict_type

src/voxy_agents/core/voxy_orchestrator.py:207: ValidationError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:30.139[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:30.139[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:30.169[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 31.0ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
__________________ TestVoxyOrchestrator.test_setup_voxy_agent __________________

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x72686773da60>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x7268644a61e0>
mock_agent_wrapper = (<MagicMock id='125792684222480'>, <MagicMock name='mock.get_agent()' id='125792684899696'>)

    def test_setup_voxy_agent(self, orchestrator, mock_agent_wrapper):
        """Test VOXY agent initialization."""
        wrapper, mock_agent = mock_agent_wrapper
    
        # Setup mock agent with as_tool method
        mock_agent.as_tool = MagicMock(return_value=MagicMock())
    
        # Register some subagents first
        orchestrator.register_subagent("translator", mock_agent, "translate", "Test")
        orchestrator.register_subagent("calculator", mock_agent, "calculate", "Test")
    
        with (
            patch("src.voxy_agents.core.voxy_orchestrator.Agent") as mock_agent_class,
            patch(
                "src.voxy_agents.core.voxy_orchestrator.function_tool"
            ) as mock_function_tool,
        ):
            mock_voxy_instance = MagicMock()
            mock_agent_class.return_value = mock_voxy_instance
            mock_function_tool.return_value = MagicMock()
    
            # Test initialization
>           orchestrator._initialize_voxy_agent()

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:208: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x7268644a61e0>

    def _initialize_voxy_agent(self) -> None:
        """Initialize the main VOXY agent with registered subagents as tools."""
        if self.voxy_agent is not None:
            return
    
        # Build tools list from registered subagents
        tools = []
        for subagent_info in self.subagents.values():
            agent = subagent_info["agent"]
            tool_name = subagent_info["tool_name"]
            description = subagent_info["description"]
    
            # Use .as_tool() to register subagent as tool
            tools.append(
                agent.as_tool(tool_name=tool_name, tool_description=description)
            )
    
        # Add vision agent tool
        vision_agent = get_vision_agent()
    
        @function_tool
        def analyze_image(
            image_url: str,
            analysis_type: str = "general",
            detail_level: str = "standard",
            specific_questions: Optional[list[str]] = None,
            query: str = "Analise esta imagem",
        ) -> str:  # pragma: no cover
            """
            An√°lise avan√ßada de imagens usando GPT-5 multimodal.
    
            Args:
                image_url: URL da imagem para an√°lise
                analysis_type: Tipo de an√°lise (general, ocr, technical, artistic, document)
                detail_level: N√≠vel de detalhe (basic, standard, detailed, comprehensive)
                specific_questions: Lista de perguntas espec√≠ficas sobre a imagem
                query: Query do usu√°rio sobre a imagem
    
            Returns:
                Resultado da an√°lise visual detalhada
            """
            # process_tool_call() is now synchronous (uses nest_asyncio internally)
            return vision_agent.process_tool_call(
                image_url=image_url,
                analysis_type=analysis_type,
                detail_level=detail_level,
                specific_questions=specific_questions,
                query=query,
            )
    
        tools.append(analyze_image)
    
        # Add web search tool for VOXY
        @function_tool
        def web_search(query: str) -> str:
            """Search the web for current information."""
            # Placeholder - implement web search API
            return f"Web search results for: {query}"
    
        tools.append(web_search)
    
        # Prepare ModelSettings with reasoning parameters
        model_settings = None
        if self.reasoning_params:
            # Pass reasoning params via ModelSettings.extra_args
>           model_settings = ModelSettings(
                extra_args=self.reasoning_params
            )
E           pydantic_core._pydantic_core.ValidationError: 1 validation error for ModelSettings
E           extra_args
E             Input should be a valid dictionary [type=dict_type, input_value=<MagicMock name='load_orc...)' id='125792684183616'>, input_type=MagicMock]
E               For further information visit https://errors.pydantic.dev/2.11/v/dict_type

src/voxy_agents/core/voxy_orchestrator.py:207: ValidationError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:30.259[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:30.259[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:30.282[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 24.1ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
______ TestVoxyOrchestrator.test_voxy_agent_initialization_multiple_calls ______

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x72686773db80>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726864393440>

    @pytest.mark.asyncio
    async def test_voxy_agent_initialization_multiple_calls(self, orchestrator):
        """Test that multiple initialization calls don't recreate the agent."""
        with patch("src.voxy_agents.core.voxy_orchestrator.Agent") as mock_agent_class:
            mock_voxy_instance = MagicMock()
            mock_agent_class.return_value = mock_voxy_instance
    
            # First call should create agent
>           orchestrator._initialize_voxy_agent()

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:222: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726864393440>

    def _initialize_voxy_agent(self) -> None:
        """Initialize the main VOXY agent with registered subagents as tools."""
        if self.voxy_agent is not None:
            return
    
        # Build tools list from registered subagents
        tools = []
        for subagent_info in self.subagents.values():
            agent = subagent_info["agent"]
            tool_name = subagent_info["tool_name"]
            description = subagent_info["description"]
    
            # Use .as_tool() to register subagent as tool
            tools.append(
                agent.as_tool(tool_name=tool_name, tool_description=description)
            )
    
        # Add vision agent tool
        vision_agent = get_vision_agent()
    
        @function_tool
        def analyze_image(
            image_url: str,
            analysis_type: str = "general",
            detail_level: str = "standard",
            specific_questions: Optional[list[str]] = None,
            query: str = "Analise esta imagem",
        ) -> str:  # pragma: no cover
            """
            An√°lise avan√ßada de imagens usando GPT-5 multimodal.
    
            Args:
                image_url: URL da imagem para an√°lise
                analysis_type: Tipo de an√°lise (general, ocr, technical, artistic, document)
                detail_level: N√≠vel de detalhe (basic, standard, detailed, comprehensive)
                specific_questions: Lista de perguntas espec√≠ficas sobre a imagem
                query: Query do usu√°rio sobre a imagem
    
            Returns:
                Resultado da an√°lise visual detalhada
            """
            # process_tool_call() is now synchronous (uses nest_asyncio internally)
            return vision_agent.process_tool_call(
                image_url=image_url,
                analysis_type=analysis_type,
                detail_level=detail_level,
                specific_questions=specific_questions,
                query=query,
            )
    
        tools.append(analyze_image)
    
        # Add web search tool for VOXY
        @function_tool
        def web_search(query: str) -> str:
            """Search the web for current information."""
            # Placeholder - implement web search API
            return f"Web search results for: {query}"
    
        tools.append(web_search)
    
        # Prepare ModelSettings with reasoning parameters
        model_settings = None
        if self.reasoning_params:
            # Pass reasoning params via ModelSettings.extra_args
>           model_settings = ModelSettings(
                extra_args=self.reasoning_params
            )
E           pydantic_core._pydantic_core.ValidationError: 1 validation error for ModelSettings
E           extra_args
E             Input should be a valid dictionary [type=dict_type, input_value=<MagicMock name='load_orc...)' id='125792683194320'>, input_type=MagicMock]
E               For further information visit https://errors.pydantic.dev/2.11/v/dict_type

src/voxy_agents/core/voxy_orchestrator.py:207: ValidationError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:30.359[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:30.359[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:30.380[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 21.2ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
_____________ TestVoxyOrchestrator.test_web_search_tool_execution ______________

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x72686773e2d0>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x7268647224e0>

    def test_web_search_tool_execution(self, orchestrator):
        """Test that web_search tool is executed and returns formatted result (Line 92)."""
        with (
            patch(
                "src.voxy_agents.core.voxy_orchestrator.function_tool"
            ) as mock_function_tool,
            patch("src.voxy_agents.core.voxy_orchestrator.Agent") as mock_agent_class,
        ):
            # Capture the web_search function when it's created
            captured_web_search = None
    
            def capture_function_tool(func):
                nonlocal captured_web_search
                captured_web_search = func
                return func
    
            mock_function_tool.side_effect = capture_function_tool
            mock_agent_class.return_value = MagicMock()
    
            # Initialize agent to create the web_search tool
>           orchestrator._initialize_voxy_agent()

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:262: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x7268647224e0>

    def _initialize_voxy_agent(self) -> None:
        """Initialize the main VOXY agent with registered subagents as tools."""
        if self.voxy_agent is not None:
            return
    
        # Build tools list from registered subagents
        tools = []
        for subagent_info in self.subagents.values():
            agent = subagent_info["agent"]
            tool_name = subagent_info["tool_name"]
            description = subagent_info["description"]
    
            # Use .as_tool() to register subagent as tool
            tools.append(
                agent.as_tool(tool_name=tool_name, tool_description=description)
            )
    
        # Add vision agent tool
        vision_agent = get_vision_agent()
    
        @function_tool
        def analyze_image(
            image_url: str,
            analysis_type: str = "general",
            detail_level: str = "standard",
            specific_questions: Optional[list[str]] = None,
            query: str = "Analise esta imagem",
        ) -> str:  # pragma: no cover
            """
            An√°lise avan√ßada de imagens usando GPT-5 multimodal.
    
            Args:
                image_url: URL da imagem para an√°lise
                analysis_type: Tipo de an√°lise (general, ocr, technical, artistic, document)
                detail_level: N√≠vel de detalhe (basic, standard, detailed, comprehensive)
                specific_questions: Lista de perguntas espec√≠ficas sobre a imagem
                query: Query do usu√°rio sobre a imagem
    
            Returns:
                Resultado da an√°lise visual detalhada
            """
            # process_tool_call() is now synchronous (uses nest_asyncio internally)
            return vision_agent.process_tool_call(
                image_url=image_url,
                analysis_type=analysis_type,
                detail_level=detail_level,
                specific_questions=specific_questions,
                query=query,
            )
    
        tools.append(analyze_image)
    
        # Add web search tool for VOXY
        @function_tool
        def web_search(query: str) -> str:
            """Search the web for current information."""
            # Placeholder - implement web search API
            return f"Web search results for: {query}"
    
        tools.append(web_search)
    
        # Prepare ModelSettings with reasoning parameters
        model_settings = None
        if self.reasoning_params:
            # Pass reasoning params via ModelSettings.extra_args
>           model_settings = ModelSettings(
                extra_args=self.reasoning_params
            )
E           pydantic_core._pydantic_core.ValidationError: 1 validation error for ModelSettings
E           extra_args
E             Input should be a valid dictionary [type=dict_type, input_value=<MagicMock name='load_orc...)' id='125792684701888'>, input_type=MagicMock]
E               For further information visit https://errors.pydantic.dev/2.11/v/dict_type

src/voxy_agents/core/voxy_orchestrator.py:207: ValidationError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:30.463[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:30.464[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:30.483[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 22.2ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
____________ TestVoxyOrchestrator.test_chat_response_list_handling _____________

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x72686773d1f0>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726864923e00>

    @pytest.mark.asyncio
    async def test_chat_response_list_handling(self, orchestrator):
        """Test chat handling when result is a list (Line 207)."""
        with (
            patch("src.voxy_agents.core.voxy_orchestrator.Runner") as mock_runner_class,
            patch("src.voxy_agents.core.voxy_orchestrator.SupabaseSession"),
        ):
            # Setup mock response as list
            mock_result = MagicMock()
            mock_result.final_output = ["First part", "Second part", "Third part"]
            mock_runner_class.run = AsyncMock(return_value=mock_result)
    
            # Test
>           response, metadata = await orchestrator.chat("Hello", "user123")
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:353: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/voxy_agents/core/voxy_orchestrator.py:678: in chat
    self._initialize_voxy_agent()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726864923e00>

    def _initialize_voxy_agent(self) -> None:
        """Initialize the main VOXY agent with registered subagents as tools."""
        if self.voxy_agent is not None:
            return
    
        # Build tools list from registered subagents
        tools = []
        for subagent_info in self.subagents.values():
            agent = subagent_info["agent"]
            tool_name = subagent_info["tool_name"]
            description = subagent_info["description"]
    
            # Use .as_tool() to register subagent as tool
            tools.append(
                agent.as_tool(tool_name=tool_name, tool_description=description)
            )
    
        # Add vision agent tool
        vision_agent = get_vision_agent()
    
        @function_tool
        def analyze_image(
            image_url: str,
            analysis_type: str = "general",
            detail_level: str = "standard",
            specific_questions: Optional[list[str]] = None,
            query: str = "Analise esta imagem",
        ) -> str:  # pragma: no cover
            """
            An√°lise avan√ßada de imagens usando GPT-5 multimodal.
    
            Args:
                image_url: URL da imagem para an√°lise
                analysis_type: Tipo de an√°lise (general, ocr, technical, artistic, document)
                detail_level: N√≠vel de detalhe (basic, standard, detailed, comprehensive)
                specific_questions: Lista de perguntas espec√≠ficas sobre a imagem
                query: Query do usu√°rio sobre a imagem
    
            Returns:
                Resultado da an√°lise visual detalhada
            """
            # process_tool_call() is now synchronous (uses nest_asyncio internally)
            return vision_agent.process_tool_call(
                image_url=image_url,
                analysis_type=analysis_type,
                detail_level=detail_level,
                specific_questions=specific_questions,
                query=query,
            )
    
        tools.append(analyze_image)
    
        # Add web search tool for VOXY
        @function_tool
        def web_search(query: str) -> str:
            """Search the web for current information."""
            # Placeholder - implement web search API
            return f"Web search results for: {query}"
    
        tools.append(web_search)
    
        # Prepare ModelSettings with reasoning parameters
        model_settings = None
        if self.reasoning_params:
            # Pass reasoning params via ModelSettings.extra_args
>           model_settings = ModelSettings(
                extra_args=self.reasoning_params
            )
E           pydantic_core._pydantic_core.ValidationError: 1 validation error for ModelSettings
E           extra_args
E             Input should be a valid dictionary [type=dict_type, input_value=<MagicMock name='load_orc...)' id='125792689515280'>, input_type=MagicMock]
E               For further information visit https://errors.pydantic.dev/2.11/v/dict_type

src/voxy_agents/core/voxy_orchestrator.py:207: ValidationError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:30.594[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:30.596[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:30.618[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 24.1ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
_________ TestVoxyOrchestrator.test_chat_response_non_string_handling __________

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x72686779a660>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726864918c20>

    @pytest.mark.asyncio
    async def test_chat_response_non_string_handling(self, orchestrator):
        """Test chat handling when result is not a string (Line 209)."""
        with (
            patch("src.voxy_agents.core.voxy_orchestrator.Runner") as mock_runner_class,
            patch("src.voxy_agents.core.voxy_orchestrator.SupabaseSession"),
        ):
            # Setup mock response as non-string object
            mock_result = MagicMock()
            mock_result.final_output = {"message": "response", "status": "success"}
            mock_runner_class.run = AsyncMock(return_value=mock_result)
    
            # Test
>           response, metadata = await orchestrator.chat("Hello", "user123")
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:372: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/voxy_agents/core/voxy_orchestrator.py:678: in chat
    self._initialize_voxy_agent()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726864918c20>

    def _initialize_voxy_agent(self) -> None:
        """Initialize the main VOXY agent with registered subagents as tools."""
        if self.voxy_agent is not None:
            return
    
        # Build tools list from registered subagents
        tools = []
        for subagent_info in self.subagents.values():
            agent = subagent_info["agent"]
            tool_name = subagent_info["tool_name"]
            description = subagent_info["description"]
    
            # Use .as_tool() to register subagent as tool
            tools.append(
                agent.as_tool(tool_name=tool_name, tool_description=description)
            )
    
        # Add vision agent tool
        vision_agent = get_vision_agent()
    
        @function_tool
        def analyze_image(
            image_url: str,
            analysis_type: str = "general",
            detail_level: str = "standard",
            specific_questions: Optional[list[str]] = None,
            query: str = "Analise esta imagem",
        ) -> str:  # pragma: no cover
            """
            An√°lise avan√ßada de imagens usando GPT-5 multimodal.
    
            Args:
                image_url: URL da imagem para an√°lise
                analysis_type: Tipo de an√°lise (general, ocr, technical, artistic, document)
                detail_level: N√≠vel de detalhe (basic, standard, detailed, comprehensive)
                specific_questions: Lista de perguntas espec√≠ficas sobre a imagem
                query: Query do usu√°rio sobre a imagem
    
            Returns:
                Resultado da an√°lise visual detalhada
            """
            # process_tool_call() is now synchronous (uses nest_asyncio internally)
            return vision_agent.process_tool_call(
                image_url=image_url,
                analysis_type=analysis_type,
                detail_level=detail_level,
                specific_questions=specific_questions,
                query=query,
            )
    
        tools.append(analyze_image)
    
        # Add web search tool for VOXY
        @function_tool
        def web_search(query: str) -> str:
            """Search the web for current information."""
            # Placeholder - implement web search API
            return f"Web search results for: {query}"
    
        tools.append(web_search)
    
        # Prepare ModelSettings with reasoning parameters
        model_settings = None
        if self.reasoning_params:
            # Pass reasoning params via ModelSettings.extra_args
>           model_settings = ModelSettings(
                extra_args=self.reasoning_params
            )
E           pydantic_core._pydantic_core.ValidationError: 1 validation error for ModelSettings
E           extra_args
E             Input should be a valid dictionary [type=dict_type, input_value=<MagicMock name='load_orc...)' id='125792690331840'>, input_type=MagicMock]
E               For further information visit https://errors.pydantic.dev/2.11/v/dict_type

src/voxy_agents/core/voxy_orchestrator.py:207: ValidationError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:30.692[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:30.692[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:30.714[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 23.2ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
________ TestVoxyOrchestrator.test_chat_single_tool_agent_type_mapping _________

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x72686773c380>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726864945dc0>

    @pytest.mark.asyncio
    async def test_chat_single_tool_agent_type_mapping(self, orchestrator):
        """Test agent_type mapping when single tool is used (Lines 225-233)."""
        with (
            patch("src.voxy_agents.core.voxy_orchestrator.Runner") as mock_runner_class,
            patch("src.voxy_agents.core.voxy_orchestrator.SupabaseSession"),
        ):
            # Test each tool mapping
            tool_mappings = [
                ("translate_text", "translator"),
                ("correct_text", "corrector"),
                ("get_weather", "weather"),
                ("calculate", "calculator"),
                ("web_search", "web_search"),
                ("unknown_tool", "voxy"),  # Default case
            ]
    
            for tool_name, expected_agent_type in tool_mappings:
                # Setup mock response with single tool call
                mock_result = MagicMock()
                mock_result.final_output = f"Response from {tool_name}"
                mock_result.tool_calls = [MagicMock(tool_name=tool_name)]
                mock_runner_class.run = AsyncMock(return_value=mock_result)
    
                # Test
>               response, metadata = await orchestrator.chat("Hello", "user123")
                                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:404: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/voxy_agents/core/voxy_orchestrator.py:678: in chat
    self._initialize_voxy_agent()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726864945dc0>

    def _initialize_voxy_agent(self) -> None:
        """Initialize the main VOXY agent with registered subagents as tools."""
        if self.voxy_agent is not None:
            return
    
        # Build tools list from registered subagents
        tools = []
        for subagent_info in self.subagents.values():
            agent = subagent_info["agent"]
            tool_name = subagent_info["tool_name"]
            description = subagent_info["description"]
    
            # Use .as_tool() to register subagent as tool
            tools.append(
                agent.as_tool(tool_name=tool_name, tool_description=description)
            )
    
        # Add vision agent tool
        vision_agent = get_vision_agent()
    
        @function_tool
        def analyze_image(
            image_url: str,
            analysis_type: str = "general",
            detail_level: str = "standard",
            specific_questions: Optional[list[str]] = None,
            query: str = "Analise esta imagem",
        ) -> str:  # pragma: no cover
            """
            An√°lise avan√ßada de imagens usando GPT-5 multimodal.
    
            Args:
                image_url: URL da imagem para an√°lise
                analysis_type: Tipo de an√°lise (general, ocr, technical, artistic, document)
                detail_level: N√≠vel de detalhe (basic, standard, detailed, comprehensive)
                specific_questions: Lista de perguntas espec√≠ficas sobre a imagem
                query: Query do usu√°rio sobre a imagem
    
            Returns:
                Resultado da an√°lise visual detalhada
            """
            # process_tool_call() is now synchronous (uses nest_asyncio internally)
            return vision_agent.process_tool_call(
                image_url=image_url,
                analysis_type=analysis_type,
                detail_level=detail_level,
                specific_questions=specific_questions,
                query=query,
            )
    
        tools.append(analyze_image)
    
        # Add web search tool for VOXY
        @function_tool
        def web_search(query: str) -> str:
            """Search the web for current information."""
            # Placeholder - implement web search API
            return f"Web search results for: {query}"
    
        tools.append(web_search)
    
        # Prepare ModelSettings with reasoning parameters
        model_settings = None
        if self.reasoning_params:
            # Pass reasoning params via ModelSettings.extra_args
>           model_settings = ModelSettings(
                extra_args=self.reasoning_params
            )
E           pydantic_core._pydantic_core.ValidationError: 1 validation error for ModelSettings
E           extra_args
E             Input should be a valid dictionary [type=dict_type, input_value=<MagicMock name='load_orc...)' id='125792691205568'>, input_type=MagicMock]
E               For further information visit https://errors.pydantic.dev/2.11/v/dict_type

src/voxy_agents/core/voxy_orchestrator.py:207: ValidationError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:30.784[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:30.784[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:30.823[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 40.1ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
___________ TestVoxyOrchestrator.test_chat_multiple_tools_agent_type ___________

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x72686773dd90>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726864945cd0>

    @pytest.mark.asyncio
    async def test_chat_multiple_tools_agent_type(self, orchestrator):
        """Test agent_type remains 'voxy' when multiple tools are used."""
        with (
            patch("src.voxy_agents.core.voxy_orchestrator.Runner") as mock_runner_class,
            patch("src.voxy_agents.core.voxy_orchestrator.SupabaseSession"),
        ):
            # Setup mock response with multiple tool calls
            mock_result = MagicMock()
            mock_result.final_output = "Response using multiple tools"
            mock_result.tool_calls = [
                MagicMock(tool_name="translate_text"),
                MagicMock(tool_name="calculate"),
            ]
            mock_runner_class.run = AsyncMock(return_value=mock_result)
    
            # Test
>           response, metadata = await orchestrator.chat("Hello", "user123")
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:427: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/voxy_agents/core/voxy_orchestrator.py:678: in chat
    self._initialize_voxy_agent()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726864945cd0>

    def _initialize_voxy_agent(self) -> None:
        """Initialize the main VOXY agent with registered subagents as tools."""
        if self.voxy_agent is not None:
            return
    
        # Build tools list from registered subagents
        tools = []
        for subagent_info in self.subagents.values():
            agent = subagent_info["agent"]
            tool_name = subagent_info["tool_name"]
            description = subagent_info["description"]
    
            # Use .as_tool() to register subagent as tool
            tools.append(
                agent.as_tool(tool_name=tool_name, tool_description=description)
            )
    
        # Add vision agent tool
        vision_agent = get_vision_agent()
    
        @function_tool
        def analyze_image(
            image_url: str,
            analysis_type: str = "general",
            detail_level: str = "standard",
            specific_questions: Optional[list[str]] = None,
            query: str = "Analise esta imagem",
        ) -> str:  # pragma: no cover
            """
            An√°lise avan√ßada de imagens usando GPT-5 multimodal.
    
            Args:
                image_url: URL da imagem para an√°lise
                analysis_type: Tipo de an√°lise (general, ocr, technical, artistic, document)
                detail_level: N√≠vel de detalhe (basic, standard, detailed, comprehensive)
                specific_questions: Lista de perguntas espec√≠ficas sobre a imagem
                query: Query do usu√°rio sobre a imagem
    
            Returns:
                Resultado da an√°lise visual detalhada
            """
            # process_tool_call() is now synchronous (uses nest_asyncio internally)
            return vision_agent.process_tool_call(
                image_url=image_url,
                analysis_type=analysis_type,
                detail_level=detail_level,
                specific_questions=specific_questions,
                query=query,
            )
    
        tools.append(analyze_image)
    
        # Add web search tool for VOXY
        @function_tool
        def web_search(query: str) -> str:
            """Search the web for current information."""
            # Placeholder - implement web search API
            return f"Web search results for: {query}"
    
        tools.append(web_search)
    
        # Prepare ModelSettings with reasoning parameters
        model_settings = None
        if self.reasoning_params:
            # Pass reasoning params via ModelSettings.extra_args
>           model_settings = ModelSettings(
                extra_args=self.reasoning_params
            )
E           pydantic_core._pydantic_core.ValidationError: 1 validation error for ModelSettings
E           extra_args
E             Input should be a valid dictionary [type=dict_type, input_value=<MagicMock name='load_orc...)' id='125792690297392'>, input_type=MagicMock]
E               For further information visit https://errors.pydantic.dev/2.11/v/dict_type

src/voxy_agents/core/voxy_orchestrator.py:207: ValidationError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:30.917[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:30.917[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:30.939[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 23.3ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
_________________ TestVoxyOrchestrator.test_chat_no_tools_used _________________

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x72686773e3c0>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726857bb5550>

    @pytest.mark.asyncio
    async def test_chat_no_tools_used(self, orchestrator):
        """Test chat when no tools are used."""
        with (
            patch("src.voxy_agents.core.voxy_orchestrator.Runner") as mock_runner_class,
            patch("src.voxy_agents.core.voxy_orchestrator.SupabaseSession"),
        ):
            # Setup mock response with no tool calls
            mock_result = MagicMock()
            mock_result.final_output = "Direct response from VOXY"
            mock_result.tool_calls = []  # No tools used
            mock_runner_class.run = AsyncMock(return_value=mock_result)
    
            # Test
>           response, metadata = await orchestrator.chat("Hello", "user123")
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:447: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/voxy_agents/core/voxy_orchestrator.py:678: in chat
    self._initialize_voxy_agent()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726857bb5550>

    def _initialize_voxy_agent(self) -> None:
        """Initialize the main VOXY agent with registered subagents as tools."""
        if self.voxy_agent is not None:
            return
    
        # Build tools list from registered subagents
        tools = []
        for subagent_info in self.subagents.values():
            agent = subagent_info["agent"]
            tool_name = subagent_info["tool_name"]
            description = subagent_info["description"]
    
            # Use .as_tool() to register subagent as tool
            tools.append(
                agent.as_tool(tool_name=tool_name, tool_description=description)
            )
    
        # Add vision agent tool
        vision_agent = get_vision_agent()
    
        @function_tool
        def analyze_image(
            image_url: str,
            analysis_type: str = "general",
            detail_level: str = "standard",
            specific_questions: Optional[list[str]] = None,
            query: str = "Analise esta imagem",
        ) -> str:  # pragma: no cover
            """
            An√°lise avan√ßada de imagens usando GPT-5 multimodal.
    
            Args:
                image_url: URL da imagem para an√°lise
                analysis_type: Tipo de an√°lise (general, ocr, technical, artistic, document)
                detail_level: N√≠vel de detalhe (basic, standard, detailed, comprehensive)
                specific_questions: Lista de perguntas espec√≠ficas sobre a imagem
                query: Query do usu√°rio sobre a imagem
    
            Returns:
                Resultado da an√°lise visual detalhada
            """
            # process_tool_call() is now synchronous (uses nest_asyncio internally)
            return vision_agent.process_tool_call(
                image_url=image_url,
                analysis_type=analysis_type,
                detail_level=detail_level,
                specific_questions=specific_questions,
                query=query,
            )
    
        tools.append(analyze_image)
    
        # Add web search tool for VOXY
        @function_tool
        def web_search(query: str) -> str:
            """Search the web for current information."""
            # Placeholder - implement web search API
            return f"Web search results for: {query}"
    
        tools.append(web_search)
    
        # Prepare ModelSettings with reasoning parameters
        model_settings = None
        if self.reasoning_params:
            # Pass reasoning params via ModelSettings.extra_args
>           model_settings = ModelSettings(
                extra_args=self.reasoning_params
            )
E           pydantic_core._pydantic_core.ValidationError: 1 validation error for ModelSettings
E           extra_args
E             Input should be a valid dictionary [type=dict_type, input_value=<MagicMock name='load_orc...)' id='125792473874752'>, input_type=MagicMock]
E               For further information visit https://errors.pydantic.dev/2.11/v/dict_type

src/voxy_agents/core/voxy_orchestrator.py:207: ValidationError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:31.004[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:31.004[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:31.027[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 24.2ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
______ TestVoxyOrchestrator.test_chat_result_without_tool_calls_attribute ______

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x72686773fb00>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726857be5c70>

    @pytest.mark.asyncio
    async def test_chat_result_without_tool_calls_attribute(self, orchestrator):
        """Test chat when result doesn't have tool_calls attribute."""
        with (
            patch("src.voxy_agents.core.voxy_orchestrator.Runner") as mock_runner_class,
            patch("src.voxy_agents.core.voxy_orchestrator.SupabaseSession"),
        ):
            # Setup mock response without tool_calls attribute
            mock_result = MagicMock()
            mock_result.final_output = "Response without tool calls"
            # Don't set tool_calls attribute at all
            if hasattr(mock_result, "tool_calls"):
                delattr(mock_result, "tool_calls")
    
            mock_runner_class.run = AsyncMock(return_value=mock_result)
    
            # Test
>           response, metadata = await orchestrator.chat("Hello", "user123")
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:470: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/voxy_agents/core/voxy_orchestrator.py:678: in chat
    self._initialize_voxy_agent()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726857be5c70>

    def _initialize_voxy_agent(self) -> None:
        """Initialize the main VOXY agent with registered subagents as tools."""
        if self.voxy_agent is not None:
            return
    
        # Build tools list from registered subagents
        tools = []
        for subagent_info in self.subagents.values():
            agent = subagent_info["agent"]
            tool_name = subagent_info["tool_name"]
            description = subagent_info["description"]
    
            # Use .as_tool() to register subagent as tool
            tools.append(
                agent.as_tool(tool_name=tool_name, tool_description=description)
            )
    
        # Add vision agent tool
        vision_agent = get_vision_agent()
    
        @function_tool
        def analyze_image(
            image_url: str,
            analysis_type: str = "general",
            detail_level: str = "standard",
            specific_questions: Optional[list[str]] = None,
            query: str = "Analise esta imagem",
        ) -> str:  # pragma: no cover
            """
            An√°lise avan√ßada de imagens usando GPT-5 multimodal.
    
            Args:
                image_url: URL da imagem para an√°lise
                analysis_type: Tipo de an√°lise (general, ocr, technical, artistic, document)
                detail_level: N√≠vel de detalhe (basic, standard, detailed, comprehensive)
                specific_questions: Lista de perguntas espec√≠ficas sobre a imagem
                query: Query do usu√°rio sobre a imagem
    
            Returns:
                Resultado da an√°lise visual detalhada
            """
            # process_tool_call() is now synchronous (uses nest_asyncio internally)
            return vision_agent.process_tool_call(
                image_url=image_url,
                analysis_type=analysis_type,
                detail_level=detail_level,
                specific_questions=specific_questions,
                query=query,
            )
    
        tools.append(analyze_image)
    
        # Add web search tool for VOXY
        @function_tool
        def web_search(query: str) -> str:
            """Search the web for current information."""
            # Placeholder - implement web search API
            return f"Web search results for: {query}"
    
        tools.append(web_search)
    
        # Prepare ModelSettings with reasoning parameters
        model_settings = None
        if self.reasoning_params:
            # Pass reasoning params via ModelSettings.extra_args
>           model_settings = ModelSettings(
                extra_args=self.reasoning_params
            )
E           pydantic_core._pydantic_core.ValidationError: 1 validation error for ModelSettings
E           extra_args
E             Input should be a valid dictionary [type=dict_type, input_value=<MagicMock name='load_orc...)' id='125792474047568'>, input_type=MagicMock]
E               For further information visit https://errors.pydantic.dev/2.11/v/dict_type

src/voxy_agents/core/voxy_orchestrator.py:207: ValidationError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:31.096[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:31.097[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:31.125[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 29.0ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
_____________ TestVoxyOrchestrator.test_vision_bypass_integration ______________

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x7268677980b0>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726864101af0>

    @pytest.mark.asyncio
    async def test_vision_bypass_integration(self, orchestrator):
        """Test Vision Agent Agents SDK Bypass integration."""
>       with patch(
            "src.voxy_agents.core.voxy_orchestrator.direct_vision_processor"
        ) as mock_processor:

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:479: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/unittest/mock.py:1458: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7268644c0b90>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'src.voxy_agents.core.voxy_orchestrator' from '/mnt/d/Projeto-Voxy/voxy/backend/src/voxy_agents/core/voxy_orchestrator.py'> does not have the attribute 'direct_vision_processor'

/usr/lib/python3.12/unittest/mock.py:1431: AttributeError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:31.209[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:31.209[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:31.251[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 43.2ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
--------------------------- Captured stdout teardown ---------------------------
[32m2025-10-15 04:01:31.341[0m | [31m[1mERROR   [0m | [36mGENERAL[0m | [34mopenai.agents[0m | [non-fatal] Tracing client error 401: {
  "error": {
    "message": "Incorrect API key provided: test-key. You can find your API key at https://platform.openai.com/account/api-keys.",
    "type": "invalid_request_error",
    "param": null,
    "code": "invalid_api_key"
  }
}
---------------------------- Captured log teardown -----------------------------
ERROR    openai.agents:processors.py:129 [non-fatal] Tracing client error 401: {
  "error": {
    "message": "Incorrect API key provided: test-key. You can find your API key at https://platform.openai.com/account/api-keys.",
    "type": "invalid_request_error",
    "param": null,
    "code": "invalid_api_key"
  }
}
______________ TestVoxyOrchestrator.test_determine_analysis_type _______________

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x726867729490>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x726857b9d670>

    def test_determine_analysis_type(self, orchestrator):
        """Test analysis type determination from message."""
        assert orchestrator._determine_analysis_type("ler o texto da imagem") == "ocr"
>       assert (
            orchestrator._determine_analysis_type("an√°lise t√©cnica detalhada")
            == "technical"
        )
E       AssertionError: assert 'general' == 'technical'
E         
E         - technical
E         + general

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:543: AssertionError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:31.387[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:31.388[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:31.412[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 25.2ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
_______________ TestVoxyOrchestrator.test_determine_detail_level _______________

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x72686772bf50>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x72686412a270>

    def test_determine_detail_level(self, orchestrator):
        """Test detail level determination from message."""
        assert orchestrator._determine_detail_level("que emoji √© este?") == "basic"
        assert orchestrator._determine_detail_level("an√°lise r√°pida simples") == "basic"
>       assert (
            orchestrator._determine_detail_level("an√°lise detalhada completa")
            == "detailed"
        )
E       AssertionError: assert 'standard' == 'detailed'
E         
E         - detailed
E         + standard

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:557: AssertionError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:31.446[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:31.447[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:31.467[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 20.9ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
_____ TestVoxyOrchestrator.test_vision_bypass_not_triggered_without_image ______

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x726867729220>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x7268647d5040>

    @pytest.mark.asyncio
    async def test_vision_bypass_not_triggered_without_image(self, orchestrator):
        """Test that bypass is not triggered when no image is provided."""
>       with (
            patch(
                "src.voxy_agents.core.voxy_orchestrator.direct_vision_processor"
            ) as mock_processor,
            patch("src.voxy_agents.core.voxy_orchestrator.Runner") as mock_runner_class,
            patch("src.voxy_agents.core.voxy_orchestrator.SupabaseSession"),
        ):

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:570: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/unittest/mock.py:1458: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7268644c0350>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'src.voxy_agents.core.voxy_orchestrator' from '/mnt/d/Projeto-Voxy/voxy/backend/src/voxy_agents/core/voxy_orchestrator.py'> does not have the attribute 'direct_vision_processor'

/usr/lib/python3.12/unittest/mock.py:1431: AttributeError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:31.500[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:31.500[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:31.528[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 28.5ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
_ TestVoxyOrchestrator.test_vision_bypass_not_triggered_for_non_vision_with_image _

self = <tests.test_voxy_agents.test_core.test_voxy_orchestrator.TestVoxyOrchestrator object at 0x72686772b290>
orchestrator = <src.voxy_agents.core.voxy_orchestrator.VoxyOrchestrator object at 0x72686495c920>

    @pytest.mark.asyncio
    async def test_vision_bypass_not_triggered_for_non_vision_with_image(
        self, orchestrator
    ):
        """Test that bypass is not triggered for non-vision requests even with image."""
>       with (
            patch(
                "src.voxy_agents.core.voxy_orchestrator.direct_vision_processor"
            ) as mock_processor,
            patch("src.voxy_agents.core.voxy_orchestrator.Runner") as mock_runner_class,
            patch("src.voxy_agents.core.voxy_orchestrator.SupabaseSession"),
        ):

tests/test_voxy_agents/test_core/test_voxy_orchestrator.py:595: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/unittest/mock.py:1458: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7268647a78f0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'src.voxy_agents.core.voxy_orchestrator' from '/mnt/d/Projeto-Voxy/voxy/backend/src/voxy_agents/core/voxy_orchestrator.py'> does not have the attribute 'direct_vision_processor'

/usr/lib/python3.12/unittest/mock.py:1431: AttributeError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:31.615[0m | [34m[1mDEBUG   [0m | [36mGENERAL[0m | [34msrc.voxy_agents.utils.llm_factory[0m | Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
[32m2025-10-15 04:01:31.615[0m | [1mINFO    [0m | [36mVOXY_ORCHESTRATOR|REASONING_CONFIG[0m | Orchestrator reasoning configured
[32m2025-10-15 04:01:31.641[0m | [1mINFO    [0m | [36mSTARTUP|ORCHESTRATOR[0m | 
ü§ñ VOXY Orchestrator Initialized
   ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
   ‚îú‚îÄ Config: 4000 tokens, temp=0.3, reasoning=medium
   ‚îî‚îÄ ‚úì Ready in 28.4ms
------------------------------ Captured log setup ------------------------------
DEBUG    src.voxy_agents.utils.llm_factory:llm_factory.py:205 Reasoning parameters extracted for openrouter/anthropic/claude-sonnet-4.5: []
_______________________ TestVOXYSystem.test_chat_success _______________________

self = <tests.test_voxy_agents.test_main.TestVOXYSystem object at 0x72686772b950>
voxy_system = <src.voxy_agents.main.VOXYSystem object at 0x726857bfa540>

    @pytest.mark.asyncio
    async def test_chat_success(self, voxy_system):
        """Test successful chat interaction."""
        message = "Hello VOXY"
        user_id = "test_user"
        session_id = "test_session"
    
        # Mock the orchestrator's chat method to return expected response
        voxy_system.orchestrator.chat = AsyncMock(
            return_value=("Test response", {"agent_type": "voxy"})
        )
    
        response, metadata = await voxy_system.chat(message, user_id, session_id)
    
        assert response == "Test response"
        assert metadata["agent_type"] == "voxy"
>       voxy_system.orchestrator.chat.assert_called_once_with(
            message, user_id, session_id
        )

tests/test_voxy_agents/test_main.py:101: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/unittest/mock.py:956: in assert_called_once_with
    return self.assert_called_with(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <AsyncMock id='125792681404720'>
args = ('Hello VOXY', 'test_user', 'test_session'), kwargs = {}
expected = call('Hello VOXY', 'test_user', 'test_session')
actual = call('Hello VOXY', 'test_user', 'test_session', None)
_error_message = <function NonCallableMock.assert_called_with.<locals>._error_message at 0x72686510df80>
cause = None

    def assert_called_with(self, /, *args, **kwargs):
        """assert that the last call was made with the specified arguments.
    
        Raises an AssertionError if the args and keyword args passed in are
        different to the last call to the mock."""
        if self.call_args is None:
            expected = self._format_mock_call_signature(args, kwargs)
            actual = 'not called.'
            error_message = ('expected call not found.\nExpected: %s\n  Actual: %s'
                    % (expected, actual))
            raise AssertionError(error_message)
    
        def _error_message():
            msg = self._format_mock_failure_message(args, kwargs)
            return msg
        expected = self._call_matcher(_Call((args, kwargs), two=True))
        actual = self._call_matcher(self.call_args)
        if actual != expected:
            cause = expected if isinstance(expected, Exception) else None
>           raise AssertionError(_error_message()) from cause
E           AssertionError: expected call not found.
E           Expected: mock('Hello VOXY', 'test_user', 'test_session')
E             Actual: mock('Hello VOXY', 'test_user', 'test_session', None)

/usr/lib/python3.12/unittest/mock.py:944: AssertionError
---------------------------- Captured stdout setup -----------------------------
[32m2025-10-15 04:01:31.841[0m | [1mINFO    [0m | [36mSTARTUP|SUBAGENTS[0m | üì¶ Registering Subagents (4 agents + Vision)
[32m2025-10-15 04:01:31.842[0m | [1mINFO    [0m | [36mSTARTUP|SUBAGENT_INIT[0m |    
   ‚îî‚îÄ ‚úì Vision (integrated in orchestrator)
      ‚îú‚îÄ Model: openrouter/anthropic/claude-sonnet-4.5
      ‚îú‚îÄ Config: 2000 tokens, temp=0.1, reasoning=medium
      ‚îî‚îÄ ‚úì Integrated
=============================== warnings summary ===============================
src/voxy_agents/utils/test_subagents.py:43
  /mnt/d/Projeto-Voxy/voxy/backend/src/voxy_agents/utils/test_subagents.py:43: PytestCollectionWarning: cannot collect test class 'TestMetadata' because it has a __init__ constructor (from: tests/test_subagent_tester.py)
    class TestMetadata(BaseModel):

src/voxy_agents/utils/test_subagents.py:69
  /mnt/d/Projeto-Voxy/voxy/backend/src/voxy_agents/utils/test_subagents.py:69: PytestCollectionWarning: cannot collect test class 'TestResult' because it has a __init__ constructor (from: tests/test_subagent_tester.py)
    class TestResult(BaseModel):

.venv/lib/python3.12/site-packages/pydantic/fields.py:1093
.venv/lib/python3.12/site-packages/pydantic/fields.py:1093
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/fields.py:1093: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warn(

.venv/lib/python3.12/site-packages/pydantic/fields.py:1062
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/fields.py:1062: PydanticDeprecatedSince20: `min_items` is deprecated and will be removed, use `min_length` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warn('`min_items` is deprecated and will be removed, use `min_length` instead', DeprecationWarning)

.venv/lib/python3.12/site-packages/pydantic/fields.py:1068
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/fields.py:1068: PydanticDeprecatedSince20: `max_items` is deprecated and will be removed, use `max_length` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warn('`max_items` is deprecated and will be removed, use `max_length` instead', DeprecationWarning)

tests/test_subagent_tester.py::test_translator_pt_to_en
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:761: DeprecationWarning: The event_loop fixture provided by pytest-asyncio has been redefined in
  /mnt/d/Projeto-Voxy/voxy/backend/tests/conftest.py:15
  Replacing the event_loop fixture with a custom implementation is deprecated
  and will lead to errors in the future.
  If you want to request an asyncio event loop with a scope other than function
  scope, use the "scope" argument to the asyncio mark when marking the tests.
  If you want to return different types of event loops, use the event_loop_policy
  fixture.
  
    warnings.warn(

tests/test_subagent_tester.py: 20 warnings
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/httpx/_content.py:204: DeprecationWarning: Use 'content=<...>' to upload raw bytes/text content.
    warnings.warn(message, DeprecationWarning)

tests/test_subagent_tester.py::test_translator_pt_to_en
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 5: Expected `Message` - serialized value may not be as expected [input_value=Message(content='Hello wo...one, 'reasoning': None}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='st...finish_reason': 'STOP'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_subagent_tester.py::test_translator_en_to_pt
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 5: Expected `Message` - serialized value may not be as expected [input_value=Message(content='Ol√° mun...one, 'reasoning': None}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='st...finish_reason': 'STOP'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_subagent_tester.py::test_translator_with_source_language
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 5: Expected `Message` - serialized value may not be as expected [input_value=Message(content='Hello', ...one, 'reasoning': None}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='st...finish_reason': 'STOP'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_subagent_tester.py::test_corrector_grammar_fix
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 5: Expected `Message` - serialized value may not be as expected [input_value=Message(content='Eu fui ...one, 'reasoning': None}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='st...finish_reason': 'STOP'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_subagent_tester.py::test_corrector_spelling_fix
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 5: Expected `Message` - serialized value may not be as expected [input_value=Message(content='Voc√™ es...one, 'reasoning': None}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='st...finish_reason': 'STOP'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_subagent_tester.py::test_corrector_no_errors
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 5: Expected `Message` - serialized value may not be as expected [input_value=Message(content='Este tex...one, 'reasoning': None}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='st...finish_reason': 'STOP'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_subagent_tester.py::test_weather_valid_city
tests/test_subagent_tester.py::test_weather_invalid_city
tests/test_subagent_tester.py::test_weather_default_country
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 5: Expected `Message` - serialized value may not be as expected [input_value=Message(content='', role=...one, 'reasoning': None}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='to..._reason': 'tool_calls'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_subagent_tester.py::test_calculator_basic_math
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 6: Expected `Message` - serialized value may not be as expected [input_value=Message(content='2 + 2 = ...arithmetic operation.'}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='st...h_reason': 'completed'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_subagent_tester.py::test_calculator_complex_expression
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 6: Expected `Message` - serialized value may not be as expected [input_value=Message(content='25 √ó 4 ... 100 + 10 equals 110.'}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='st...h_reason': 'completed'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_subagent_tester.py::test_calculator_with_parentheses
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 6: Expected `Message` - serialized value may not be as expected [input_value=Message(content='(10 + 5)...de the direct result.'}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='st...h_reason': 'completed'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_subagent_tester.py::test_vision_general_analysis
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 5: Expected `Message` - serialized value may not be as expected [input_value=Message(content='Vejo uma...one, 'reasoning': None}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='st...finish_reason': 'stop'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_subagent_tester.py::test_vision_cache_bypass
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 5: Expected `Message` - serialized value may not be as expected [input_value=Message(content='Vejo que...one, 'reasoning': None}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='st...finish_reason': 'stop'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_subagent_tester.py::test_vision_different_analysis_types
tests/test_subagent_tester.py::test_vision_agent_performance
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 5: Expected `Message` - serialized value may not be as expected [input_value=Message(content='# An√°li...one, 'reasoning': None}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='st...finish_reason': 'stop'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_subagent_tester.py::test_metadata_has_required_fields
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 6: Expected `Message` - serialized value may not be as expected [input_value=Message(content='1 + 1 = ...ritm√©tica b√°sica.\n'}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='st...h_reason': 'completed'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_subagent_tester.py::test_vision_metadata_has_extra_fields
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 5: Expected `Message` - serialized value may not be as expected [input_value=Message(content='Ol√°! Es...one, 'reasoning': None}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='st...finish_reason': 'stop'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_subagent_tester.py::test_standard_agent_performance
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 6: Expected `Message` - serialized value may not be as expected [input_value=Message(content='10 * 5 =...de multiplica√ß√£o.\n'}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='st...h_reason': 'completed'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_subagent_tester.py::test_cost_tracking
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected 9 fields but got 5: Expected `Message` - serialized value may not be as expected [input_value=Message(content='Ol√°', r...one, 'reasoning': None}), input_type=Message])
    PydanticSerializationUnexpectedValue(Expected `StreamingChoices` - serialized value may not be as expected [input_value=Choices(finish_reason='st...finish_reason': 'STOP'}), input_type=Choices])
    return self.__pydantic_serializer__.to_python(

tests/test_vision_flow_corrections.py::TestToolsUsedMetadata::test_path_1_tools_used
tests/test_voxy_agents/test_api/test_routes/test_images.py::TestImageUploadEndpoint::test_upload_image_success
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/supabase/_sync/client.py:303: DeprecationWarning: The 'timeout' parameter is deprecated. Please configure it in the http client instead.
    return SyncPostgrestClient(

tests/test_vision_flow_corrections.py::TestToolsUsedMetadata::test_path_1_tools_used
tests/test_voxy_agents/test_api/test_routes/test_images.py::TestImageUploadEndpoint::test_upload_image_success
  /mnt/d/Projeto-Voxy/voxy/backend/.venv/lib/python3.12/site-packages/supabase/_sync/client.py:303: DeprecationWarning: The 'verify' parameter is deprecated. Please configure it in the http client instead.
    return SyncPostgrestClient(

tests/test_voxy_agents/test_api/test_routes/test_auth.py::TestJWTValidation::test_expired_token_verification
  /mnt/d/Projeto-Voxy/voxy/backend/tests/test_voxy_agents/test_api/test_routes/test_auth.py:306: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    verify_token(expired_jwt_token)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_voxy_agents/test_api/test_routes/test_auth.py::TestJWTValidation::test_invalid_token_verification
  /mnt/d/Projeto-Voxy/voxy/backend/tests/test_voxy_agents/test_api/test_routes/test_auth.py:319: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    verify_token(invalid_jwt_token)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_voxy_agents/test_api/test_routes/test_auth.py::TestJWTValidation::test_missing_token_header
  /mnt/d/Projeto-Voxy/voxy/backend/tests/test_voxy_agents/test_api/test_routes/test_auth.py:334: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    verify_token("")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_voxy_agents/test_api/test_routes/test_auth.py::TestJWTValidation::test_malformed_auth_header
  /mnt/d/Projeto-Voxy/voxy/backend/tests/test_voxy_agents/test_api/test_routes/test_auth.py:348: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    verify_token("invalid-format")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_voxy_agents/test_api/test_routes/test_auth.py::TestProtectedEndpoints::test_protected_endpoint_without_token
  /usr/lib/python3.12/typing.py:1178: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    def __getattr__(self, attr):
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html

---------- coverage: platform linux, python 3.12.3-final-0 -----------
Name                                                      Stmts   Miss  Cover   Missing
---------------------------------------------------------------------------------------
src/voxy_agents/__init__.py                                   2      0   100%
src/voxy_agents/api/__init__.py                               0      0   100%
src/voxy_agents/api/fastapi_server.py                       149     31    79%   92-122, 197-201, 242-245, 302-309, 335-340, 373-375, 387-389, 393-395
src/voxy_agents/api/middleware/__init__.py                    3      0   100%
src/voxy_agents/api/middleware/auth.py                       51     19    63%   64, 77-93, 96, 125, 150, 168-174
src/voxy_agents/api/middleware/logging_context.py            18      0   100%
src/voxy_agents/api/middleware/supabase_client.py             9      0   100%
src/voxy_agents/api/middleware/vision_rate_limiter.py       115      0   100%
src/voxy_agents/api/models.py                                47      0   100%
src/voxy_agents/api/routes/__init__.py                        5      0   100%
src/voxy_agents/api/routes/auth.py                           95     27    72%   163, 196, 217-260, 273, 288
src/voxy_agents/api/routes/chat.py                          106     68    36%   76-225, 247-256
src/voxy_agents/api/routes/images.py                        291     52    82%   70, 88, 90, 252, 324-337, 348-352, 386-399, 410-413, 451, 481-482, 497-500, 519-520, 547, 597-598, 660-661, 685, 690, 705, 718, 726-729, 752, 776, 789-790
src/voxy_agents/api/routes/messages.py                      172    144    16%   63-138, 154-309, 322-397, 413-442, 451
src/voxy_agents/api/routes/sessions.py                      129     93    28%   68-77, 92-100, 115-132, 149-168, 183-200, 221-271, 287-380, 389
src/voxy_agents/api/routes/test.py                          101     56    45%   141-216, 239-242, 278-293, 358-393, 426-438
src/voxy_agents/config/__init__.py                            0      0   100%
src/voxy_agents/config/log_filters.py                        20      1    95%   54
src/voxy_agents/config/logger_config.py                      92     12    87%   38-39, 173, 259, 276-284
src/voxy_agents/config/models_config.py                     151     48    68%   61-65, 75, 88-97, 129-142, 184, 220, 262-275, 337-350, 421-440
src/voxy_agents/config/reasoning_config.py                   93     93     0%   11-327
src/voxy_agents/config/settings.py                           51      3    94%   48-55
src/voxy_agents/core/__init__.py                              0      0   100%
src/voxy_agents/core/auth_token_manager.py                  118     85    28%   35-40, 44, 62-104, 116-137, 153, 161, 179-185, 197-214, 226-281, 285-297
src/voxy_agents/core/cache/__init__.py                        2      0   100%
src/voxy_agents/core/cache/redis_cache.py                   122     96    21%   23-24, 28-43, 47-49, 61-73, 89-106, 118-127, 139-146, 163-177, 200-201, 216-217, 233-234, 246-247, 259-260, 276-293, 309-324, 335
src/voxy_agents/core/cache/vision_cache.py                  161     57    65%   122, 126-145, 159-161, 204-207, 216-217, 237-239, 246-247, 256, 272-275, 291, 295, 306-311, 321-331, 335-355, 363, 366, 369-372, 376-379, 391
src/voxy_agents/core/database/__init__.py                     3      0   100%
src/voxy_agents/core/database/models.py                      41      0   100%
src/voxy_agents/core/database/supabase_integration.py       175     83    53%   101-102, 290-322, 338-348, 379-395, 444-445, 466-468, 498, 502-504, 514-594, 604-627, 631-638
src/voxy_agents/core/guardrails/__init__.py                   0      0   100%
src/voxy_agents/core/guardrails/safety_check.py              19     11    42%   37-53
src/voxy_agents/core/optimization/adaptive_reasoning.py     128     37    71%   153-158, 184-187, 192, 200, 207, 209, 214, 220-223, 260-265, 283, 290-291, 302-303, 341-342, 346-371, 379-385
src/voxy_agents/core/optimization/pipeline_optimizer.py     155    109    30%   65, 74-105, 109-136, 141-167, 172-188, 193-237, 249, 253-254, 261, 275-303
src/voxy_agents/core/sessions/__init__.py                     0      0   100%
src/voxy_agents/core/sessions/session_manager.py             76     76     0%   7-258
src/voxy_agents/core/subagents/__init__.py                    6      0   100%
src/voxy_agents/core/subagents/base_agent.py                 65     65     0%   8-182
src/voxy_agents/core/subagents/calculator_agent.py           23      0   100%
src/voxy_agents/core/subagents/corrector_agent.py            23      0   100%
src/voxy_agents/core/subagents/translator_agent.py           23      0   100%
src/voxy_agents/core/subagents/vision_agent.py              186     44    76%   362, 366, 370, 374, 444-451, 466-474, 479-484, 492-498, 502, 504, 532-549, 585-593, 617-629
src/voxy_agents/core/subagents/weather_agent.py              23      0   100%
src/voxy_agents/core/tools/__init__.py                        0      0   100%
src/voxy_agents/core/tools/weather_api.py                    74      0   100%
src/voxy_agents/core/utils/id_generator.py                   19     11    42%   28-44
src/voxy_agents/core/voxy_orchestrator.py                   322    167    48%   145, 199, 345, 350, 355, 373, 377, 451-457, 469-580, 601-652, 692, 700, 731, 756-757, 791-797, 816-817, 829, 850-1007
src/voxy_agents/main.py                                      64      1    98%   214
src/voxy_agents/utils/__init__.py                             0      0   100%
src/voxy_agents/utils/llm_factory.py                         43     20    53%   46, 70-73, 100-107, 134-141, 159-168, 199-200, 210, 239-242
src/voxy_agents/utils/logger_helper.py                       42     42     0%   7-133
src/voxy_agents/utils/reasoning_capture.py                   70     31    56%   58-74, 83, 100-106, 110-111, 119, 125-128, 132-133, 137-138, 152, 157, 162
src/voxy_agents/utils/test_subagents.py                     241     87    64%   156-157, 165-167, 173-175, 183-185, 193-195, 390, 392, 397, 407-409, 481, 508-516, 561-566, 569-575, 578-583, 636-774
src/voxy_agents/utils/universal_reasoning_capture.py        218    142    35%   58, 76, 108, 113, 128, 149-206, 211-227, 242, 260-306, 321-322, 336-380, 395, 413-461, 513-546, 550, 563, 588-589, 594-595, 606-607
---------------------------------------------------------------------------------------
TOTAL                                                      4142   1811    56%
Coverage HTML written to dir htmlcov

FAIL Required test coverage of 85% not reached. Total coverage: 56.28%
=========================== short test summary info ============================
FAILED tests/test_subagent_tester.py::test_translator_pt_to_en - AssertionErr...
FAILED tests/test_subagent_tester.py::test_weather_valid_city - AssertionErro...
FAILED tests/test_subagent_tester.py::test_weather_invalid_city - assert ('n√£...
FAILED tests/test_subagent_tester.py::test_vision_general_analysis - Assertio...
FAILED tests/test_subagent_tester.py::test_vision_missing_image_url - Failed:...
FAILED tests/test_subagent_tester.py::test_get_available_agents - AssertionEr...
FAILED tests/test_subagent_tester.py::test_get_agent_info_translator - Assert...
FAILED tests/test_subagent_tester.py::test_get_agent_info_vision - AssertionE...
FAILED tests/test_subagent_tester.py::test_cost_tracking - AssertionError: as...
FAILED tests/test_vision_flow_corrections.py::TestVisionAgentFlow::test_analyze_image_returns_structured_result
FAILED tests/test_vision_flow_corrections.py::TestVisionAgentFlow::test_analyze_image_error_handling
FAILED tests/test_vision_flow_corrections.py::TestToolsUsedMetadata::test_path_1_tools_used
FAILED tests/test_voxy_agents/test_api/test_routes/test_auth.py::TestAuthRoutes::test_login_success
FAILED tests/test_voxy_agents/test_api/test_routes/test_auth.py::TestAuthRoutes::test_signup_success
FAILED tests/test_voxy_agents/test_api/test_routes/test_auth.py::TestJWTValidation::test_valid_token_verification
FAILED tests/test_voxy_agents/test_api/test_routes/test_auth.py::TestJWTValidation::test_expired_token_verification
FAILED tests/test_voxy_agents/test_api/test_routes/test_auth.py::TestJWTValidation::test_invalid_token_verification
FAILED tests/test_voxy_agents/test_api/test_routes/test_auth.py::TestJWTValidation::test_missing_token_header
FAILED tests/test_voxy_agents/test_api/test_routes/test_auth.py::TestJWTValidation::test_malformed_auth_header
FAILED tests/test_voxy_agents/test_api/test_routes/test_images.py::TestImageUploadEndpoint::test_upload_image_success
FAILED tests/test_voxy_agents/test_api/test_routes/test_images.py::TestImageUploadEndpoint::test_upload_image_storage_failure
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_chat_basic_flow
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_chat_with_session_id
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_chat_error_handling
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_setup_voxy_agent
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_voxy_agent_initialization_multiple_calls
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_web_search_tool_execution
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_chat_response_list_handling
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_chat_response_non_string_handling
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_chat_single_tool_agent_type_mapping
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_chat_multiple_tools_agent_type
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_chat_no_tools_used
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_chat_result_without_tool_calls_attribute
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_vision_bypass_integration
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_determine_analysis_type
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_determine_detail_level
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_vision_bypass_not_triggered_without_image
FAILED tests/test_voxy_agents/test_core/test_voxy_orchestrator.py::TestVoxyOrchestrator::test_vision_bypass_not_triggered_for_non_vision_with_image
FAILED tests/test_voxy_agents/test_main.py::TestVOXYSystem::test_chat_success
=========== 39 failed, 258 passed, 56 warnings in 136.67s (0:02:16) ============
